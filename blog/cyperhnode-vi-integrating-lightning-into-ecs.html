<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Cyphernode VI integrating Lightning into ECS - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/cyperhnode-vi-integrating-lightning-into-ecs.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/cyperhnode-vi-integrating-lightning-into-ecs.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Cyphernode VI integrating Lightning into ECS"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/31/haik-ourfal-M4biGF0pN5s-unsplash.jpg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/cyperhnode-vi-integrating-lightning-into-ecs.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/cyperhnode-vi-integrating-lightning-into-ecs.html"},"headline":"Cyphernode VI integrating Lightning into ECS","datePublished":"2019-11-27T20:46","dateModified":"2019-12-19T01:44","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/31/haik-ourfal-M4biGF0pN5s-unsplash.jpg","height":5184,"width":3456},"description":"IntrodcutionThis guide aims to program a website to accept Bitcoin. In the previous tutorial, we started to play with \"Lightning\" support. This time we are going to integrate \"Lightning\" support via \"cyphernode\" into \"ECS\". We broke the code down into two sections which can be found in the&hellip;","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2020-05-06T17:25">May 6, 2020</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><div class="banner banner--before-post"><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT START</h2><p>Only joking, but not. We want your Bitcoin, any amount will do.  We like Bitcoin and want more of it, so please give it to us.  Click the button below to donate.</p><p><a href="#0" id="sr-add-to-cart" cart-type="2" class="sr-add-to-cart add-to-cart btn btn-primary" data-price="0.01" data-name="Entity T" data-preview="" style="color: #000;">Donate</a> </p><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT END</h2></div><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(5184/3456 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-xs.jpg" data-srcset="https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-xs.jpg 300w ,https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-sm.jpg 480w ,https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-md.jpg 768w ,https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-lg.jpg 1024w ,https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-xl.jpg 1360w ,https://cryptoskillz.com/blog/media/posts/31/responsive/haik-ourfal-M4biGF0pN5s-unsplash-2xl.jpg 1600w" data-sizes="auto" alt=""><figcaption>Photo by haik ourfal on Unsplash</figcaption></figure><header class="u-header post__header"><h1>Cyphernode VI integrating Lightning into ECS</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2019-11-27T20:46">November 27, 2019 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><h2>Introdcution</h2><p><span data-preserver-spaces="true">This guide aims to program a website to accept Bitcoin. In the previous tutorial, we started to play with "<strong><a href="https://en.wikipedia.org/wiki/Lightning_Network" target="_blank" rel="noopener noreferrer">Lightning</a>"</strong> support. This time we are going to integrate "</span><a target="_blank" href="https://en.wikipedia.org/wiki/Lightning_Network" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">Lightning</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> support via "</span><a target="_blank" href="https://cyphernode.io/" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">cyphernode</span></strong></a><strong><span data-preserver-spaces="true">" </span></strong><span data-preserver-spaces="true">into</span><strong><span data-preserver-spaces="true"> "</span></strong><a target="_blank" href="https://github.com/cryptoskillz/ECS" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">ECS</span></strong></a><strong><span data-preserver-spaces="true">".</span></strong></p><h2>The Code </h2><p><span data-preserver-spaces="true">We broke the code down into two sections which can be found in the following "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/tree/cyphernode-lightning" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">branch</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true">. The first section deals with how we can interface with the "</span><a target="_blank" href="https://cyphernode.io/" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">cyphernode</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> proxy and is contained in the file called "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/server/tests/jwt.js" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">jwt.js</span></strong></a><strong><span data-preserver-spaces="true">" </span></strong><span data-preserver-spaces="true">we have put this in an isolated file as it shows how the code works without having the added complexity of "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">ECS</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> in the mix. The second section shows the changes we made to "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">ECS</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> to integrate "<strong><a href="https://en.wikipedia.org/wiki/Lightning_Network" target="_blank" rel="noopener noreferrer">Lightning</a>"</strong> support. </span></p><p><span data-preserver-spaces="true">It is worth noting that we have quite tightly integrated cyphernode into the core of "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">ECS</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true">. This in itself is not a bad thing but we want to make "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">ECS</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> as agnostic as we possibly and as a result, we will be looking to decouple it somewhat in the future. </span></p><p><span style="font-family: -apple-system, BlinkMacSystemFont, Arial, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: calc(1.26562rem + (0.1582 * ((100vw - 20rem) / 80))); font-weight: 600; letter-spacing: -0.03rem;">JWT Code</span></p><p>To integrate into "<strong><a href="https://github.com/cryptoskillz/ECS" target="_blank" rel="noopener noreferrer">ECS</a>"</strong> we are going to modify a lot of the code but lets first talk a little about how the gatekeeper works and how to access it. If we take a look at the "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> API docs "<strong><a href="https://github.com/SatoshiPortal/cyphernode/tree/master/doc" target="_blank" rel="noopener noreferrer">here</a>" </strong>you will see the following example of how to use the gatekeeper to access the underlying functions of "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>" </strong></p><div class="highlight highlight-source-shell"><pre>id=<span class="pl-s"><span class="pl-pds">"</span>003<span class="pl-pds">"</span></span><span class="pl-k">;</span>h64=<span class="pl-s"><span class="pl-pds">$(</span>echo -n <span class="pl-pds">"</span>{<span class="pl-cce">\"</span>alg<span class="pl-cce">\"</span>:<span class="pl-cce">\"</span>HS256<span class="pl-cce">\"</span>,<span class="pl-cce">\"</span>typ<span class="pl-cce">\"</span>:<span class="pl-cce">\"</span>JWT<span class="pl-cce">\"</span>}<span class="pl-pds">"</span> <span class="pl-k">|</span> base64<span class="pl-pds">)</span></span><span class="pl-k">;</span>p64=<span class="pl-s"><span class="pl-pds">$(</span>echo -n <span class="pl-pds">"</span>{<span class="pl-cce">\"</span>id<span class="pl-cce">\"</span>:<span class="pl-cce">\"</span><span class="pl-smi">$id</span><span class="pl-cce">\"</span>,<span class="pl-cce">\"</span>exp<span class="pl-cce">\"</span>:<span class="pl-pds">$((</span>`date <span class="pl-k">+</span>"<span class="pl-k">%</span>s"`<span class="pl-k">+</span><span class="pl-c1">10</span><span class="pl-pds">))</span>}<span class="pl-pds">"</span> <span class="pl-k">|</span> base64<span class="pl-pds">)</span></span><span class="pl-k">;</span>k=<span class="pl-s"><span class="pl-pds">"</span>b9b8d527a1a27af2ad1697db3521f883760c342fc386dbc42c4efbb1a4d5e0af<span class="pl-pds">"</span></span><span class="pl-k">;</span>s=<span class="pl-s"><span class="pl-pds">$(</span>echo -n <span class="pl-pds">"</span><span class="pl-smi">$h64</span>.<span class="pl-smi">$p64</span><span class="pl-pds">"</span> <span class="pl-k">|</span> openssl dgst -hmac <span class="pl-pds">"</span><span class="pl-smi">$k</span><span class="pl-pds">"</span> -sha256 -r <span class="pl-k">|</span> cut -sd <span class="pl-pds">'</span> <span class="pl-pds">'</span> -f1<span class="pl-pds">)</span></span><span class="pl-k">;</span>token=<span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$h64</span>.<span class="pl-smi">$p64</span>.<span class="pl-smi">$s</span><span class="pl-pds">"</span></span><span class="pl-k">;</span>curl -v -H <span class="pl-s"><span class="pl-pds">"</span>Content-Type: application/json<span class="pl-pds">"</span></span> -d <span class="pl-s"><span class="pl-pds">'</span>{"hash":"123","callbackUrl":"http://callback"}<span class="pl-pds">'</span></span> -H <span class="pl-s"><span class="pl-pds">"</span>Authorization: Bearer <span class="pl-smi">$token</span><span class="pl-pds">"</span></span> -k https://127.0.0.1:2009/v0/ots_stamp</pre></div><p>Wow, ok if we paste the in it works but how on earth do we use this in code. Let us start by doing what developers do and break this down and reverse engineer it. It is doing the following<br><br>1) creating an algorithm type of "<strong><a href="https://en.wikipedia.org/wiki/JSON">JSON</a>"</strong> object and storing it in a var called h64<br>2) creating a payload "<strong><a href="https://en.wikipedia.org/wiki/JSON" target="_blank" rel="noopener noreferrer">JSON</a>"</strong> object with ID and an expiry date in it and storing this in P64<br>3) setting the "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> API key as the secret and storing it in a variable called k<br>4) creating an SH256 has from the above and storing it in a var called s<br>5) joining the h64,p64 and s vars together to create a "<strong><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JWT token</a>"</strong><br>6) sending this to "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> proxy for processing</p><p><br>Ok, now we know what it is doing let us see if we can break it down and move into a test file and see if we can recreate the functionality in code.</p><p><br>The first thing we have to do is include the files that are important to us, in this case, it is "<strong><a href="https://www.npmjs.com/package/dotenv" target="_blank" rel="noopener noreferrer">dontenv</a>"</strong> to store access to our env vars, the "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> API key and "<strong><a href="https://www.npmjs.com/package/crypto-js">crypto js</a>"</strong> to create a hash for our "<strong><a href="https://jwt.io/">JWT token</a>"</strong>.</p><p><code>//load dotenv to get accces to the vars in .env                </code><br><code>require('dotenv').config();                                    </code><br><code>//load request                                                 </code><br><code>//console.log(process.env.CYPHERNODE_API_KEY)                  </code><br><code>const request = require('request');                            </code><br><code>//load crytpo js                                               </code><br><code>const cryptojs = require("crypto-js");                          <br><br></code></p><p>Next, we require a couple of new ENV vars the first is for the "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> API key which can be found in your "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> installation in the following location cyphernode/gatekeeper/keys.properties.<br><br>Next, we require the URL of the "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> server which should be the below (unless you have deviated for the tutorial in which case shame on you).<br><br>Finally, we have to disable the SSL errors so we can test without having SSL configured. Of course, if we were to use this in a production environment then we would not have this disabled and in fact, we will deal with this in the next article.</p><p>These are the ENV vars we added.</p><p><code>CYPHERNODE_API_KEY=''                                          </code><br><code>CYPHER_GATEWAY_URL=https://127.0.0.1:2009/v0/                  </code><br><code>NODE_TLS_REJECT_UNAUTHORIZED=0                                 </code></p><p>Next, we have to build a "<strong><a href="https://jwt.io/">JWT token</a>"</strong> and we do this as follows:</p><p><code>id = "003";<br>//set the expiry time to a point in the future<br>exp = Math.round(new Date().getTime() / 1000) + expiryInSeconds;<br>//set the algo type we are going to use and base 64 it           <br>h64 = Buffer.from(JSON.stringify({                               <br>alg: "HS256",                                                    <br>typ: "JWT"                                                       <br>})).toString("base64");                                          <br>//set the payload and set it to h64                              <br>p64 = Buffer.from(JSON.stringify({                               <br>id: id,                                                          <br>exp: exp                                                         <br>})).toString("base64");                                          <br>//join them together                                             <br>msg = h64 + "." + p64;                                           <br>//get a sha256 has or the h64,p64 and the API key (which is the  secret in JWT world)                                             <br>const hash = cryptojs.HmacSHA256(msg, api_key);                  <br>//create the JWT token                                           <br>const token = h64 + "." + p64 + "." + hash                       <br>//output it                                                      <br>console.log("token - " + token);require('dotenv').config();       </code></p><p>Next, we have to make a call to the gatekeeper</p><p><code>//set the menthod we want to call                              </code><br><code>const method = "ln_getinfo";                                   </code><br><code>//set the body we want to send, this is not required for every  method call but it does no harm to send it                      </code><br><code>const body = '{"hash":"123","callbackUrl":"http://callback"}'; </code><br><code>//create the Bearer header                                     </code><br><code>const authheaader = "Bearer " + token;                         </code><br><code>const options = {                                              </code><br><code>url: cyphernodeurl + method,                                   </code><br><code>headers: {                                                     </code><br><code>'Authorization': authheaader                                   </code><br><code>},                                                             </code><br><code>body: body                                                     </code><br><code>};                                                             </code><br><code>//create the call back                                         </code><br><code>function callback(error, response, body) {                     </code><br><code>if (!error &amp;&amp; response.statusCode == 200) {                    </code><br><code>const info = JSON.parse(body);                                 </code><br><code>//do stuff with the result                                     </code><br><code>console.log(body);                                             </code><br><code>} else {                                                       </code><br><code>//you done messed up boi                                       </code><br><code>console.log(body)                                              </code><br><code>console.log(error)                                             </code><br><code>}                                                              </code><br><code>}                                                              </code><br><code>//make the calls                                               </code><br><code>request.post(options, callback);                               </code></p><figure class="post__image">now if we run this from the terminal we will get the following output:<br><br><img style="font-family: -apple-system, BlinkMacSystemFont, Arial, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: inherit;" src="https://cryptoskillz.com/blog/media/posts/31/civ1.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-xs.png 300w, https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-sm.png 480w, https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-md.png 768w, https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-lg.png 1024w, https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-xl.png 1360w, https://cryptoskillz.com/blog/media/posts/31/responsive/civ1-2xl.png 1600w" alt="" width="2379" height="817"></figure><p><span data-preserver-spaces="true">Great, we can now call our "<strong><a href="https://cyphernode.io/" target="_blank" rel="noopener noreferrer">cyphernode</a>"</strong> via the gatekeeper and get a response. You can find this file "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/server/tests/jwt.js" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">here</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> if you would like to play with it. </span></p><h3>ECS Integration</h3><p>As with previous tutorials, we stopped listing "<strong><a href="https://github.com/cryptoskillz/ECS" target="_blank" rel="noopener noreferrer">ECS</a>"</strong> in its entirety some time ago and instead just list the core changes and the reason why we did what we did.</p><h4>init function</h4><p>We added a parameter to turn lightning on or off<br><br><code>Server vars you can pass set to "" to ignore                    <br>0 = server url                                                   <br>1 = quantity                                                     <br>2 = cdn url                                                      <br>3 = uid                                                          <br>4 = shipping address                                             <br>5 = start country                                                <br>6 = serverless                                                   <br>7 = serverless btc address                                       <br>8 = lightning support   </code><code>                                                                                                         <br>SR.init(["http://127.0.0.1:3030/",15,"http://127.0.0.1:8080/demos/carts/default/","3",1,"GB",0,"",1]);                           </code></p><h4>Cart / sr.js</h4><p><span style="font-family: -apple-system, BlinkMacSystemFont, Arial, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: inherit;"><span data-preserver-spaces="true">We added a toggle to the cart to allow us to toggle between "<strong><a href="https://en.wikipedia.org/wiki/Lightning_Network" target="_blank" rel="noopener noreferrer">lightning</a>"</strong> and BTC mode as shown in the screenshots below. We also added a bunch of small changes liking hiding the address, adding an icon, etc. You can view all the changes we made by looking at the commit "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/commits/cyphernode-lightning" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">history</span></strong></a><strong><span data-preserver-spaces="true">".</span></strong></span></p><p><span data-preserver-spaces="true">Note, if you are running it in serverless mode then you will not be able to use "<strong><a href="https://en.wikipedia.org/wiki/Lightning_Network" target="_blank" rel="noopener noreferrer">Lightning</a>"</strong> as it has to generate an invoice. There are ways to deal with this using watch towers etc which we will deal with in a later tutorial but for now, this is the way it is. </span></p><p><span data-preserver-spaces="true">All of the logic to deal with this was added to the "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/tree/cyphernode-lightning/cdn" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">CDN</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> ("</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/cdn/js/sr.js" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">sr.js</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true">) </span></p><h4>demos</h4><p>We added a new demo to the demo directory to deal with LIghtning which can you can view "<strong><a href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/demos/carts/default/6-cart-customer-address-lightning.html" target="_blank" rel="noopener noreferrer">here</a>"</strong>.</p><h4>.ENV</h4><p><span data-preserver-spaces="true">We added a few new parameters to the .ENV file (note these are the same as in "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/server/tests/jwt.js" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">jwt.js</span></strong></a><strong><span data-preserver-spaces="true">" </span></strong><span data-preserver-spaces="true">from earlier)</span></p><p><code>CYPHERNODE_API_KEY=                                            </code><br><code>CYPHER_GATEWAY_URL=https://localhost:2009/v0/                  </code><br><code>NODE_TLS_REJECT_UNAUTHORIZED=0                                 </code></p><p>CYPHERNODE_API_KEY, the value for this API key can be found in the following file </p><p><code>/cyphernode/gatekepper/keys.properties                         </code></p><p>Open this and copy the API that is next to kapi_id="003";kapi_key="APIKEY"<br>Note, it is important to keep this API key safe as it allows full access to cyphernode. Also, we used 003 as we were too lazy to see the permission level of each but it is highly likely you may only need the 001 API key. We will deal with this when we move it to production in the next tutorial.<br><br>CYPHER_GATEWAY_URL, this is the proxy URL for cyphernode.<br><br>NODE_TLS_REJECT_UNAUTHORIZED=0, this is to disable SSL and yes this is a hack but we were struggling to get the docker images working with let's encrypt. We will deal with this for sure in the next tutorial.</p><h4>Server</h4><p>We added a couple of new functions to the server. </p><p><strong>/api/lightningaddress</strong></p><p><span data-preserver-spaces="true">This calls a function called generateLightningAddress which generates a lightning address :]. This function is the same as the one in JWT more or less so I will not paste the whole thing again but you can see it "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/server/api/helpers/api.js#L258" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">here</span></strong></a><strong><span data-preserver-spaces="true">" </span></strong><span data-preserver-spaces="true">if you want to have a look at it in more detail.</span></p><p><strong>/webhook/checklightningpayment</strong></p><p><span data-preserver-spaces="true">again this function is very similar to the JWT example except it checks a lightning label to check if a payment has been made and update the database according. You can view the code "</span><a target="_blank" href="https://github.com/cryptoskillz/ECS/blob/cyphernode-lightning/server/api/helpers/webhook.js#L36" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">here</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true">. </span> </p><h3>SQL</h3><p>We made one small change to the sessions table to be able to deal with a "<strong><a href="https://en.wikipedia.org/wiki/Lightning_Network" target="_blank" rel="noopener noreferrer">Lightning</a>"</strong> payment</p><p><code>CREATE TABLE "sessions" (                                        `id` INTEGER PRIMARY KEY AUTOINCREMENT,                          <br>`address` TEXT, `processed` INTEGER DEFAULT 0,                   `swept` INTEGER DEFAULT 0,                                      <br>`userid` INTEGER,                                                <br>`net` INTEGER DEFAULT 1,                                         <br>`amount` TEXT DEFAULT 0,                                         <br>`addresstype` INTEGER DEFAULT 0,                                 <br>`sessioncountcheck` INTEGER DEFAULT 0,                           <br>`carttype` INTEGER DEFAULT 1,                                    <br>`lightningaddress` TEXT,                                         <br>`lightninglabel` TEXT )                                          <br></code> </p><h2>Conculsion</h2><p><span data-preserver-spaces="true">In this tutorial, we broke down exactly how to access cyphernode via gatekeeper and integrated it into "<strong><a href="https://github.com/cryptoskillz/ECS" target="_blank" rel="noopener noreferrer">ECS</a>"</strong>. However, there is an excellent class called "</span><a target="_blank" href="https://github.com/gabidi/cyphernode-js-sdk" class="_e75a791d-denali-editor-page-rtfLink" rel="noopener noreferrer"><strong><span data-preserver-spaces="true">cyphernode.sdk</span></strong></a><strong><span data-preserver-spaces="true">"</span></strong><span data-preserver-spaces="true"> that we will use next time to make things cleaner. We will also install an SSL certificate, deal with "<strong><a href="https://blockonomi.com/lightning-network-inbound-capacity/" target="_blank" rel="noopener noreferrer">inbound capacity</a>"</strong> issues and host the whole thing on "<strong><a href="https://www.digitalocean.com/" target="_blank" rel="noopener noreferrer">digital ocean</a>"</strong>. </span></p><p> </p><p> </p><p> </p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on December 19, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-8-cyphernode-v.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/30/responsive/light-xs.png" data-srcset="https://cryptoskillz.com/blog/media/posts/30/responsive/light-xs.png" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Cyphernode V figuring out Lightning</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/btc-full-nodes-with-raspberry-pi.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>BTC Full nodes with Raspberry PI part 1</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/32/responsive/stefan-cosma-f3Yk7gW6chM-unsplash-xs.jpg" data-srcset="https://cryptoskillz.com/blog/media/posts/32/responsive/stefan-cosma-f3Yk7gW6chM-unsplash-xs.jpg" data-expand="300" alt=""></a></div></nav></footer></article><div class="banner banner--after-post"><script type="text/javascript" src="https://cryptoskillz.com/srcrypto/prod/cdn/js/sr.js"></script><script type="text/javascript">SR.init(["https://ecslive.cryptoskillz.com/",15,"https://cryptoskillz.com/srcrypto/prod/cdn/theme/","39",0,"GB",0,""]);</script></div></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(6)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(27)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(11)</span></li><li><a href="https://cryptoskillz.com/blog/raspberry-pi/">raspberry pi</a> <span class="u-small">(1)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>