<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Backoffice and server refactor - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/backoffice-and-server-refactor.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/backoffice-and-server-refactor.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Backoffice and server refactor"><meta property="og:image" content="https://cryptoskillz.com/blog/media/website/logo.png"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/backoffice-and-server-refactor.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=58acac63961d23abccded091eaca6989"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/backoffice-and-server-refactor.html"},"headline":"Backoffice and server refactor","datePublished":"2018-11-09T12:22","dateModified":"2019-09-20T12:23","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685},"description":"<figure class=\"post__image post__image\" ><img src=\"https://cryptoskillz.com/blog/media/posts/14/1_sO7jBrNOVBwbvvfbdkvetg.jpeg\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-2xl.jpeg 1600w\"  alt=\"\" width=\"3061\" height=\"4592\">\n<figcaption >\n<figure class=\"ke kf kg kh ki fr x y paragraph-image\">\n<figcaption class=\"az dz kx ky hh dn x y kz la au dx\" data-selectable-paragraph=\"\">Photo by <a href=\"https://unsplash.com/photos/ypZIfpMpyIs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText\" class=\"cb bx lb lc ld le\" target=\"_blank\" rel=\"noopener noreferrer\">Daniel Chen</a> on <a href=\"https://unsplash.com/search/photos/server?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText\" class=\"cb bx lb lc ld le\" target=\"_blank\" rel=\"noopener noreferrer\">Unsplash</a></figcaption>\n</figure>\n</figcaption>\n</figure>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz","logo":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685}}}</script><script src="https://cryptoskillz.com/blog/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://cryptoskillz.com/blog/"><img src="https://cryptoskillz.com/blog/media/website/logo.png" alt="cryptoskillz"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li><li class="has-submenu"><a href="https://cryptoskillz.com/blog/ecs/" target="_self" aria-haspopup="true">BLOG</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://cryptoskillz.com/blog/ecs/" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blog/fullnode/" target="_self">FULLNODE</a></li><li><a href="https://cryptoskillz.com/blog/cyphernode/" target="_self">CYPHERNODE</a></li><li><a href="https://cryptoskillz.com/blog/trx/" target="_self">TRX</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2018-11-09T12:22">November 9, 2018</time></div><h1>Backoffice and server refactor</h1></div></header></div><div class="wrapper post__entry"><figure class="post__image post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/14/1_sO7jBrNOVBwbvvfbdkvetg.jpeg" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-2xl.jpeg 1600w" alt="" data-aspectratio="0.666594" width="3061" height="4592"><figcaption><figure class="ke kf kg kh ki fr x y paragraph-image"><figcaption class="az dz kx ky hh dn x y kz la au dx" data-selectable-paragraph="">Photo by <a href="https://unsplash.com/photos/ypZIfpMpyIs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Daniel Chen</a> on <a href="https://unsplash.com/search/photos/server?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Unsplash</a></figcaption></figure></figcaption></figure><h1 id="806c" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Introduction</h1><p id="9c84" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the last tutorial ("<a class="cb bx lb lc ld le" target="_blank" href="https://medium.com/bitcoin-e-commerce-development/part-11-refactor-of-cold-storage-2c9d455f0b57" rel="noopener noreferrer"><strong class="lu mg"><a href="https://cryptoskillz.com/blog/refactor-of-cold-storage.html" target="_blank" rel="noopener noreferrer">part 11</a>"</strong></a>), we re-coded the way we generated and stored or cold storage generated addresses. In this part, we are going to put in place the framework to deal with the back office functionality (sending emails for example). This involves a decent refactor of the "<strong><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/part12-backoffice/server" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">server</a></strong>" component of the tutorial.</p><p id="4b4e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Also from this part onwards, we will not be listing the code in its entirety, mainly because a lot of work will be small bug fixes and refactoring of pieces of code that we clearly covered in previous tutorials. Instead, we will offer top-level explanations of the changes and deep dive new code and concepts that we have implemented.</p><h1 id="fc01" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The SQL</h1><p id="ad6c" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We finally got around to renaming the horribly names <strong class="lu mg">keys</strong> table to something that makes sense, we renamed it to <strong class="lu mg">sessions.</strong></p><p id="c1e2" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We also added a new table called <strong class="lu mg">emailtemplates</strong> to handle the various emails that the system will be sending out.</p><pre class="ke kf kg kh ki dv ge df"><span id="d9ed" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">CREATE TABLE "emailtemplates" <br>( <br>`id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `name` TEXT,<br> `subject` TEXT,<br> `body` TEXT,<br> `fromname` TEXT,<br> `fromemail` TEXT,<br> `active` INTEGER DEFAULT 1 <br>)</span></pre><h1 id="44cd" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The Code</h1><p id="e53f" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">As previously stated all the code we did this time is in the "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/part12-backoffice/server" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">server</strong></a>" section and involved a decent refactor. The reason for this refactoring was, simply "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part12-backoffice/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">app.js</strong></a>" was getting very large and doing multiple things that were technically outside its purview. We changed it to simply handle "<a href="https://expressjs.com/en/guide/routing.html" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">routing</strong></a><strong class="lu mg">"</strong>and the logic for these routes has been moved to 4 helpers, one for each major endpoint and a generic one for reusable code such as the send email function.</p><p id="46d4" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Note, we have kept the code as simple and uniform as possible and refrained from using some of the more complex methodologies such as "<a href="https://caolan.github.io/async/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">async</strong></a>" and "<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">await</strong></a>" and such to make the code as accessible as possible.</p><h2 id="716b" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part12-backoffice/server/api/helpers/admin.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">admin helper</a></h2><p id="efc3" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This helper contains all of the admin functions. They are functions required for the "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/part12-backoffice/admin" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">admin control panel</strong></a><strong class="lu mg">"</strong> to work.</p><h2 id="3201" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part12-backoffice/server/api/helpers/api.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">api helper</a></h2><p id="7184" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This helper contains all of the API functions that are required for the "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/part12-backoffice/cdn" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">CDN</strong></a><strong class="lu mg">"</strong>to work.</p><h2 id="1c5b" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part12-backoffice/server/api/helpers/backoffice.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="ch">backoffice helper</strong></a></h2><p id="1a6b" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This helper will contain the back office functions such as payment monitor. These are functions that rather wait on user input as generally ran on a timer.</p><h2 id="4e5d" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part12-backoffice/server/api/helpers/generic.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">generic helper</a></h2><p id="8391" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This helper holds all of the generic functions that the rest of the code base uses such as sending emails.</p><h1 id="7983" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Regression Testing</h1><p id="4b21" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">As we were refactoring this code we noticed (and fixed) a number of bugs. This lead to believe it was time for some (simple) "<a href="https://en.wikipedia.org/wiki/Regression_testing" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">regression testing</strong></a><strong class="lu mg">"</strong>.</p><p id="0f24" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">There are many ways to do this including "<a href="https://en.wikipedia.org/wiki/Unit_testing" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">unit tests</strong></a>", "<a href="https://en.wikipedia.org/wiki/Headless_browser" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">headless browsers</strong></a>" and "<a href="https://en.wikipedia.org/wiki/Static_program_analysis" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">static code analysis</strong></a>". We may look into these in the future but for now simply running through them and putting a tick in a column on a spreadsheet is good enough. Included is a simple regression testing spreadsheet which you can find "<a href="https://docs.google.com/spreadsheets/d/16At_yMqD04qc3gtWFZCK12WvCCCXm6kTCo3ebrlGJfI/edit?usp=sharing" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">here</strong></a>".</p><p id="a835" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The video below shows a full regression test.</p><figure class="ke kf kg kh ki fr"><div class="kq l ds"><div class="nc l"><div class="post__iframe"><iframe class="lazyload" width="854" height="480" data-src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2F4eQqGA_l41M%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D4eQqGA_l41M&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2F4eQqGA_l41M%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube" frameborder="0" title="Part 12: Backoffice and server refactor" class="du n o kn ab" scrolling="auto" data-mce-fragment="1"></iframe></div></div></div></figure><h1 id="29d0" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Conclusion</h1><p id="9a48" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">So there we are, nice little update, bugs were fixed, the code was refactored and we have a fully regressed application.</p><p id="6c91" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next time we will work on the CDN part and add real-time notifications as well as the ability pass in additional view to the cart (shipping/billing address etc) and store them in a way in the database that requires no more work in the future (maybe)</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 20, 2019</p><ul class="post__tag"><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a></li></ul><div class="post__share"><a href="https://twitter.com/share?url=https%3A%2F%2Fcryptoskillz.com%2Fblog%2Fbackoffice-and-server-refactor.html&amp;via=crypto_skillz&amp;text=Backoffice%20and%20server%20refactor" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span></a></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://cryptoskillz.com/blog/refactor-of-cold-storage.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Refactor of cold storage</a></div><div class="post__nav-next"><a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-3.html" class="invert post__nav-link" rel="next"><span>Next</span> Working with Fullnodes part 3 </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://cryptoskillz.com/blog/backoffice-and-server-refactor.html';
               		this.page.identifier = '14';
                       this.page.title = ' Backoffice and server refactor';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://cryptoskillz-1.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__social"><a href="crypto_skillz" aria-label="Twitter"><svg><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg></a></div><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static CMS</a></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'overlay',
        animationSpeed: 300,
        submenuWidth: 240,
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>