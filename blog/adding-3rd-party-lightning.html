<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Adding 3rd party Lightning - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/adding-3rd-party-lightning.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/adding-3rd-party-lightning.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Adding 3rd party Lightning"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/17/1_o-phpGJ9Fmh13YqxCs8y3A-xs.jpeg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/adding-3rd-party-lightning.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/adding-3rd-party-lightning.html"},"headline":"Adding 3rd party Lightning","datePublished":"2018-12-27T12:27","dateModified":"2019-10-10T23:49","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/17/1_o-phpGJ9Fmh13YqxCs8y3A-xs.jpeg","height":450,"width":300},"description":"<h1 id=\"4570\" class=\"lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt\" data-selectable-paragraph=\"\">Introduction</h1>\n<p id=\"ad64\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">This guide aims to program a website to accept Bitcoin. In the previous tutorial, We removed \"<a href=\"https://globee.com/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">Globee</strong></a><strong class=\"lw mi\">\"</strong> so that we had 100% sovereignty over our code and by extension our money. Ironically we are going to add \"<a href=\"https://strike.acinq.co/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">strike</strong></a>\" which is a 3rd party lightning payment provider. Just as we did in the past we will start the easy way and then remove it and replace it with our own code at a later date.</p>\n<p id=\"3243\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">A quick note on the current lightning nodes. I played with \"<a href=\"https://github.com/lightningnetwork/lnd\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">LND</strong></a><strong class=\"lw mi\">\"</strong> and \"<a href=\"https://github.com/ElementsProject/lightning\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">c-lightning</strong></a>\" for a couple of weeks and could not get them to work to a satisfactory level to fulfil our needs \"<a href=\"https://github.com/lightningnetwork/lnd\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">LND</strong></a><strong class=\"lw mi\">\"</strong> required everything to be on the one server which meant our idea of injecting was just not practical and \"<a href=\"https://github.com/ElementsProject/lightning\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">c-lightning</strong></a> leaned too heavily on the \"<a href=\"https://github.com/ElementsProject/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">elements</strong></a>\" project for us to use it a standalone manner. However, this does not concern me as it is amazing software that is still in Alpha.</p>\n<h1 id=\"6a9e\" class=\"lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt\" data-selectable-paragraph=\"\">The SQL</h1>\n<p id=\"2dc8\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">We made significant changes to the SQL (it was due) mainly to give the tables names that made sense.</p>\n<h2 id=\"c623\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">ECS_ tables</h2>\n<p id=\"a911\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">A number of tables to have the ECS_ prefix this means they are core tables to ECS such as user &amp; user settings</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"be05\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">ecs_coldstorageaddresses<br>ecs_emailtemplates<br>ecs_user<br>ecs_user_settings</span></pre>\n<h2 id=\"964f\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">lookup_ tables</h2>\n<p id=\"ccb2\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">the prefix lookup_ was introduced as a way to standardise the lookup data we will use in ECS.</p>\n<p id=\"db12\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\"><strong class=\"lw mi\">lookup_payment_providers<br></strong>This table is used to hold the payment providers at the moment we have \"Bitcoin Core Node\" and \"strike\" but we may add more in the future.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"110b\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">CREATE TABLE `lookup_payment_providers` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `providername` INTEGER,<br> `external` INTEGER DEFAULT 0<br>);</span></pre>\n<h2 id=\"53db\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">order_ tables</h2>\n<p id=\"cfb9\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">The tables with the order_ prefix are tables that relate directly to the order</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"7af6\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">order_meta<br>order_payment_details<br>order_product<br>order_product_meta</span><span id=\"e010\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">The product meta holds information about the product such as size</span><span id=\"c3eb\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">CREATE TABLE `order_product_meta` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `productid` INTEGER,<br> `metaname` TEXT,<br> `metavalue` TEXT<br>);</span><span id=\"10d1\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">The payment details table holds which method we used to process payment as well as any charge / return objects that the provided us. </span><span id=\"9742\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">CREATE TABLE `order_payment_details` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `address` TEXT,<br> `providerid` INTEGER,<br> `paymentobject` TEXT,<br> `paymentresponseobject` TEXT<br>);</span></pre>\n<h1 id=\"3ebe\" class=\"lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt\" data-selectable-paragraph=\"\">Strike</h1>\n<p id=\"fdc7\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">\"<a href=\"https://strike.acinq.co/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">Strike</strong></a>\" is an excellent lightning implementation who have taken a lot of the heavy lifting away from us. Simply create an account and then get the api from the settings / API KEYS section as shown below.</p>\n<figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/17/1_4TPapRENaXVGKwh-7Bcaeg.png\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-2xl.png 1600w\"  alt=\"\" width=\"1372\" height=\"811\"></figure>\n<p id=\"d14a\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">add this api key to the .env file along with the endpoint</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"14bb\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">mainnet</span><span id=\"db30\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">STRIKEENDPOINT=<a href=\"https://api.strike.acinq.co/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://api.strike.acinq.co</a><br>STRIKEAPIKEY=sk_dsdsdsdsd</span><span id=\"2aa6\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">testnet</span><span id=\"c96e\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">STRIKEENDPOINT=<a href=\"https://api.strike.acinq.co/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://api.dev.strike.acinq.co</a><br>STRIKEAPIKEY=sk_dsdsdsdsd</span></pre>\n<h1 id=\"dca5\" class=\"lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt\" data-selectable-paragraph=\"\">The Code</h1>\n<p id=\"9b58\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">In this tutorial, we have not integrated with SR.js as it was a brand new UX flow we wanted to get it working standalone first and integrate it later. You can find the code for this branch \"<a href=\"https://github.com/cryptoskillz/ECS/tree/strike\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\"><strong class=\"lw mi\">here</strong></a><strong class=\"lw mi\">\"</strong></p>\n<h2 id=\"8893\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">HTML</h2>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"68f3\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;div id=\"order-preload\" align=\"center\"&gt;<br>    &lt;div &gt;Generating Invoice...&lt;/div&gt;<br>    &lt;div class=\"lds-dual-ring\"&gt;&lt;/div&gt;<br>&lt;/div&gt;<br>&lt;div class=\"order-qrcode\" id=\"order-qrcode\" style=\"display: none\"&gt;<br>  &lt;div id=\"order-details\"&gt;<br>    &lt;div  align=\"center\"&gt;<br>      &lt;div class=\"order-pr--number\" id=\"order-id\"&gt;&lt;/div&gt;<br>      &lt;span class=\"order-pr--pay\" id=\"order-amount\"&gt;&lt;/span&gt;<br>      &lt;span&gt;BTC&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;canvas id=\"qr\" height=\"500%\" width=\"500%\"  align=\"center\"&gt;&lt;/canvas&gt;<br>    &lt;div id=\"lightaddress\" class=\"order-pr--value\"&gt;&lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a href=\"\" id=\"order-pr--wallet\" class=\"order-pr--wallet\"&gt;Open Wallet&lt;/a&gt;<br>      &lt;a href=\"\" id=\"order-pr--copy\" class=\"order-pr--copy\"&gt;Copy&lt;/a&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>  &lt;div id=\"order-thanks\" class=\"order-thanks\" style=\"display: none\" align=\"center\"&gt;<br>   Thanks you for your order<br>  &lt;/div&gt;<br>&lt;/div&gt;</span></pre>\n<p id=\"f96c\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">The above HTML creates a checkout experience as broken down below. Firstly we create a preloader that we use whilst we connect to the server and generate a charge.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"c3e6\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;div id=\"order-preload\" align=\"center\"&gt;<br>    &lt;div &gt;Generating Invoice...&lt;/div&gt;<br>    &lt;div class=\"lds-dual-ring\"&gt;&lt;/div&gt;<br>&lt;/div&gt;</span></pre>\n<p class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\"> </p>\n<p id=\"c57e\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">Next, we have the QR code as well as the payment address so the user can make payment.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"8186\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;div class=\"order-qrcode\" id=\"order-qrcode\" style=\"display: none\"&gt;<br>  &lt;div id=\"order-details\"&gt;<br>    &lt;div  align=\"center\"&gt;<br>      &lt;div class=\"order-pr--number\" id=\"order-id\"&gt;&lt;/div&gt;<br>      &lt;span class=\"order-pr--pay\" id=\"order-amount\"&gt;&lt;/span&gt;<br>      &lt;span&gt;BTC&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;canvas id=\"qr\" height=\"500%\" width=\"500%\"  align=\"center\"&gt;&lt;/canvas&gt;<br>    &lt;div id=\"lightaddress\" class=\"order-pr--value\"&gt;&lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a href=\"\" id=\"order-pr--wallet\" class=\"order-pr--wallet\"&gt;Open Wallet&lt;/a&gt;<br>      &lt;a href=\"\" id=\"order-pr--copy\" class=\"order-pr--copy\"&gt;Copy&lt;/a&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;</span></pre>\n<figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/17/1_CmGcDewwv1ZsoKT-J-dyQ.png\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-2xl.png 1600w\"  alt=\"\" width=\"1070\" height=\"1253\"></figure>\n<p id=\"3c3a\" data-selectable-paragraph=\"\">Lastly, we have the thank you screen once payment has been made.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"c3d6\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;div id=\"order-thanks\" class=\"order-thanks\" style=\"display: none\" align=\"center\"&gt;<br>   Thanks you for your order<br>  &lt;/div&gt;<br>&lt;/div&gt;</span></pre>\n<h2 class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\"><figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/17/1_UQXNAlEmUfr5c8WGd6_6zQ.png\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-2xl.png 1600w\"  alt=\"\" width=\"1188\" height=\"484\"></figure></h2>\n<h2 id=\"bed3\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">JAVASCRIPT</h2>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"194d\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;script src=\"<a href=\"https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js</a>\"&gt;&lt;/script&gt;</span><span id=\"568f\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">    &lt;script&gt;<br>//hold the checkpayment interval function<br>var checkpaymentres = \"\";<br>var serverurl = \"<a href=\"http://127.0.0.1:3030/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">http://127.0.0.1:3030</a>\";<br>var address = \"\";<br>var thankstext = \"Thanks for your order.  You will receive nothing.\";<br>var request = new XMLHttpRequest();<br>//var server =<br>request.open(<br>  \"GET\",<br>  serverurl + \"/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free btc\",<br>  true<br>);<br></span><span id=\"69d4\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">request.onload = function() {<br>  if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>    // parse the data<br>    var data = JSON.parse(request.responseText);<br>    //debug<br>    //console.log(data.payment)<br>    lightelement = document.getElementById(\"lightaddress\");<br>    lightelement.innerHTML = data.payment.payment_request;<br>    orderid = document.getElementById(\"order-id\");<br>    orderid.innerHTML = \"Order \" + data.payment.id;<br>    var total = parseFloat(data.payment.amount) * 0.00000001;<br>    orderamount = document.getElementById(\"order-amount\");<br>    orderamount.innerHTML = \"Pay \" + String(total);<br>    // builds and displays the QR code<br>    new QRious({<br>      element: document.getElementById(\"qr\"),<br>      value: data.payment.payment_request,<br>      size: 400<br>    });<br>    preload = document.getElementById(\"order-preload\");<br>    preload.style = \"display: none\";<br>    qrcode = document.getElementById(\"order-qrcode\");<br>    qrcode.style = \"display: visible\";<br>    qrcode = document.getElementById(\"order-pr--wallet\");<br>    qrcode.href = \"lightning:\" + data.payment.payment_request;<br>    address = data.payment.payment_request;</span><span id=\"5434\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//check for payment every 10 seconds<br>    checkpaymentres = setInterval(checkPayment, 10000);<br>  }<br>};<br>request.onerror = function() {<br>  // There was a connection error of some sort<br>};<br>request.send();</span><span id=\"6510\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">function stopPaymentCheck() {<br>  clearInterval(checkpaymentres);<br>}</span><span id=\"c48d\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">function checkPayment() {<br>  //debug<br>  //console.log('check payment ticker')<br>  //var url = serverurl+\"/webhook/checkpayment?address=\"+address+\"&amp;token=\"+token;<br>  //var url = serverurl+\"webhook/checkStrikePayment?address=\"+address;<br>  //debug<br>  console.log(\"checking for payment for address:\" + address);<br>  request.open(<br>    \"GET\",<br>    serverurl + \"/webhook/checkstrikepayment?address=\" + address,<br>    true<br>  );<br>  //request.open('GET',\"<a href=\"https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free</a> btc\", true);<br>  //call it<br>  request.onload = function() {<br>    if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>      // parse the data<br>      var data = JSON.parse(request.responseText);<br>      //debug<br>      //console.log(data.status)</span><span id=\"0ac7\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">if (data.status == 1) {<br>        orderthanks = document.getElementById(\"order-thanks\");<br>        orderthanks.style = \"display: visible\";<br>        orderthanks.innerHTML = thankstext;</span><span id=\"a14f\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">orderdetails = document.getElementById(\"order-details\");<br>        orderdetails.style = \"display: none\";<br>        stopPaymentCheck();<br>      }<br>    }<br>  };<br>  request.onerror = function() {<br>    // There was a connection error of some sort<br>  };<br>  request.send();<br>}</span><span id=\"836c\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">document.getElementById(\"order-pr--copy\").addEventListener(\"click\", function() {<br>  const el = document.createElement(\"textarea\"); // Create a &lt;textarea&gt; element<br>  el.value = address; // Set its value to the string that you want copied<br>  el.setAttribute(\"readonly\", \"\"); // Make it readonly to be tamper-proof<br>  el.style.position = \"absolute\";<br>  el.style.left = \"-9999px\"; // Move outside the screen to make it invisible<br>  document.body.appendChild(el);<br>  el.select(); // Select the &lt;textarea&gt; content<br>  document.execCommand(\"copy\"); // Copy - only works as a result of a user action (e.g. click events)<br>  document.body.removeChild(el);<br>});   <br>&lt;/script&gt;</span></pre>\n<p id=\"f7cf\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">Let us take a look at this code and see what exactly is happening. The first thing we are doing is loading a QR class</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"d59f\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">&lt;script src=\"<a href=\"https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js</a>\"&gt;&lt;/script&gt;</span></pre>\n<p id=\"1cad\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">Next, we are setting up some variables:</p>\n<p id=\"3c5a\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\"><strong class=\"lw mi\">checkpaymentres</strong>: this is used to set the time check when we are looking for a payment.<br><strong class=\"lw mi\">serverurl</strong>: the URL of ECS server<br><strong class=\"lw mi\">address</strong>: the address returned from Strike for payment purposes<br><strong class=\"lw mi\">thankstest</strong>: the text to store display once an order is complete</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"936b\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">//hold the checkpayment interval function<br>var checkpaymentres = \"\";<br>var serverurl = \"<a href=\"http://127.0.0.1:3030/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">http://127.0.0.1:3030</a>\";<br>var address = \"\";<br>var thankstext = \"Thanks for your order.  You will receive nothing.\";</span></pre>\n<p id=\"f415\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">Next, we make an ajax call to ECS and telling it we want to generate an invoice.</p>\n<p id=\"19fc\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\"><strong class=\"lw mi\">uid</strong>: the userid we are using <br><strong class=\"lw mi\">currency</strong>: the currency we want to create the invoice in<br><strong class=\"lw mi\">amount</strong>: the amount in Satoshis for the invoice<br><strong class=\"lw mi\">desc</strong>: the description of the item we are selling in the invoice</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"f74a\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">var request = new XMLHttpRequest();<br>//var server =<br>request.open(<br>  \"GET\",<br>  serverurl + \"/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free btc\",<br>  true<br>);</span></pre>\n<p id=\"75bc\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">next, we wait for a response from the server and if the status is valid (between 200 and 400 we process it) we take the information from the response populate the <strong class=\"lw mi\">payment view </strong>and display it, hide the preloader view and start the <strong class=\"lw mi\">checkPayment</strong> timer.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"9d3f\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">request.onload = function() {<br>  if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>    // parse the data<br>    var data = JSON.parse(request.responseText);<br>    lightelement = document.getElementById(\"lightaddress\");<br>    lightelement.innerHTML = data.payment.payment_request;<br>    orderid = document.getElementById(\"order-id\");<br>    orderid.innerHTML = \"Order \" + data.payment.id;<br>    var total = parseFloat(data.payment.amount) * 0.00000001;<br>    orderamount = document.getElementById(\"order-amount\");<br>    orderamount.innerHTML = \"Pay \" + String(total);<br>    // builds and displays the QR code<br>    new QRious({<br>      element: document.getElementById(\"qr\"),<br>      value: data.payment.payment_request,<br>      size: 400<br>    });<br>    preload = document.getElementById(\"order-preload\");<br>    preload.style = \"display: none\";<br>    qrcode = document.getElementById(\"order-qrcode\");<br>    qrcode.style = \"display: visible\";<br>    qrcode = document.getElementById(\"order-pr--wallet\");<br>    qrcode.href = \"lightning:\" + data.payment.payment_request;<br>    address = data.payment.payment_request;</span><span id=\"7978\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//check for payment every 10 seconds<br>    checkpaymentres = setInterval(checkPayment, 10000);<br>  }<br>};<br>request.onerror = function() {<br>  // There was a connection error of some sort<br>};<br>request.send();</span></pre>\n<p id=\"7238\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">Next, we have a couple of functions <strong class=\"lw mi\">checkPayment</strong> and <strong class=\"lw mi\">stopPayment</strong>. <strong class=\"lw mi\">CheckPayment</strong> calls the ECS server and checks for it payment has been made by the user every 10 seconds. Once a payment has been made then it calls shows the <strong class=\"lw mi\">thankyou view</strong>, hides the <strong class=\"lw mi\">payment view</strong> and stops the <strong class=\"lw mi\">checkPayment</strong> timer.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"7cf7\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">function stopPaymentCheck() <br>{<br>  clearInterval(checkpaymentres);<br>}</span><span id=\"e13c\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">function checkPayment() <br>{<br>  request.open(<br>    \"GET\",<br>    serverurl + \"/webhook/checkstrikepayment?address=\" + address,<br>    true<br>  );<br>  //request.open('GET',\"<a href=\"https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free</a> btc\", true);<br>  //call it<br>  request.onload = function() {<br>    if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>      // parse the data<br>      var data = JSON.parse(request.responseText);<br>      //debug<br>      //console.log(data.status)</span><span id=\"5105\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">if (data.status == 1) {<br>        orderthanks = document.getElementById(\"order-thanks\");<br>        orderthanks.style = \"display: visible\";<br>        orderthanks.innerHTML = thankstext;</span><span id=\"5f05\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">orderdetails = document.getElementById(\"order-details\");<br>        orderdetails.style = \"display: none\";<br>        stopPaymentCheck();<br>      }<br>    }<br>  };<br>  request.onerror = function() {<br>    // There was a connection error of some sort<br>  };<br>  request.send();<br>}</span></pre>\n<p id=\"d352\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">lastly, we have a listener that fires when the copy href has been clicked and copies the address to the clipboard</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"9855\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">document.getElementById(\"order-pr--copy\").addEventListener(\"click\", function() {<br>  const el = document.createElement(\"textarea\"); // Create a &lt;textarea&gt; element<br>  el.value = address; // Set its value to the string that you want copied<br>  el.setAttribute(\"readonly\", \"\"); // Make it readonly to be tamper-proof<br>  el.style.position = \"absolute\";<br>  el.style.left = \"-9999px\"; // Move outside the screen to make it invisible<br>  document.body.appendChild(el);<br>  el.select(); // Select the &lt;textarea&gt; content<br>  document.execCommand(\"copy\"); // Copy - only works as a result of a user action (e.g. click events)<br>  document.body.removeChild(el);<br>});</span></pre>\n<h2 id=\"1b93\" class=\"mo li bf av au el mp mq mr ms mt mu mv mw mx my mz\" data-selectable-paragraph=\"\">SERVER</h2>\n<p id=\"3c13\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">We made several changes to the server to work with the refactored database changes as mentioned above. We will not list these here, will stick to the strike changes only.</p>\n<p id=\"5b42\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">The first function we added was a route to create a charge. This calls the strike helper.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"36d0\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">app.get(\"/strike/charge\", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let strikehelper = require('./api/helpers/strike.js').strike;<br>  let strike = new strikehelper();</span><span id=\"6574\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//debug<br>  strike.charge(req,res);<br>});</span></pre>\n<p id=\"07f2\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">The strike helper charge function requests a charge from strike stores in our session table with the information amount, currency etc and returns the details so an invoice can be generated.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"097e\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">/*</span><span id=\"c0b1\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">Just as we did with BTC we started off using a 3rd party API and once we had an understanding of how things work <br>we moved onto owing the entire stack.  We are doing the exact same thing with Lightning</span><span id=\"2432\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">We are using the rather excellent <a href=\"https://strike.acinq.co/\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">https://strike.acinq.co</a> for this purpose.</span><span id=\"79d1\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">*/<br>const config = require('./config');<br>//console.log(config.bitcoin.network)</span><span id=\"9da7\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//load SQLlite (use any database you want or none)<br>const sqlite3 = require(\"sqlite3\").verbose();<br>//open a database connection<br>let db = new sqlite3.Database(\"./db/db.db\", err =&gt; {<br>  if (err) {<br>    console.error(err.message);<br>  }<br>});</span><span id=\"08fb\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">var request = require(\"request\");</span><span id=\"9c58\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//note why uppercase here?<br>var strike = function ()<br>{<br> this.test = function test(req,res) <br> {</span><span id=\"c03e\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">res.send(JSON.stringify({ status: \"ok\" }));<br>     <br> }</span><span id=\"c7fe\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//create a charge<br> this.charge = function charge(req,res)<br> {<br>  //build the options object<br>  var options = {<br>    method: 'POST',<br>    url: process.env.STRIKEENDPOINT + '/api/v1/charges',<br>    headers: {<br>      'cache-control': 'no-cache',<br>      'Content-Type': 'application/json' },<br>    body: {<br>      amount: parseFloat(req.query.amount),<br>      description: req.query.desc,<br>      currency: req.query.currency<br>    },<br>    json: true,<br>    auth: {<br>      user: process.env.STRIKEAPIKEY,<br>      pass: '',<br>    }<br>  };</span><span id=\"3f11\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//call strike<br>  request(options, function (error, response, body) {<br>    if (error) throw new Error(error);<br>     //debug<br>     //console.log(body)</span><span id=\"a265\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//turn it into a BTC amount<br>     //note : in a future update we may go ahead and store everything Satoshis. <br>     //   we could also use req.query.amount here<br>     //   we may want to store order_meta and product_meta here in the future if so we will make those generic functions<br>   var amount = parseFloat(body.amount) * 0.00000001;<br>   <br>   //insert a session<br>   db.run(<br>    `INSERT INTO sessions(address,userid,net,amount,paymenttype) VALUES(?,?,?,?,?)`,<br>    [body.payment_request, req.query.uid, process.env.LIGHTNETWORK,String(amount),2],<br>    function(err) <br>    {<br>     if (err) <br>     {<br>       //return error<br>       res.send(JSON.stringify({ error: err.message }));<br>       return;<br>     }</span><span id=\"84b6\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//store the order product details <br>     db.run(<br>      `INSERT INTO order_product(address,name,price,quantity) VALUES(?,?,?,?)`,<br>      [body.payment_request,req.query.desc, String(amount),1],<br>      function(err) <br>      {<br>       if (err) <br>       {<br>         //return error<br>         res.send(JSON.stringify({ error: err.message }));<br>         return;<br>       }<br>       //store the order_payment_details <br>       db.run(<br>        `INSERT INTO order_payment_details(address,providerid,paymentobject) VALUES(?,?,?)`,<br>        [body.payment_request,2, JSON.stringify(body)],<br>        function(err) <br>        {<br>         if (err) <br>         {<br>           //return error<br>           res.send(JSON.stringify({ error: err.message }));<br>           return;<br>         }<br>         //return the required details to the front end<br>         var obj = {id:body.id,amount:body.amount,payment_request:body.payment_request}<br>         res.send(JSON.stringify({ payment: obj }));<br>         //debug<br>         //console.log(body.payment_request);<br>        }<br>       );<br>      }<br>     );<br>    }<br>   );<br>     <br>  });<br> }</span><span id=\"73a1\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">}<br>exports.strike = strike;</span></pre>\n<p id=\"86ab\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">We added 2 functions to webhook to deal with Strike. The first check payment simply looks in the database to see if a payment has been processed and if it has it returns 1 if it has not it returns 0.</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"c250\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">APP.JS</span><span id=\"9dbb\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">app.post(\"/webhook/checkstrikepayment\", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let webhookhelper = require('./api/helpers/webhook.js').webhook;<br>  let webhook = new webhookhelper();</span><span id=\"e1e6\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//debug<br>  webhook.checkStrikePayment(req,res);<br>});</span><span id=\"d0bf\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">WEBHOOK HELPER</span><span id=\"0903\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">this.checkStrikePayment = function checkStrikePayment(req,res)<br> {<br>  //debug<br>  //console.log(req.body.data.payment_request)<br>  //return;<br>  let data = [1,1, req.body.data.payment_request];<br>  let sql = `UPDATE sessions SET processed = ?,swept=? WHERE address = ?`;<br>  db.run(sql, data, function(err) {<br>   //console.log(result)<br>   if (err) {<br>    res.send(JSON.stringify({ status: 0 }));<br>   }<br>   //store payment object<br>   let data = [JSON.stringify(req.body.data),req.body.data.payment_request];<br>   let sql = `UPDATE order_payment_details SET paymentresponseobject = ? WHERE address = ?`;<br>   db.run(sql, data, function(err) <br>   {<br>    if (err) {<br>     res.send(JSON.stringify({ status: 0 }));<br>    }<br>    //send emails to admin<br>    generic.sendMail(<a href=\"mailto:2,'cryptoskillz@protonmail.com\" class=\"cb bx ld le lf lg\" target=\"_blank\" rel=\"noopener noreferrer\">2,'cryptoskillz@protonmail.com</a>');</span><span id=\"e890\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">res.send(JSON.stringify({ status: 1 }));<br>   });<br>  });</span><span id=\"f390\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">}</span></pre>\n<p id=\"f7fe\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">The next function waits for Strike to process payment when it does it calls this URL with the information and we update our database accordingly</p>\n<pre class=\"kg kh ki kj kk dv gg df\"><span id=\"e8a0\" class=\"mo li bf av na b dz nb nc l nd\" data-selectable-paragraph=\"\">APP.JS</span><span id=\"52a5\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">app.get(\"/webhook/strikenotification\", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let webhookhelper = require('./api/helpers/webhook.js').webhook;<br>  let webhook = new webhookhelper();</span><span id=\"8463\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//debug<br>  webhook.strikeNotification(req,res);<br>});</span><span id=\"fb10\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">WEBHOOK HELPER</span><span id=\"0517\" class=\"mo li bf av na b dz ne nf ng nh ni nc l nd\" data-selectable-paragraph=\"\">//recieve a payment notificaiotn from strike<br> this.strikeNotification = function strikeNotification(req,res)<br> {<br>  //todo: store the payment object     <br>  if (req.query.address != '')<br>  {<br>  let data = [1,1, req.query.address];<br>    let sql = `UPDATE sessions SET processed = ?,swept=? WHERE address = ?`;<br>    db.run(sql, data, function(err) {<br>      if (err) {<br>        return console.error(err.message);<br>      }<br>      res.send(JSON.stringify({ \"status\": \"ok\" }));<br>    });<br>   }<br> }</span></pre>\n<h1 id=\"34b2\" class=\"lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt\" data-selectable-paragraph=\"\">Conclusion</h1>\n<p id=\"3a75\" class=\"lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh\" data-selectable-paragraph=\"\">Now we have Integrated Lightning into our stack via a 3rd party the next logical steps are</p>\n<ol class=\"\">\n<li id=\"8c88\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh nr ns nt\" data-selectable-paragraph=\"\">integrate into SR.js</li>\n<li id=\"8335\" class=\"lu lv bf av lw b lx nu lz nv mb nw md nx mf ny mh nr ns nt\" data-selectable-paragraph=\"\">replace strike with our lightning node</li>\n</ol>\n<p id=\"8d02\" class=\"lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh\" data-selectable-paragraph=\"\">We will focus on point 1 in the next tutorial and point 2 some point in the future.</p>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2019-10-11T12:36">October 11, 2019</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(450/300 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-2xl.jpeg 1600w" data-sizes="auto" alt=""><figcaption>Photo by lee junda on Unsplash</figcaption></figure><header class="u-header post__header"><h1>Adding 3rd party Lightning</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2018-12-27T12:27">December 27, 2018 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><h1 id="4570" class="lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt" data-selectable-paragraph="">Introduction</h1><p id="ad64" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous tutorial, We removed "<a href="https://globee.com/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">Globee</strong></a><strong class="lw mi">"</strong> so that we had 100% sovereignty over our code and by extension our money. Ironically we are going to add "<a href="https://strike.acinq.co/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">strike</strong></a>" which is a 3rd party lightning payment provider. Just as we did in the past we will start the easy way and then remove it and replace it with our own code at a later date.</p><p id="3243" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">A quick note on the current lightning nodes. I played with "<a href="https://github.com/lightningnetwork/lnd" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">LND</strong></a><strong class="lw mi">"</strong> and "<a href="https://github.com/ElementsProject/lightning" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">c-lightning</strong></a>" for a couple of weeks and could not get them to work to a satisfactory level to fulfil our needs "<a href="https://github.com/lightningnetwork/lnd" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">LND</strong></a><strong class="lw mi">"</strong> required everything to be on the one server which meant our idea of injecting was just not practical and "<a href="https://github.com/ElementsProject/lightning" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">c-lightning</strong></a> leaned too heavily on the "<a href="https://github.com/ElementsProject/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">elements</strong></a>" project for us to use it a standalone manner. However, this does not concern me as it is amazing software that is still in Alpha.</p><h1 id="6a9e" class="lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt" data-selectable-paragraph="">The SQL</h1><p id="2dc8" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">We made significant changes to the SQL (it was due) mainly to give the tables names that made sense.</p><h2 id="c623" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">ECS_ tables</h2><p id="a911" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">A number of tables to have the ECS_ prefix this means they are core tables to ECS such as user &amp; user settings</p><pre class="kg kh ki kj kk dv gg df"><span id="be05" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">ecs_coldstorageaddresses<br>ecs_emailtemplates<br>ecs_user<br>ecs_user_settings</span></pre><h2 id="964f" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">lookup_ tables</h2><p id="ccb2" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">the prefix lookup_ was introduced as a way to standardise the lookup data we will use in ECS.</p><p id="db12" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph=""><strong class="lw mi">lookup_payment_providers<br></strong>This table is used to hold the payment providers at the moment we have "Bitcoin Core Node" and "strike" but we may add more in the future.</p><pre class="kg kh ki kj kk dv gg df"><span id="110b" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">CREATE TABLE `lookup_payment_providers` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `providername` INTEGER,<br> `external` INTEGER DEFAULT 0<br>);</span></pre><h2 id="53db" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">order_ tables</h2><p id="cfb9" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">The tables with the order_ prefix are tables that relate directly to the order</p><pre class="kg kh ki kj kk dv gg df"><span id="7af6" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">order_meta<br>order_payment_details<br>order_product<br>order_product_meta</span><span id="e010" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">The product meta holds information about the product such as size</span><span id="c3eb" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">CREATE TABLE `order_product_meta` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `productid` INTEGER,<br> `metaname` TEXT,<br> `metavalue` TEXT<br>);</span><span id="10d1" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">The payment details table holds which method we used to process payment as well as any charge / return objects that the provided us. </span><span id="9742" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">CREATE TABLE `order_payment_details` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `address` TEXT,<br> `providerid` INTEGER,<br> `paymentobject` TEXT,<br> `paymentresponseobject` TEXT<br>);</span></pre><h1 id="3ebe" class="lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt" data-selectable-paragraph="">Strike</h1><p id="fdc7" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">"<a href="https://strike.acinq.co/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">Strike</strong></a>" is an excellent lightning implementation who have taken a lot of the heavy lifting away from us. Simply create an account and then get the api from the settings / API KEYS section as shown below.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_4TPapRENaXVGKwh-7Bcaeg-2xl.png 1600w" alt="" width="1372" height="811"></figure><p id="d14a" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">add this api key to the .env file along with the endpoint</p><pre class="kg kh ki kj kk dv gg df"><span id="14bb" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">mainnet</span><span id="db30" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">STRIKEENDPOINT=<a href="https://api.strike.acinq.co/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://api.strike.acinq.co</a><br>STRIKEAPIKEY=sk_dsdsdsdsd</span><span id="2aa6" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">testnet</span><span id="c96e" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">STRIKEENDPOINT=<a href="https://api.strike.acinq.co/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://api.dev.strike.acinq.co</a><br>STRIKEAPIKEY=sk_dsdsdsdsd</span></pre><h1 id="dca5" class="lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt" data-selectable-paragraph="">The Code</h1><p id="9b58" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">In this tutorial, we have not integrated with SR.js as it was a brand new UX flow we wanted to get it working standalone first and integrate it later. You can find the code for this branch "<a href="https://github.com/cryptoskillz/ECS/tree/strike" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer"><strong class="lw mi">here</strong></a><strong class="lw mi">"</strong></p><h2 id="8893" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">HTML</h2><pre class="kg kh ki kj kk dv gg df"><span id="68f3" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;div id="order-preload" align="center"&gt;<br>    &lt;div &gt;Generating Invoice...&lt;/div&gt;<br>    &lt;div class="lds-dual-ring"&gt;&lt;/div&gt;<br>&lt;/div&gt;<br>&lt;div class="order-qrcode" id="order-qrcode" style="display: none"&gt;<br>  &lt;div id="order-details"&gt;<br>    &lt;div  align="center"&gt;<br>      &lt;div class="order-pr--number" id="order-id"&gt;&lt;/div&gt;<br>      &lt;span class="order-pr--pay" id="order-amount"&gt;&lt;/span&gt;<br>      &lt;span&gt;BTC&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;canvas id="qr" height="500%" width="500%"  align="center"&gt;&lt;/canvas&gt;<br>    &lt;div id="lightaddress" class="order-pr--value"&gt;&lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a href="" id="order-pr--wallet" class="order-pr--wallet"&gt;Open Wallet&lt;/a&gt;<br>      &lt;a href="" id="order-pr--copy" class="order-pr--copy"&gt;Copy&lt;/a&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;<br>  &lt;div id="order-thanks" class="order-thanks" style="display: none" align="center"&gt;<br>   Thanks you for your order<br>  &lt;/div&gt;<br>&lt;/div&gt;</span></pre><p id="f96c" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">The above HTML creates a checkout experience as broken down below. Firstly we create a preloader that we use whilst we connect to the server and generate a charge.</p><pre class="kg kh ki kj kk dv gg df"><span id="c3e6" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;div id="order-preload" align="center"&gt;<br>    &lt;div &gt;Generating Invoice...&lt;/div&gt;<br>    &lt;div class="lds-dual-ring"&gt;&lt;/div&gt;<br>&lt;/div&gt;</span></pre><p class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph=""> </p><p id="c57e" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">Next, we have the QR code as well as the payment address so the user can make payment.</p><pre class="kg kh ki kj kk dv gg df"><span id="8186" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;div class="order-qrcode" id="order-qrcode" style="display: none"&gt;<br>  &lt;div id="order-details"&gt;<br>    &lt;div  align="center"&gt;<br>      &lt;div class="order-pr--number" id="order-id"&gt;&lt;/div&gt;<br>      &lt;span class="order-pr--pay" id="order-amount"&gt;&lt;/span&gt;<br>      &lt;span&gt;BTC&lt;/span&gt;<br>    &lt;/div&gt;<br>    &lt;canvas id="qr" height="500%" width="500%"  align="center"&gt;&lt;/canvas&gt;<br>    &lt;div id="lightaddress" class="order-pr--value"&gt;&lt;/div&gt;<br>    &lt;div&gt;<br>      &lt;a href="" id="order-pr--wallet" class="order-pr--wallet"&gt;Open Wallet&lt;/a&gt;<br>      &lt;a href="" id="order-pr--copy" class="order-pr--copy"&gt;Copy&lt;/a&gt;<br>    &lt;/div&gt;<br>  &lt;/div&gt;</span></pre><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_CmGcDewwv1ZsoKT-J-dyQ-2xl.png 1600w" alt="" width="1070" height="1253"></figure><p id="3c3a" data-selectable-paragraph="">Lastly, we have the thank you screen once payment has been made.</p><pre class="kg kh ki kj kk dv gg df"><span id="c3d6" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;div id="order-thanks" class="order-thanks" style="display: none" align="center"&gt;<br>   Thanks you for your order<br>  &lt;/div&gt;<br>&lt;/div&gt;</span></pre><h2 class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph=""><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/17/responsive/1_UQXNAlEmUfr5c8WGd6_6zQ-2xl.png 1600w" alt="" width="1188" height="484"></figure></h2><h2 id="bed3" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">JAVASCRIPT</h2><pre class="kg kh ki kj kk dv gg df"><span id="194d" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;script src="<a href="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js</a>"&gt;&lt;/script&gt;</span><span id="568f" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">    &lt;script&gt;<br>//hold the checkpayment interval function<br>var checkpaymentres = "";<br>var serverurl = "<a href="http://127.0.0.1:3030/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3030</a>";<br>var address = "";<br>var thankstext = "Thanks for your order.  You will receive nothing.";<br>var request = new XMLHttpRequest();<br>//var server =<br>request.open(<br>  "GET",<br>  serverurl + "/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free btc",<br>  true<br>);<br></span><span id="69d4" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">request.onload = function() {<br>  if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>    // parse the data<br>    var data = JSON.parse(request.responseText);<br>    //debug<br>    //console.log(data.payment)<br>    lightelement = document.getElementById("lightaddress");<br>    lightelement.innerHTML = data.payment.payment_request;<br>    orderid = document.getElementById("order-id");<br>    orderid.innerHTML = "Order " + data.payment.id;<br>    var total = parseFloat(data.payment.amount) * 0.00000001;<br>    orderamount = document.getElementById("order-amount");<br>    orderamount.innerHTML = "Pay " + String(total);<br>    // builds and displays the QR code<br>    new QRious({<br>      element: document.getElementById("qr"),<br>      value: data.payment.payment_request,<br>      size: 400<br>    });<br>    preload = document.getElementById("order-preload");<br>    preload.style = "display: none";<br>    qrcode = document.getElementById("order-qrcode");<br>    qrcode.style = "display: visible";<br>    qrcode = document.getElementById("order-pr--wallet");<br>    qrcode.href = "lightning:" + data.payment.payment_request;<br>    address = data.payment.payment_request;</span><span id="5434" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//check for payment every 10 seconds<br>    checkpaymentres = setInterval(checkPayment, 10000);<br>  }<br>};<br>request.onerror = function() {<br>  // There was a connection error of some sort<br>};<br>request.send();</span><span id="6510" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">function stopPaymentCheck() {<br>  clearInterval(checkpaymentres);<br>}</span><span id="c48d" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">function checkPayment() {<br>  //debug<br>  //console.log('check payment ticker')<br>  //var url = serverurl+"/webhook/checkpayment?address="+address+"&amp;token="+token;<br>  //var url = serverurl+"webhook/checkStrikePayment?address="+address;<br>  //debug<br>  console.log("checking for payment for address:" + address);<br>  request.open(<br>    "GET",<br>    serverurl + "/webhook/checkstrikepayment?address=" + address,<br>    true<br>  );<br>  //request.open('GET',"<a href="https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free</a> btc", true);<br>  //call it<br>  request.onload = function() {<br>    if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>      // parse the data<br>      var data = JSON.parse(request.responseText);<br>      //debug<br>      //console.log(data.status)</span><span id="0ac7" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">if (data.status == 1) {<br>        orderthanks = document.getElementById("order-thanks");<br>        orderthanks.style = "display: visible";<br>        orderthanks.innerHTML = thankstext;</span><span id="a14f" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">orderdetails = document.getElementById("order-details");<br>        orderdetails.style = "display: none";<br>        stopPaymentCheck();<br>      }<br>    }<br>  };<br>  request.onerror = function() {<br>    // There was a connection error of some sort<br>  };<br>  request.send();<br>}</span><span id="836c" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">document.getElementById("order-pr--copy").addEventListener("click", function() {<br>  const el = document.createElement("textarea"); // Create a &lt;textarea&gt; element<br>  el.value = address; // Set its value to the string that you want copied<br>  el.setAttribute("readonly", ""); // Make it readonly to be tamper-proof<br>  el.style.position = "absolute";<br>  el.style.left = "-9999px"; // Move outside the screen to make it invisible<br>  document.body.appendChild(el);<br>  el.select(); // Select the &lt;textarea&gt; content<br>  document.execCommand("copy"); // Copy - only works as a result of a user action (e.g. click events)<br>  document.body.removeChild(el);<br>});   <br>&lt;/script&gt;</span></pre><p id="f7cf" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">Let us take a look at this code and see what exactly is happening. The first thing we are doing is loading a QR class</p><pre class="kg kh ki kj kk dv gg df"><span id="d59f" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">&lt;script src="<a href="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js</a>"&gt;&lt;/script&gt;</span></pre><p id="1cad" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">Next, we are setting up some variables:</p><p id="3c5a" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph=""><strong class="lw mi">checkpaymentres</strong>: this is used to set the time check when we are looking for a payment.<br><strong class="lw mi">serverurl</strong>: the URL of ECS server<br><strong class="lw mi">address</strong>: the address returned from Strike for payment purposes<br><strong class="lw mi">thankstest</strong>: the text to store display once an order is complete</p><pre class="kg kh ki kj kk dv gg df"><span id="936b" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">//hold the checkpayment interval function<br>var checkpaymentres = "";<br>var serverurl = "<a href="http://127.0.0.1:3030/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3030</a>";<br>var address = "";<br>var thankstext = "Thanks for your order.  You will receive nothing.";</span></pre><p id="f415" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">Next, we make an ajax call to ECS and telling it we want to generate an invoice.</p><p id="19fc" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph=""><strong class="lw mi">uid</strong>: the userid we are using <br><strong class="lw mi">currency</strong>: the currency we want to create the invoice in<br><strong class="lw mi">amount</strong>: the amount in Satoshis for the invoice<br><strong class="lw mi">desc</strong>: the description of the item we are selling in the invoice</p><pre class="kg kh ki kj kk dv gg df"><span id="f74a" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">var request = new XMLHttpRequest();<br>//var server =<br>request.open(<br>  "GET",<br>  serverurl + "/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free btc",<br>  true<br>);</span></pre><p id="75bc" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">next, we wait for a response from the server and if the status is valid (between 200 and 400 we process it) we take the information from the response populate the <strong class="lw mi">payment view </strong>and display it, hide the preloader view and start the <strong class="lw mi">checkPayment</strong> timer.</p><pre class="kg kh ki kj kk dv gg df"><span id="9d3f" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">request.onload = function() {<br>  if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>    // parse the data<br>    var data = JSON.parse(request.responseText);<br>    lightelement = document.getElementById("lightaddress");<br>    lightelement.innerHTML = data.payment.payment_request;<br>    orderid = document.getElementById("order-id");<br>    orderid.innerHTML = "Order " + data.payment.id;<br>    var total = parseFloat(data.payment.amount) * 0.00000001;<br>    orderamount = document.getElementById("order-amount");<br>    orderamount.innerHTML = "Pay " + String(total);<br>    // builds and displays the QR code<br>    new QRious({<br>      element: document.getElementById("qr"),<br>      value: data.payment.payment_request,<br>      size: 400<br>    });<br>    preload = document.getElementById("order-preload");<br>    preload.style = "display: none";<br>    qrcode = document.getElementById("order-qrcode");<br>    qrcode.style = "display: visible";<br>    qrcode = document.getElementById("order-pr--wallet");<br>    qrcode.href = "lightning:" + data.payment.payment_request;<br>    address = data.payment.payment_request;</span><span id="7978" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//check for payment every 10 seconds<br>    checkpaymentres = setInterval(checkPayment, 10000);<br>  }<br>};<br>request.onerror = function() {<br>  // There was a connection error of some sort<br>};<br>request.send();</span></pre><p id="7238" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">Next, we have a couple of functions <strong class="lw mi">checkPayment</strong> and <strong class="lw mi">stopPayment</strong>. <strong class="lw mi">CheckPayment</strong> calls the ECS server and checks for it payment has been made by the user every 10 seconds. Once a payment has been made then it calls shows the <strong class="lw mi">thankyou view</strong>, hides the <strong class="lw mi">payment view</strong> and stops the <strong class="lw mi">checkPayment</strong> timer.</p><pre class="kg kh ki kj kk dv gg df"><span id="7cf7" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">function stopPaymentCheck() <br>{<br>  clearInterval(checkpaymentres);<br>}</span><span id="e13c" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">function checkPayment() <br>{<br>  request.open(<br>    "GET",<br>    serverurl + "/webhook/checkstrikepayment?address=" + address,<br>    true<br>  );<br>  //request.open('GET',"<a href="https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://ecs.cryptoskillz.com/strike/charge?uid=3&amp;currency=btc&amp;amount=2000&amp;desc=free</a> btc", true);<br>  //call it<br>  request.onload = function() {<br>    if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>      // parse the data<br>      var data = JSON.parse(request.responseText);<br>      //debug<br>      //console.log(data.status)</span><span id="5105" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">if (data.status == 1) {<br>        orderthanks = document.getElementById("order-thanks");<br>        orderthanks.style = "display: visible";<br>        orderthanks.innerHTML = thankstext;</span><span id="5f05" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">orderdetails = document.getElementById("order-details");<br>        orderdetails.style = "display: none";<br>        stopPaymentCheck();<br>      }<br>    }<br>  };<br>  request.onerror = function() {<br>    // There was a connection error of some sort<br>  };<br>  request.send();<br>}</span></pre><p id="d352" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">lastly, we have a listener that fires when the copy href has been clicked and copies the address to the clipboard</p><pre class="kg kh ki kj kk dv gg df"><span id="9855" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">document.getElementById("order-pr--copy").addEventListener("click", function() {<br>  const el = document.createElement("textarea"); // Create a &lt;textarea&gt; element<br>  el.value = address; // Set its value to the string that you want copied<br>  el.setAttribute("readonly", ""); // Make it readonly to be tamper-proof<br>  el.style.position = "absolute";<br>  el.style.left = "-9999px"; // Move outside the screen to make it invisible<br>  document.body.appendChild(el);<br>  el.select(); // Select the &lt;textarea&gt; content<br>  document.execCommand("copy"); // Copy - only works as a result of a user action (e.g. click events)<br>  document.body.removeChild(el);<br>});</span></pre><h2 id="1b93" class="mo li bf av au el mp mq mr ms mt mu mv mw mx my mz" data-selectable-paragraph="">SERVER</h2><p id="3c13" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">We made several changes to the server to work with the refactored database changes as mentioned above. We will not list these here, will stick to the strike changes only.</p><p id="5b42" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">The first function we added was a route to create a charge. This calls the strike helper.</p><pre class="kg kh ki kj kk dv gg df"><span id="36d0" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">app.get("/strike/charge", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let strikehelper = require('./api/helpers/strike.js').strike;<br>  let strike = new strikehelper();</span><span id="6574" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//debug<br>  strike.charge(req,res);<br>});</span></pre><p id="07f2" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">The strike helper charge function requests a charge from strike stores in our session table with the information amount, currency etc and returns the details so an invoice can be generated.</p><pre class="kg kh ki kj kk dv gg df"><span id="097e" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">/*</span><span id="c0b1" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">Just as we did with BTC we started off using a 3rd party API and once we had an understanding of how things work <br>we moved onto owing the entire stack.  We are doing the exact same thing with Lightning</span><span id="2432" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">We are using the rather excellent <a href="https://strike.acinq.co/" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">https://strike.acinq.co</a> for this purpose.</span><span id="79d1" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">*/<br>const config = require('./config');<br>//console.log(config.bitcoin.network)</span><span id="9da7" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//load SQLlite (use any database you want or none)<br>const sqlite3 = require("sqlite3").verbose();<br>//open a database connection<br>let db = new sqlite3.Database("./db/db.db", err =&gt; {<br>  if (err) {<br>    console.error(err.message);<br>  }<br>});</span><span id="08fb" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">var request = require("request");</span><span id="9c58" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//note why uppercase here?<br>var strike = function ()<br>{<br> this.test = function test(req,res) <br> {</span><span id="c03e" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">res.send(JSON.stringify({ status: "ok" }));<br>     <br> }</span><span id="c7fe" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//create a charge<br> this.charge = function charge(req,res)<br> {<br>  //build the options object<br>  var options = {<br>    method: 'POST',<br>    url: process.env.STRIKEENDPOINT + '/api/v1/charges',<br>    headers: {<br>      'cache-control': 'no-cache',<br>      'Content-Type': 'application/json' },<br>    body: {<br>      amount: parseFloat(req.query.amount),<br>      description: req.query.desc,<br>      currency: req.query.currency<br>    },<br>    json: true,<br>    auth: {<br>      user: process.env.STRIKEAPIKEY,<br>      pass: '',<br>    }<br>  };</span><span id="3f11" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//call strike<br>  request(options, function (error, response, body) {<br>    if (error) throw new Error(error);<br>     //debug<br>     //console.log(body)</span><span id="a265" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//turn it into a BTC amount<br>     //note : in a future update we may go ahead and store everything Satoshis. <br>     //   we could also use req.query.amount here<br>     //   we may want to store order_meta and product_meta here in the future if so we will make those generic functions<br>   var amount = parseFloat(body.amount) * 0.00000001;<br>   <br>   //insert a session<br>   db.run(<br>    `INSERT INTO sessions(address,userid,net,amount,paymenttype) VALUES(?,?,?,?,?)`,<br>    [body.payment_request, req.query.uid, process.env.LIGHTNETWORK,String(amount),2],<br>    function(err) <br>    {<br>     if (err) <br>     {<br>       //return error<br>       res.send(JSON.stringify({ error: err.message }));<br>       return;<br>     }</span><span id="84b6" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//store the order product details <br>     db.run(<br>      `INSERT INTO order_product(address,name,price,quantity) VALUES(?,?,?,?)`,<br>      [body.payment_request,req.query.desc, String(amount),1],<br>      function(err) <br>      {<br>       if (err) <br>       {<br>         //return error<br>         res.send(JSON.stringify({ error: err.message }));<br>         return;<br>       }<br>       //store the order_payment_details <br>       db.run(<br>        `INSERT INTO order_payment_details(address,providerid,paymentobject) VALUES(?,?,?)`,<br>        [body.payment_request,2, JSON.stringify(body)],<br>        function(err) <br>        {<br>         if (err) <br>         {<br>           //return error<br>           res.send(JSON.stringify({ error: err.message }));<br>           return;<br>         }<br>         //return the required details to the front end<br>         var obj = {id:body.id,amount:body.amount,payment_request:body.payment_request}<br>         res.send(JSON.stringify({ payment: obj }));<br>         //debug<br>         //console.log(body.payment_request);<br>        }<br>       );<br>      }<br>     );<br>    }<br>   );<br>     <br>  });<br> }</span><span id="73a1" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">}<br>exports.strike = strike;</span></pre><p id="86ab" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">We added 2 functions to webhook to deal with Strike. The first check payment simply looks in the database to see if a payment has been processed and if it has it returns 1 if it has not it returns 0.</p><pre class="kg kh ki kj kk dv gg df"><span id="c250" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">APP.JS</span><span id="9dbb" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">app.post("/webhook/checkstrikepayment", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let webhookhelper = require('./api/helpers/webhook.js').webhook;<br>  let webhook = new webhookhelper();</span><span id="e1e6" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//debug<br>  webhook.checkStrikePayment(req,res);<br>});</span><span id="d0bf" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">WEBHOOK HELPER</span><span id="0903" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">this.checkStrikePayment = function checkStrikePayment(req,res)<br> {<br>  //debug<br>  //console.log(req.body.data.payment_request)<br>  //return;<br>  let data = [1,1, req.body.data.payment_request];<br>  let sql = `UPDATE sessions SET processed = ?,swept=? WHERE address = ?`;<br>  db.run(sql, data, function(err) {<br>   //console.log(result)<br>   if (err) {<br>    res.send(JSON.stringify({ status: 0 }));<br>   }<br>   //store payment object<br>   let data = [JSON.stringify(req.body.data),req.body.data.payment_request];<br>   let sql = `UPDATE order_payment_details SET paymentresponseobject = ? WHERE address = ?`;<br>   db.run(sql, data, function(err) <br>   {<br>    if (err) {<br>     res.send(JSON.stringify({ status: 0 }));<br>    }<br>    //send emails to admin<br>    generic.sendMail(<a href="mailto:2,'cryptoskillz@protonmail.com" class="cb bx ld le lf lg" target="_blank" rel="noopener noreferrer">2,'cryptoskillz@protonmail.com</a>');</span><span id="e890" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">res.send(JSON.stringify({ status: 1 }));<br>   });<br>  });</span><span id="f390" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">}</span></pre><p id="f7fe" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">The next function waits for Strike to process payment when it does it calls this URL with the information and we update our database accordingly</p><pre class="kg kh ki kj kk dv gg df"><span id="e8a0" class="mo li bf av na b dz nb nc l nd" data-selectable-paragraph="">APP.JS</span><span id="52a5" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">app.get("/webhook/strikenotification", (req, res) =&gt; {<br>  res = generic.setHeaders(res);<br>  //load the back office helper<br>  let webhookhelper = require('./api/helpers/webhook.js').webhook;<br>  let webhook = new webhookhelper();</span><span id="8463" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//debug<br>  webhook.strikeNotification(req,res);<br>});</span><span id="fb10" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">WEBHOOK HELPER</span><span id="0517" class="mo li bf av na b dz ne nf ng nh ni nc l nd" data-selectable-paragraph="">//recieve a payment notificaiotn from strike<br> this.strikeNotification = function strikeNotification(req,res)<br> {<br>  //todo: store the payment object     <br>  if (req.query.address != '')<br>  {<br>  let data = [1,1, req.query.address];<br>    let sql = `UPDATE sessions SET processed = ?,swept=? WHERE address = ?`;<br>    db.run(sql, data, function(err) {<br>      if (err) {<br>        return console.error(err.message);<br>      }<br>      res.send(JSON.stringify({ "status": "ok" }));<br>    });<br>   }<br> }</span></pre><h1 id="34b2" class="lh li bf av au el lj lk ll lm ln lo lp lq lr ls lt" data-selectable-paragraph="">Conclusion</h1><p id="3a75" class="lu lv bf av lw b lx ly lz ma mb mc md me mf mg mh" data-selectable-paragraph="">Now we have Integrated Lightning into our stack via a 3rd party the next logical steps are</p><ol><li id="8c88" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh nr ns nt" data-selectable-paragraph="">integrate into SR.js</li><li id="8335" class="lu lv bf av lw b lx nu lz nv mb nw md nx mf ny mh nr ns nt" data-selectable-paragraph="">replace strike with our lightning node</li></ol><p id="8d02" class="lu lv bf av lw b lx mj lz mk mb ml md mm mf mn mh" data-selectable-paragraph="">We will focus on point 1 in the next tutorial and point 2 some point in the future.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on October 10, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/finally-removing-globee.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/16/responsive/1_8-iq0_Ls5451w2BYuO-Y_w-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/16/responsive/1_8-iq0_Ls5451w2BYuO-Y_w-xs.jpeg" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Finally removing GloBee</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/integrating-3rd-party-lightning.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Integrating 3rd party Lightning</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-xs.jpeg" data-expand="300" alt=""></a></div></nav></footer></article></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(3)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(24)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(8)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li><li><a href="https://cryptoskillz.com/blog/wink/">wink</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>