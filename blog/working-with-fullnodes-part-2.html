<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Working with Fullnodes part 2 - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/working-with-fullnodes-part-2.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Working with Fullnodes part 2"><meta property="og:image" content="https://cryptoskillz.com/blog/media/website/logo.png"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=58acac63961d23abccded091eaca6989"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html"},"headline":"Working with Fullnodes part 2","datePublished":"2018-10-18T12:05","dateModified":"2019-09-20T12:08","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685},"description":"<figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/11/1_63p4B8NFmprNKx3-VZHkeA.jpeg\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-2xl.jpeg 1600w\"  alt=\"\" width=\"4000\" height=\"2250\"></figure>\n<p> </p>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz","logo":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685}}}</script><script src="https://cryptoskillz.com/blog/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script><script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-4710117865976591",
enable_page_level_ads: true
});</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://cryptoskillz.com/blog/"><img src="https://cryptoskillz.com/blog/media/website/logo.png" alt="cryptoskillz"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li><li class="has-submenu"><a href="https://cryptoskillz.com/blog/ecs/" target="_self" aria-haspopup="true">BLOG</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://cryptoskillz.com/blog/ecs/" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blog/fullnode/" target="_self">FULLNODE</a></li><li><a href="https://cryptoskillz.com/blog/cyphernode/" target="_self">CYPHERNODE</a></li><li><a href="https://cryptoskillz.com/blog/trx/" target="_self">TRX</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2018-10-18T12:05">October 18, 2018</time></div><h1>Working with Fullnodes part 2</h1></div></header></div><div class="wrapper post__entry"><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_63p4B8NFmprNKx3-VZHkeA.jpeg" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-2xl.jpeg 1600w" alt="" data-aspectratio="1.777778" width="4000" height="2250"></figure><p> </p><h1 id="e03d" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Introduction</h1><p id="ad64" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous article, we deep dived into Fullnodes and what a lot of fun that was.</p><p id="cc89" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">In this tutorial, we are going to use the knowledge we gained to recode the server section, remove "<strong class="lu ml"><a href="https://block.io/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> and "<strong class="lu ml"><a href="http://blockcypher.com/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">blockcypher</a>"</strong> to push the transaction. Which means we will have 0 external dependencies in our stack, yay.</p><p id="919a" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">We also removed "<strong class="lu ml"><a href="https://github.com/bitcoinjs/bitcoinjs-lib" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Bitcoinjs</a>"</strong> and replaced it with "<strong class="lu ml"><a href="https://www.npmjs.com/package/bitcoin-core" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">bitcoin core</a>"</strong>. We went into great detail about why we made these decisions in the "<strong><a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-1.html">previous article</a></strong>" so please check this out if you have not already done so.</p><h1 id="7588" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The SQL</h1><p id="dcc5" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We removed the private and public key of fields from the <strong class="lu ml">keys</strong> table. As we now have RPC access to the full node that created the transactions we can get these details directly from the node.</p><pre class="ke kf kg kh ki dv ge df"><span id="f58e" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">CREATE TABLE "keys" <br>( `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `address` TEXT, `processed` INTEGER DEFAULT 0,<br> `swept` INTEGER DEFAULT 0,<br> `userid` INTEGER,<br> `net` INTEGER DEFAULT 1,<br> `amount` TEXT DEFAULT 0<br>)</span></pre><h1 id="ea8b" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The Code</h1><p id="af79" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">All of the code changes are isolated to the Server this time. Firstly we removed monitor.js (we will replace this later in a much better way) and then we completely refactored app.js.</p><p id="03fb" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">The branch for this tutorial can be found "<strong><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/9-fullnode-part-2" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong>.</p><p id="805d" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/9-fullnode-part-2/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu ml">app.js</strong></a></p><p id="2895" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Apart from moving some functions so they were more logically grouped all of the code changes are contained in the 3 main API methods <strong class="lu ml">address</strong>, <strong class="lu ml">monitor</strong> and <strong class="lu ml">sweep</strong>.</p><pre class="ke kf kg kh ki dv ge df"><span id="4584" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">app.get("/api/sweep", (req, res) =&gt; {<br>  //set the headers<br>  res = setHeaders(res);<br>  //unlock the wallet<br>  client.walletPassphrase(process.env.walletpassphrase, 10).then(() =&gt; {<br>    client.listUnspent(1, 9999999, [req.query.address]).then(result =&gt; {<br>      //get the private key<br>      client.dumpPrivKey(req.query.address).then(pkey =&gt; {<br>        //check if there are any<br>        if (result.length == 0) {<br>          //debug<br>          //console.log(result);<br>          //exit gracefully<br>          res.send(<br>            JSON.stringify({<br>              result: "nothing to sweep no unspent transactions"<br>            })<br>          );<br>          return;<br>        } else {<br>          //check the confirmation count<br>          if (result[0].confirmations &gt; 1) {<br>            //estimate fee<br>            client.estimateSmartFee(6).then(fee =&gt; {<br>              //work out the amount to send<br>              var amounttosend = result[0].amount - fee.feerate;<br>              //create raw transaction<br>              client<br>                .createRawTransaction(<br>                  [{ txid: result[0].txid, vout: 0 }],<br>                  [{ [process.env.toaddress]: amounttosend }]<br>                )<br>                .then(txhash =&gt; {<br>                  //sign it<br>                  client<br>                    .signRawTransaction(<br>                      txhash,<br>                      [<br>                        {<br>                          txid: result[0].txid,<br>                          vout: 0,<br>                          amount: result[0].amount,<br>                          scriptPubKey: result[0].scriptPubKey,<br>                          redeemScript: result[0].redeemScript<br>                        }<br>                      ],<br>                      [pkey]<br>                    )<br>                    .then(signed =&gt; {<br>                      //broadcast it<br>                      client<br>                        .sendRawTransaction(signed.hex)<br>                        .then(broadcasted =&gt; {<br>                          //build sql<br>                          let sqldata = ["1", req.query.address];<br>                          let sql = `UPDATE keys<br>                                       SET swept = ?<br>                                       WHERE address = ?`;</span><span id="46a6" class="mm lg bf av mn b dz mr ms mt mu mv mp l mq" data-selectable-paragraph="">                          //run sql<br>                          db.run(sql, sqldata, function(err) {<br>                            if (err) {<br>                            }<br>                            //lock wallet<br>                            client.walletLock();<br>                            //return status<br>                            res.send(JSON.stringify({ status: "swept" }));<br>                            return;<br>                          });<br>                        });<br>                    });<br>                });<br>            });<br>          } else {<br>            //lock wallet<br>            client.walletLock();<br>            //return status<br>            res.send(<br>              JSON.stringify({<br>                status: "not enough confirmations :" + result[0].confirmations<br>              })<br>            );<br>            return;<br>          }<br>        }<br>      });<br>    });<br>  });<br>});</span></pre><p id="f1ac" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Let us break down what is happening:</p><p id="031f" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">The first thing we have to do is include "<strong class="lu ml"><a href="https://www.npmjs.com/package/bitcoin-core" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Bitcoin Core</a>"</strong> and configure it which we do with the code below</p><pre class="ke kf kg kh ki dv ge df"><span id="89d9" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">//load bitcoin core<br>const Client = require("bitcoin-core");<br>//open a connection to the RPC client<br>const client = new Client({<br>  host: "127.0.0.1",<br>  port: 18332,<br>  username: "test",<br>  password: "test"<br>});</span></pre><h2 id="66f0" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">generate</h2><p id="604c" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">In the generate function he first thing we do is unlock the wallet using the passphrase that we have set as an environment variable and calling the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/walletpassphrase/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">walletPassphrase</a>"</strong> function.</p><pre class="ke kf kg kh ki dv ge df"><span id="6c76" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.walletPassphrase(process.env.walletpassphrase, 10).then(() =&gt; {<br>   <br>})</span></pre><p id="eab3" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we generate a new address by calling the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/getnewaddress/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">getNewAddress</a>"</strong> function and passing in the name of the wallet account, again we set the account name as an environment variable</p><pre class="ke kf kg kh ki dv ge df"><span id="98ff" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.getNewAddress(process.env.walletaccount).then(address =&gt; {<br>     <br>})</span></pre><p id="6ee4" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Lastly, we are adding the new address to the database and returning it as a JSON object to the caller.</p><pre class="ke kf kg kh ki dv ge df"><span id="045a" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">db.run(`INSERT INTO keys(address,userid,net) VALUES(?,?,?)`, [address,req.query.uid,network], function(err) {<br>   if (err) {<br>     res.send(JSON.stringify({error: err.message}));<br>     return;<br>   }<br>   //return the address<br>   res.send(JSON.stringify({address:address}));<br>  });<br>     client.walletLock();<br>     return;<br>   });<br> });</span></pre><h2 id="407d" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">monitor</h2><p id="8cd3" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Firstly, we see which funds are unspent in this address by using the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/getreceivedbyaddress/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">getRecievedByAdress</a>"</strong> and passing it the address we generated above.</p><pre class="ke kf kg kh ki dv ge df"><span id="cdf2" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.getReceivedByAddress(req.query.address).then(result =&gt; {</span><span id="067c" class="mm lg bf av mn b dz mr ms mt mu mv mp l mq" data-selectable-paragraph="">});</span></pre><p id="607b" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we check the value is more than 0 if it is then we update the entry in the database to “<strong class="lu ml">process</strong>”. We could do a confirmation check here if we really wanted to but I am happy to have that in the sweep function that is shown below.</p><pre class="ke kf kg kh ki dv ge df"><span id="f67f" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">if (result &gt; 0) {<br>  //build the query<br>  let data = ["1", result, req.query.address];<br>  let sql = `UPDATE keys<br>               SET processed = ?,<br>                amount = ?<br>               WHERE address = ?`;<br>  //run the query<br>  db.run(sql, data, function(err) {<br>    if (err) {<br>      return console.error(err.message);<br>    }<br>    //retun response<br>    res.send(JSON.stringify({ status: "confirmed" }));<br>  });<br>} else {<br>  //return error<br>  res.send(JSON.stringify({ status: "not confirmed" }));<br>}</span></pre><h2 id="68bb" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">sweep</h2><p id="c0c5" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The sweep function is used to move the received funds to our cold storage address.</p><p id="2e45" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Firstly, we unlock the wallet for 10 seconds using the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/walletpassphrase/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">walletPassphrase</a>" </strong>function</p><pre class="ke kf kg kh ki dv ge df"><span id="36c0" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.walletPassphrase(process.env.walletpassphrase, 10).then(() =&gt; {<br> <br>})</span></pre><p id="8f28" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we want to get all of the unspent UTX’s for the address we generated above using the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/listunspent/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">listUnspent</a>"</strong> function</p><pre class="ke kf kg kh ki dv ge df"><span id="f1cc" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph=""> client.listUnspent(1,9999999,[req.query.address]).then(result =&gt; {<br>   <br> });</span></pre><p id="5abb" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we want to get the private key for this address so we can sign a transaction later. We achieve this by calling the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/dumpprivkey/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">dumpPrivKey</a>"</strong> function.</p><pre class="ke kf kg kh ki dv ge df"><span id="5687" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.dumpPrivKey(req.query.address).then(pkey =&gt; {<br>    <br>});</span></pre><p id="a259" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we check that we have some unspent transactions if we do not we exit as there is nothing else to do.</p><pre class="ke kf kg kh ki dv ge df"><span id="1524" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">if (result.length == 0) {<br>  //exit gracefully<br>  res.send(<br>    JSON.stringify({ result: "nothing to sweep no unspent transactions" })<br>  );<br>  return;<br>} </span></pre><p id="2cf9" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, as there are some unspent transactions then we want to check the number of confirmations that we want before we class it as a valid transaction. As you can see we have set it to 1 (to make testing faster) but in any production code, it should be between 3–6.</p><pre class="ke kf kg kh ki dv ge df"><span id="b304" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">if (result[0].confirmations &gt; 1) {<br>    <br>}</span></pre><p id="1607" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we call the "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/util/estimatesmartfee/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">estimatesmartfee</a>"</strong> function and remove this fee from the amount we want to send.</p><pre class="ke kf kg kh ki dv ge df"><span id="02fb" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.estimateSmartFee(6).then(fee =&gt; {<br>      //work out the amount to send<br>      var amounttosend = result[0].amount - fee.feerate;<br>  }</span></pre><p id="40c1" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Next, we want to create, sign and broadcast the transaction assuming this all works as expected we update the database and you should see the money in your bitcoin wallet. We use the functions "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/rawtransactions/createrawtransaction/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">createRawTransaction</a>" </strong>and "<strong class="lu ml"><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/rawtransactions/sendrawtransaction/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">sendRawTransaction</a>"</strong> functions to achieve this.</p><pre class="ke kf kg kh ki dv ge df"><span id="12da" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">client.createRawTransaction(<br>          [{ txid: result[0].txid, vout: 0 }],<br>          [{ [process.env.toaddress]: amounttosend }]<br>        )<br>        .then(txhash =&gt; {<br>          client<br>            .signRawTransaction(<br>              txhash,<br>              [<br>                {<br>                  txid: result[0].txid,<br>                  vout: 0,<br>                  amount: result[0].amount,<br>                  scriptPubKey: result[0].scriptPubKey,<br>                  redeemScript: result[0].redeemScript<br>                }<br>              ],<br>              [pkey]<br>            )<br>            .then(signed =&gt; {<br>              client.sendRawTransaction(signed.hex).then(broadcasted =&gt; {<br>                let sqldata = ["1", req.query.address];<br>                let sql = `UPDATE keys<br>               SET swept = ?<br>               WHERE address = ?`;</span><span id="e65e" class="mm lg bf av mn b dz mr ms mt mu mv mp l mq" data-selectable-paragraph="">//run sql<br>                db.run(sql, sqldata, function(err) {<br>                  if (err) {<br>                  }<br>                  //lock wallet<br>                  client.walletLock();<br>                  //return status<br>                  res.send(JSON.stringify({ status: "swept" }));<br>                  return;<br>                });<br>              });<br>            });<br>        });<br>    });<br>  } else {<br>    //lock wallet<br>    client.walletLock();<br>    //return status<br>    res.send(<br>      JSON.stringify({<br>        status: "not enough confirmations :" + result[0].confirmations<br>      })<br>    );<br></span></pre><h1 id="95a3" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph=""><strong class="ch">Using the code</strong></h1><h2 id="82c7" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">Step 1: Start Bitcoin Core</h2><p id="3a1e" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Browse to the following directory by using the following command in a terminal window.</p><pre class="ke kf kg kh ki dv ge df"><span id="99a4" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">cd /Applications/Bitcoin-Qt.app/Contents/MacOS/</span></pre><p id="38bf" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Then start it with the following parameters:</p><p id="ebf5" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><strong class="lu ml">rpcuser</strong><br>The username for the RPC server</p><p id="12cf" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><strong class="lu ml">rpcpassword<br></strong>The password for the RPC server</p><p id="5147" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><strong class="lu ml">rest</strong> <br>Start the REST server</p><p id="9bfd" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><strong class="lu ml">testnet</strong> <br>Connect to the test network</p><p id="bec2" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph=""><strong class="lu ml">deprecatedrpc<br></strong>Run deprecated functions. The reason we are doing this here is to use the <strong class="lu ml">signrawtransaction</strong> function which has technically been deprecated but its replacement is not available until Bitcoin Core v0.018.0</p><pre class="ke kf kg kh ki dv ge df"><span id="4c58" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">./Bitcoin-Qt -server -rpcuser=test  -rpcpassword=test -rest -testnet  -deprecatedrpc=signrawtransaction</span></pre><h2 id="8bbd" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">step 2: generate a transaction</h2><p id="7fdc" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Open a new terminal window and go into the server directory of the project and run "<strong class="lu ml"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/9-fullnode-part-2/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">app.js</a>"</strong>, this will start the server</p><pre class="ke kf kg kh ki dv ge df"><span id="4334" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">node app.js</span></pre><p id="74c2" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Now go to chrome (or your browser of choice) and call the generate address function by calling the URL below. Note you can also do this via WWW (see the previous tutorial for details on how to do this)</p><pre class="ke kf kg kh ki dv ge df"><span id="70cb" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph=""><a href="http://127.0.0.1:3000/api/address?uid=3" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3000/api/address?uid=3</a></span></pre><p id="30a6" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">This will generate an address that we can use for the payment as shown below</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_-HErYZdxIs1ozMSAV6tdmQ.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_-HErYZdxIs1ozMSAV6tdmQ-2xl.png 1600w" alt="" data-aspectratio="3.316239" width="1164" height="351"></figure><h2 id="c100" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">step 3: monitor a transaction</h2><p id="ba93" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Now we can go ahead and send some money to this address by going to our Bitcoin wallet and sending funds</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_991QXPGUBCSWtEPSjKrLmw.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_991QXPGUBCSWtEPSjKrLmw-2xl.png 1600w" alt="" data-aspectratio="2.261128" width="2286" height="1011"></figure><p id="bde7" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">Now we can go back to our browser and call the monitor script by going to the URL below. Not you will see that we have added the address that was generated.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_c63oAwTdOaR_6hlD60sP4g.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_c63oAwTdOaR_6hlD60sP4g-2xl.png 1600w" alt="" data-aspectratio="4.445682" width="1596" height="359"></figure><p id="9a3f" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">It will say unconfirmed until the total shows in the blockchain we can check this using an "<strong><a href="https://live.blockcypher.com/btc-testnet/address/2Mx1TYm5J87WQAuqo4SBMQZJZLRPNjg716N/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">explorer</a>"</strong></p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_HG_hUtWVsHP7lQtaG5b-dg.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_HG_hUtWVsHP7lQtaG5b-dg-2xl.png 1600w" alt="" data-aspectratio="2.661496" width="2917" height="1096"></figure><p id="6dbd" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">After 10 minutes (more or less) it will receive its first confirmation (as shown below) and we can move on to sweeping it into our cold storage wallet.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_ofWuu5uTyLEmasHVwxX9WA.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_ofWuu5uTyLEmasHVwxX9WA-2xl.png 1600w" alt="" data-aspectratio="2.324552" width="2206" height="949"></figure><h2 id="c5fe" class="mm lg bf av au el mw mx my mz na nb nc nd ne nf ng" data-selectable-paragraph="">step 4: sweep transaction</h2><p id="29f7" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We run the sweep by going to the following URL in your browser. As you will see we are using the same address (created in generating) again.</p><pre class="ke kf kg kh ki dv ge df"><span id="977d" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph=""><a href="http://127.0.0.1:3000/api/sweep?address=2Mx1TYm5J87WQAuqo4SBMQZJZLRPNjg716N" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3000/api/sweep?address=2Mx1TYm5J87WQAuqo4SBMQZJZLRPNjg716N</a></span></pre><p id="65aa" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">At first, you will see it display not enough confirmations (if you did it directly after monitor had finished) as we make it require more than 1 confirmed transaction to sweep. This should be greater than 6 but for testing 1 is fine.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_48D1fLtMrmJNSbYgyC3Fgw.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_48D1fLtMrmJNSbYgyC3Fgw-2xl.png 1600w" alt="" data-aspectratio="2.652174" width="1464" height="552"></figure><p id="f1ff" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">This will take another 10 minutes (more or less) to get a second confirmation. Eventually, you will see the following screen.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_L2V87ynoHcoSA0-wiQjfjw.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_L2V87ynoHcoSA0-wiQjfjw-2xl.png 1600w" alt="" data-aspectratio="3.597727" width="1583" height="440"></figure><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_vhbooVgjpB2NlBFcJ3GsrA.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_vhbooVgjpB2NlBFcJ3GsrA-2xl.png 1600w" alt="" data-aspectratio="5.335878" width="699" height="131"></figure><p id="a16d" class="ls lt bf av lu b lv mg lx mh lz mi mb mj md mk mf" data-selectable-paragraph="">and the money will be in your wallet as shown below.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/11/1_aG1x7EgXM0ElWul57Q7r4g.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-md.png 768w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/11/responsive/1_aG1x7EgXM0ElWul57Q7r4g-2xl.png 1600w" alt="" data-aspectratio="3.259259" width="2288" height="702"></figure><p data-selectable-paragraph=""> </p><h1 id="8d7c" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Conclusion</h1><p id="4505" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We have successfully managed to remove all 3rd party APIs from and we are using our own full node to manage transactions. We finally have 100% sovereignty over our money. In the next tutorial, we hope to deep dive the transaction calls and really break down what vout and all that other fun stuff is doing.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 20, 2019</p><ul class="post__tag"><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a></li></ul><div class="post__share"><a href="https://twitter.com/share?url=https%3A%2F%2Fcryptoskillz.com%2Fblog%2Fworking-with-fullnodes-part-2.html&amp;via=crypto_skillz&amp;text=Working%20with%20Fullnodes%20part%202" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span></a></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-1.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Working with Fullnodes part 1</a></div><div class="post__nav-next"><a href="https://cryptoskillz.com/blog/address-101.html" class="invert post__nav-link" rel="next"><span>Next</span> Part 10: Address 101 </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html';
               		this.page.identifier = '11';
                       this.page.title = ' Working with Fullnodes part 2';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://cryptoskillz-1.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__social"><a href="crypto_skillz" aria-label="Twitter"><svg><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg></a></div><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static CMS</a></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'overlay',
        animationSpeed: 300,
        submenuWidth: 240,
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>