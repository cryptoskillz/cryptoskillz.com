<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Move payment to cold storage - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/move-payment-to-cold-storage.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/move-payment-to-cold-storage.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Move payment to cold storage"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/6/1_YYI3zd3a5mRDlodesvewtw.jpeg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/move-payment-to-cold-storage.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/move-payment-to-cold-storage.html"},"headline":"Move payment to cold storage","datePublished":"2018-09-28T04:57","dateModified":"2019-10-10T23:41","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/6/1_YYI3zd3a5mRDlodesvewtw.jpeg","height":426,"width":639},"description":" This guide aims to program a website to accept Bitcoin. In the previous part, we monitored the blockchain with \"block.io\" to let us know when the payment was successful. Now we aim to take processed funds and sweep them into a \"cold storage\" wallet. We do&hellip;","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2019-11-20T23:19">November 20, 2019</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><div class="banner banner--before-post"><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT START</h2><p>Only joking, but not. We want your Bitcoin, any amount will do.  We like Bitcoin and want more of it, so please give it to us.  Click the button below to donate.</p><p><a href="#0" id="sr-add-to-cart" cart-type="2" class="sr-add-to-cart add-to-cart btn btn-primary" data-price="0.01" data-name="Entity T" data-preview="" style="color: #000;">Donate</a> </p><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT END</h2></div><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(426/639 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-2xl.jpeg 1600w" data-sizes="auto" alt=""></figure><header class="u-header post__header"><h1>Move payment to cold storage</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2018-09-28T04:57">September 28, 2018 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><p> </p><h1 id="d179" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Introduction</h1><p id="dfde" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous part, we monitored the blockchain with "<strong class="lj lz"><a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> to let us know when the payment was successful.</p><p id="d59d" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Now we aim to take processed funds and sweep them into a "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">cold storage</a>" </strong>wallet. We do this with a new script called “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/sweep.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">sweep.js</strong></a>”.</p><blockquote class="mf mg mh"><p id="770b" class="lh li bf mi lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note cryptoskillz from the future here. It turns out we did this bit really badly you can read about in part 10 "<strong><a href="https://cryptoskillz.com/blog/address-101.html" target="_blank" rel="noopener noreferrer">here</a>"</strong> . As a result we would ignore this and instead wait to part 11 which fixes the issues. Ok, Bye, friend :]</p></blockquote><h1 id="05f0" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The SQL</h1><p id="fa99" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We have added a field called swept which is to check if we have moved the payment to our "<strong><a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">cold storage</a>"</strong> or not.</p><pre class="mj mk ml mm mn dv ge df"><span id="56d4" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">CREATE TABLE "keys" ( <br>`id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `privatekey` TEXT,<br> `publickey` TEXT,<br> `address` TEXT,<br> `processed` INTEGER DEFAULT 0,<br> `swept` INTEGER DEFAULT 0 <br>)</span></pre><h1 id="6cb3" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The Code</h1><p id="ff28" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The latest (branch sweep) code can be found "<strong class="lj lz"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/sweep" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">here</a>"</strong> and it is listed below.</p><pre class="mj mk ml mm mn dv ge df"><span id="9ca2" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">/*<br>This is the sweep script that moves payment to our hard wallet.<br>*/<br>//init block.io<br>var BlockIo = require("block_io");<br>var version = 2; // API version<br>var block_io = new BlockIo(<br>  process.env.blockiokey,<br>  process.env.blockiosecret,<br>  version<br>);<br>//load express<br>const express = require("express");<br>//load body parser<br>const bodyParser = require("body-parser");<br>//load the bitcoin js files<br>var bitcoin = require("bitcoinjs-lib");<br>//load SQLlite (use any database you want or none)<br>//init it<br>const sqlite3 = require("sqlite3").verbose();<br>var request = require("request");<br>//init it<br>const app = express();<br>//open a database connection<br>let db = new sqlite3.Database("./db/db.db", err =&gt; {<br>  if (err) {<br>    console.error(err.message);<br>  }<br>});<br>//set up the network we would like to connect to. in this case test net.<br>const TestNet = bitcoin.networks.testnet;<br>//build the query<br>let sql = `SELECT * FROM keys where processed = 1 and swept = 0 limit 0,1`;<br>//run the query<br>db.all(sql, [], (err, rows) =&gt; {<br>  if (err) {<br>    throw err;<br>  }<br>  rows.forEach(row =&gt; {<br>    //get the address<br>    var address = row.address;<br>    //get the private key<br>    var privateKey = row.privatekey;</span><span id="9328" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">block_io.get_transactions(<br>      { type: "received", addresses: address },<br>      function(error, data) {<br>        //get the tx transaction id<br>        var txid = data.data.txs[0].txid;<br>        //get the amount in the transaction<br>        let amountReceived = data.data.txs[0].amounts_received[0].amount;<br>        //estimate the fee<br>        block_io.get_network_fee_estimate(<br>          { amounts: amountReceived, to_addresses: process.env.toaddress },<br>          function(error2, data2) {<br>            //store the network fee.<br>            var networkfee = data2.data.estimated_network_fee;<br>            //init a new transaction<br>            let tx = new bitcoin.TransactionBuilder(TestNet);<br>            //get the WIF from the private key so we can sign the transaction later.<br>            let hotKeyPair = new bitcoin.ECPair.fromWIF(privateKey, TestNet);<br>            //work out the amount to send<br>            let amountToSend = amountReceived - networkfee;<br>            //turn the amount recieved into satoshis<br>            amountToSendSatoshi = amountToSend * 100000000;<br>            tx.addInput(txid, 0, 0xfffffffe);<br>            //note : this seems to do the fee on of its own accord.<br>            tx.addOutput(process.env.toaddress, amountToSendSatoshi);<br>            //sign the transaction with our private key<br>            tx.sign(0, hotKeyPair);<br>            //output it<br>            //note we have to figure out how to push this to the network and not use <a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a><br>            console.log(tx.build().toHex());<br>            // Set the headers<br>            var headers = {<br>              "User-Agent": "Super Agent/0.0.1",<br>              "Content-Type": "application/x-www-form-urlencoded"<br>            };<br>            // Configure the request<br>            var options = {<br>              url: "<a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a>",<br>              method: "POST",<br>              headers: headers,<br>              form: { tx: tx.build().toHex() }<br>            };<br>            // Start the request<br>            request(options, function(error, response, body) {<br>              //console.log(response)<br>              if (!error &amp;&amp; response.statusCode == 200) {<br>                // Print out the response body<br>                console.log(body);<br>                let sqldata = ["1", address];<br>                let sql = `UPDATE keys<br>                 SET swept = ?<br>                 WHERE address = ?`;<br>                db.run(sql, sqldata, function(err) {<br>                  if (err) {<br>                    return console.error(err.message);<br>                  }<br>                  console.log(`Row(s) updated: ${this.changes}`);<br>                });<br>              }<br>            });<br>          }<br>        );<br>      }<br>    );<br>  });<br>});<br>app.listen(3000, () =&gt; {});</span></pre><p id="6d5b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">What is going in the code above?</strong></p><p id="c316" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">We will skip to the new code check out the previous parts of this tutorial for an explanation on what "<strong class="lj lz"><a href="http://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> is etc.</p><p id="d591" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The first new thing you will see is we have included the package called "<strong class="lj lz"><a href="https://www.npmjs.com/package/request" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">request</a>"</strong> this is so we can post to the signing service later.</p><pre class="mj mk ml mm mn dv ge df"><span id="238d" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">var request = require('request');</span></pre><p id="8bc7" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">We have also set a new environment variable which holds the address of the "<a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a> <strong class="lj lz"><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">wallet</a>"</strong>. At the moment this is just one address but we could create a new address for each transaction (and we will) we could interface with our "<a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong>hardware wallet</strong></a>" and generate an address (and we will). There are a number of things we can do here and will be looking to make this more secure and private later.</p><pre class="mj mk ml mm mn dv ge df"><span id="a464" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">process.env.toaddress</span></pre><p id="08a4" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we are pulling out all of the processed payments from the table. A processed payment basically means that the monitor script has picked up this payment as it has been "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Confirmation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">confirmed</a>"</strong> in the "<strong class="lj lz"><a href="https://en.wikipedia.org/wiki/Blockchain" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">blockchain</a>"</strong>.</p><p id="2653" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note we are storing the private keys in the database just to make this part of the tutorials easy to understand. In the future, we will refactor this so the private keys are stored by the "<strong class="lj lz"><a href="https://bitcoin.org/en/full-node" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">fullnode</a>"</strong> and secured by your "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Passphrase_generation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">passphrase</a>"</strong> (as they should be)</p><pre class="mj mk ml mm mn dv ge df"><span id="aa2b" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">let sql = `SELECT * FROM keys where processed = 1 and swept = 0 limit 0,1`;<br>//run the query<br>db.all(sql, [], (err, rows) =&gt; {<br>  if (err) {<br>    throw err;<br>  }<br>  rows.forEach(row =&gt; {});<br>});</span></pre><p id="ff92" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">After that, we grab the address and "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Private_key" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">private key</a>"</strong> from the database.</p><pre class="mj mk ml mm mn dv ge df"><span id="f0d4" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">var address = row.address;<br>//get the private key<br>var privateKey = row.privatekey;<br>block_io.get_transactions({ type: "received", addresses: address }, function(<br>  error,<br>  data<br>) {});</span></pre><p id="47bf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to use this address to contact "<strong class="lj lz"><a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> and get the transaction information. Note we are storing the "<strong class="lj lz"><a href="https://bitcoin.org/en/glossary/txid" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">txid</a>"</strong> and amount as we are about to use this estimate the fee and sign the transaction.</p><pre class="mj mk ml mm mn dv ge df"><span id="a227" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">block_io.get_transactions({ type: "received", addresses: address }, function(<br>  error,<br>  data<br>) {<br>  //todo : check for no transactions<br>  //console.dir(data, { depth: null });<br>  //get the tx transaction id<br>  var txid = data.data.txs[0].txid;<br>  //get the amount in the transaction<br>  let amountReceived = data.data.txs[0].amounts_received[0].amount;<br>});</span></pre><p id="790b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to get the estimated network fee from "<strong class="lj lz"><a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">block.io</a>"</strong></p><pre class="mj mk ml mm mn dv ge df"><span id="7fda" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">block_io.get_network_fee_estimate(<br>  { amounts: amountReceived, to_addresses: process.env.toaddress },<br>  function(error2, data2) {<br>    //store the network fee.<br>    var networkfee = data2.data.estimated_network_fee;<br>  }<br>);</span></pre><p id="a629" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to create and sign a "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Transaction" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">transaction</a>"</strong>. We do this by using the transaction builder to work out the amount send and sign it. Note this was one of the hardest things to do out of all the steps so if this does not immediately click do not worry, it will eventually.</p><pre class="mj mk ml mm mn dv ge df"><span id="f472" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">//init a new transaction<br>let tx = new bitcoin.TransactionBuilder(TestNet);<br>//get the WIF from the private key so we can sign the transaction later.<br>let hotKeyPair = new bitcoin.ECPair.fromWIF(privateKey, TestNet);<br>//work out the amount to send<br>let amountToSend = amountReceived - networkfee;<br>//turn the amount recieved into satoshis<br>amountToSendSatoshi = amountToSend * 100000000;<br>tx.addInput(txid, 0, 0xfffffffe);<br>tx.addOutput(process.env.toaddress, amountToSendSatoshi);<br>//sign the transaction with our private key<br>tx.sign(0, hotKeyPair);</span></pre><p id="770c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The next thing we want to do is "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Transaction_broadcasting" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">broadcast</a>"</strong> this transaction to the network. We are using blockchain.info tool which can be found "<strong class="lj lz"><a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">here</a>"</strong>. There are many of these tools and they all do the same thing and yes we will be doing this ourselves once we upgrade to a "<strong class="lj lz"><a href="https://bitcoin.org/en/full-node" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">fullnode</a>"</strong>.</p><p id="f0a9" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Lastly, we update the database so we do not have to process this entry again.</p><pre class="mj mk ml mm mn dv ge df"><span id="0308" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">// Set the headers<br>   var headers = {<br>       'User-Agent':       'Super Agent/0.0.1',<br>       'Content-Type':     'application/x-www-form-urlencoded'<br>   }</span><span id="8507" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">// Configure the request<br>var options = {<br>  url: "<a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a>",<br>  method: "POST",<br>  headers: headers,<br>  form: { tx: tx.build().toHex() }<br>};<br>// Start the request<br>request(options, function(error, response, body) {<br>  if (!error &amp;&amp; response.statusCode == 200) {<br>    // Print out the response body<br>    console.log(body);<br>    let sqldata = ["1", address];<br>    let sql = `UPDATE keys<br>                 SET swept = ?<br>                 WHERE address = ?`;</span><span id="b384" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">db.run(sql, sqldata, function(err) {<br>      if (err) {<br>        return console.error(err.message);<br>      }<br>      console.log(`Row(s) updated: ${this.changes}`);<br>    });<br>  }<br>});</span></pre><p id="e322" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">That’s it we now have a “server” which allows us to generate an address, monitor the blockchain for payment and finally move the funds to "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">cold storage</a>"</strong>, neat. Let’s test it, shall we?</p><h2 id="1904" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step 1: Generate an address</h2><p id="c6ba" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">go to your terminal client and type and navigate to the directory with your code and type.</p><pre class="mj mk ml mm mn dv ge df"><span id="762f" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node generate.js</span></pre><p id="830b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">You will be presented with an address in the console (as shown in the screenshot below).</p><p id="b33a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note, it will be a different address than the in the screenshot obviously.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-2xl.png 1600w" alt="" width="778" height="64"></figure><p data-selectable-paragraph="">Copy this and load "<a href="https://bitcoin.org/en/download" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">bitcoin-qt</a>" and send some Bitcoin to this address. As shown below.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-2xl.png 1600w" alt="" width="3334" height="586"></figure><p id="88bf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Let's see if it is on the network. You can use a blockchain explorer to monitor the status of the transaction. An example of a blockchain explorer with our address can be found "<strong class="lj lz"><a href="https://live.blockcypher.com/btc-testnet/address/muSjmRdrwhjxpXFa8BBEd3BduGvh7YEYwX/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">here</a>"</strong> as shown in the screenshot below.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-2xl.png 1600w" alt="" width="2839" height="1719"></figure><p id="3b85" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Because this is a public blockchain anyone can write a block explorer. In fact, this is essentially what we have done with “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a><strong class="lj lz">”</strong> it is a simple, hyper-focused blockchain explorer.</p><h2 id="0fbe" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step2: Monitor for the confirmed transaction</h2><p id="a31c" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">Now let’s run monitor by going to the terminal (stopping generate.js if it still running by pressing control &amp; c) and type the following:</p><pre class="mj mk ml mm mn dv ge df"><span id="c43f" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node monitor.js</span></pre><p id="fb7c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">When you do this you will see the following (screenshot below). What is happening here is that “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a>” checking the blockchain to make sure the payment has been <a href="https://en.bitcoin.it/wiki/Confirmation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">confirmed</strong></a>. This takes a period of time, usually 10 minutes for each confirmation and you free to set whatever confirmation threshold you want (3 confirmations is normal). Note you could also do something when it is in it’s pending state. Though in the case we have not.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-2xl.png 1600w" alt="" width="967" height="933"></figure><p data-selectable-paragraph=""><strong class="lj lz">“</strong><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">Monitor.js</strong></a><strong class="lj lz">” </strong>is on a timer that is set to check every 3 seconds, again you can set this to whatever time you want to. Eventually, you will see a confirmation (as shown in the screenshot below) and you will be able to go ahead and do the last step which moves the funds to our <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">wallet</strong></a> using “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/sweep.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">sweep.js</strong></a><strong class="lj lz">”</strong></p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-2xl.png 1600w" alt="" width="1015" height="336"></figure><p id="7943" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">To move the funds back again go to terminal and type the following. Note make sure the funds have confirmed or this will not work.</p><h2 id="647b" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step3: Move funds back to cold storage</h2><pre class="mj mk ml mm mn dv ge df"><span id="2007" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node sweep.js</span></pre><p id="e95e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This will sign a transaction and move it back to "<strong class="lj lz"><a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">cold storage</a>" </strong>and you will see the following output which is the hex transaction as shown in the screenshot below</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-2xl.png 1600w" alt="" width="2886" height="121"></figure><p id="3873" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Again we can monitor this transaction with a blockchain explorer we could also modify “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a>” to check these payments (and we will later) but after about the same period of time as it took to receive the payment you will see this transaction has been confirmed and is now in your "<a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a><strong class="lj lz"> </strong><strong class="lj lz"><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">wallet</a>"</strong>.</p><p id="fc5c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note for the purposes of this demo I have used "<strong class="lj lz"><a href="https://bitcoin.org/en/download" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">bitcoin-qt</a>"</strong> (later renamed to Bitcoin Core) to send these funds back to but I recommend you use a hardware wallet such as a "<strong class="lj lz"><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">ledger nano s</a>"</strong>.</p><p id="73ca" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">As you can see from the screenshot below that the funds are now safely in our wallet.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-2xl.png 1600w" alt="" width="2279" height="942"></figure><p data-selectable-paragraph=""> </p><h1 id="4ea9" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Conclusion</h1><p id="c76f" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">Now we pretty much have a functional bitcoin payment server written in “<a href="https://nodejs.org/en/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">node.js</strong></a>”. Of course, you would never use this in production we have to do a lot more to it for that to be the case. It does, however, serve its purpose of showing how to do all the major components of the Bitcoin network and how to use them to process Bitcoin transactions.</p><p id="6888" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">In the next tutorial, we are going to start to turn this into a microservice architecture with a rest API and build a front end to take advantage of the code we have written in the previous tutorials. You can check out a demo "<strong class="lj lz"><a href="https://cryptoskillz.com/" target="_blank" rel="noopener noreferrer">here</a>"</strong> and if you would like to check out the active branch then go "<strong class="lj lz"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/www" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">here</a>"</strong>.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on October 10, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/monitor-blockchain-for-payment.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xs.jpeg" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Monitor blockchain for payment</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/www-and-modularisation.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>WWW and modularisation</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/7/responsive/1_KOjqZHotBNn9-PIMA9XTHQ-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/7/responsive/1_KOjqZHotBNn9-PIMA9XTHQ-xs.jpeg" data-expand="300" alt=""></a></div></nav></footer></article><div class="banner banner--after-post"><script type="text/javascript" src="https://cryptoskillz.com/srcrypto/prod/cdn/js/sr.js"></script><script type="text/javascript">SR.init(["https://ecslive.cryptoskillz.com/",15,"https://cryptoskillz.com/srcrypto/prod/cdn/theme/","39",0,"GB",0,""]);</script></div></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(5)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(26)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(9)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li><li><a href="https://cryptoskillz.com/blog/wink/">wink</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>