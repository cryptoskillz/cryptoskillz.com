<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Integrating 3rd party Lightning - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/integrating-3rd-party-lightning.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/integrating-3rd-party-lightning.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Integrating 3rd party Lightning"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/18/1_a22cZdqrqt3k_KXL4CcfDg-xs.jpeg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/integrating-3rd-party-lightning.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/integrating-3rd-party-lightning.html"},"headline":"Integrating 3rd party Lightning","datePublished":"2019-01-23T12:29","dateModified":"2019-10-10T23:50","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/18/1_a22cZdqrqt3k_KXL4CcfDg-xs.jpeg","height":453,"width":300},"description":"IntroductionThis guide aims to program a website to accept \"Bitcoin\". In the previous tutorial, We added \"strike\" as a standalone project. This time we are going to fully integrate it into our \"server\" and \"CDN\" (\"sr.js\") The SQL in this release changed a lot as&hellip;","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2019-10-11T12:36">October 11, 2019</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(453/300 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_a22cZdqrqt3k_KXL4CcfDg-xs-2xl.jpeg 1600w" data-sizes="auto" alt=""><figcaption>Photo by Brandon Morgan on Unsplash</figcaption></figure><header class="u-header post__header"><h1>Integrating 3rd party Lightning</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2019-01-23T12:29">January 23, 2019 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><article><div><section class="jd je jf jg jh"><div class="ae ji ab dn v w"><h1 id="8272" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Introduction</h1><p id="ad64" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This guide aims to program a website to accept "<a href="https://bitcoin.org/en/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">Bitcoin</strong></a>". In the previous tutorial, We added "<a href="https://strike.acinq.co/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">strike</strong></a>" as a standalone project. This time we are going to fully integrate it into our "<a href="https://github.com/cryptoskillz/ECS/tree/strikeintegration/server" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">server</strong></a>" and "<a href="https://github.com/cryptoskillz/ECS/tree/strikeintegration/cdn" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">CDN</strong></a>" ("<a href="https://github.com/cryptoskillz/ECS/blob/strikeintegration/cdn/js/sr.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">sr.js</strong></a>")</p><p data-selectable-paragraph=""> </p><h1 id="8136" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The SQL</h1><p id="e9c5" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The SQL in this release changed a lot as we are now offering multipile payment types we could no longer rely on the BTC address to be the join across the tables. Also because a lightning payment requires an amount which we do not always have we cannot cache a lightning address the way we do a Bitcoin one.</p><p id="3c3f" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">As a result, we implemented a session which is based on "<a href="https://www.npmjs.com/package/uuid" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">uuidv1</strong></a>"</p><p id="7e9c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We changed the name of the session table to "usersessions" added a session id as well as changed address into 2 fields "btcaddress" and "lightaddress". Note we could have used an address lookup table here to manage many types, however, we will most likely only support BTC and Lightning(if this changes we can easily implement this change)</p><p id="feb7" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We also added a timestamp so we know when the session was created in case we ever decided to add features such as cart abandonment etc.</p><pre class="ke kf kg kh ki dv ge df"><span id="5176" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">CREATE TABLE `usersessions` (<br> `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `processed` INTEGER DEFAULT 0,<br> `swept` INTEGER DEFAULT 0,<br> `userid` INTEGER,<br> `net` INTEGER DEFAULT 1,<br> `amount` TEXT DEFAULT 0,<br> `paymenttype` INTEGER DEFAULT 1,<br> `sessionid` TEXT,<br> `sessiontime` INTEGER,<br> `btcaddress` TEXT,<br> `lightaddress` TEXT<br>);</span></pre><p id="3243" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The only other changes we made was to replace the "address" join in other fields and use "sessoinid" as well.</p><h1 id="24b6" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The Code</h1><p id="9cf2" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The branch for the code for this release can be found "<a href="https://github.com/cryptoskillz/ECS/tree/strikeintegration" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">here</strong></a>"</p><h2 id="4cea" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph="">WWW</h2><p id="592e" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We made one small change to the init function and that as to pass in the ability to turn Lightning on or off.</p><pre class="ke kf kg kh ki dv ge df"><span id="79e9" class="mm lg bf av mn b dz mo mp l mq" data-selectable-paragraph="">&lt;script type="text/javascript"&gt;<br>       /*<br>          0 = server url<br>          1 = animated<br>          2 = quantity count<br>          3 = cdn url<br>          4 = uid<br>          5 = theme<br>          6 = billing address <br>          7 = shipping address<br>          8 = start country<br>          9 = lighting enabled<br>       */</span><span id="8fcb" class="mm lg bf av mn b dz nc nd ne nf ng mp l mq" data-selectable-paragraph=""><br>       //local<br>SR.init([<br>"<a href="http://127.0.0.1:3030/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3030/</a>",<br>false,<br>15,<br>"<a href="http://127.0.0.1:8081/cdn/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8081/cdn/</a>",<br>"3",<br>"",<br>1,<br>1,<br>"GB",<br>1<br>]);</span></pre><h2 id="af55" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph="">CDN / SERVER</h2><p id="a1c8" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Most the changes this time were in "<a href="https://github.com/cryptoskillz/ECS/blob/strikeintegration/cdn/js/sr.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">SR.js</strong></a>" the "<a href="https://github.com/cryptoskillz/ECS/tree/strikeintegration/server" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">server</strong></a>" was obviously updated to handle the new requests. As I said we are no longer going to be listing all the code (as it is getting too long to read in a blog format) we will cover the salient updates.</p><p id="ce2e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Session Generation</strong></p><p id="defa" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We now store a cookie in a session which means everytime you now do a hard refresh you call the server and create a new session. This not only speeds things up allows us to have multiple payment types in one session. Note we did not retrieve the cart contents on a hard refresh but we will do that in a future update.</p><p id="322d" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">It also has the added bonus of giving us a preloader (in a way) which use (at present) to generate a BTC address but can make it do a lot. One idea as mentioned above is to send the user cart so we maintain cart integrity over time, hard refreshes etc.</p><p id="8210" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Multipile payment types</strong></p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/18/responsive/1_6Nxhy4i_b5kAX61HTSoDeg-2xl.png 1600w" alt="" width="1670" height="991"></figure><p id="714e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Now we have Lightning and Bitcoin to chose from this branches a number of UX flow and if we added more the complexity would rise more so we had to refactor the whole address/generation functionality on both the CDN and SERVER.</p><p id="3a71" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Server webhooks</strong></p><p id="82ba" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We had a lot of code in server webhooks which did not have to be there so we removed it and refactored the function.</p><p id="b928" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Misc</strong></p><p id="3822" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We fixed numerous bugs and refactored how a lot of the server code is working. It is a lot more friendly to work with now.</p><h2 id="417c" class="mm lg bf av au el mr ms mt mu mv mw mx my mz na nb" data-selectable-paragraph="">Admin</h2><p id="6887" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We made minimal changes to the admin, mainly the being able to deal with Lighting payments and the new session code. In a future update, we will focus exclusively on the admin as there is a lot we can be adding to improve this section.</p><p data-selectable-paragraph=""> </p><h1 id="e6de" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Conclusion</h1><p id="6c4c" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This now gives us a pretty decent platform to deal with Bitcoin and Lightning payments. Of course, we are going to replace "<a href="https://strike.acinq.co/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">strike</strong></a>" at some point with code completely under our control but this is adequate for now.</p><p id="336a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next time around we will either clean up all the code and do a full regression in which case there will be no tutorial or implement an address cache method to be able to run ECS without any BTC node running on the server.</p></div></section></div></article><div class="eb ec ed m ee ef eg eh ei e" data-test-id="post-sidebar"> </div></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on October 10, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/adding-3rd-party-lightning.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/17/responsive/1_o-phpGJ9Fmh13YqxCs8y3A-xs-xs.jpeg" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Adding 3rd party Lightning</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/the-casa-node.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>The Casa Node</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/19/responsive/1_UervJWdfE4srKFWkx6kIoA-xs.png" data-srcset="https://cryptoskillz.com/blog/media/posts/19/responsive/1_UervJWdfE4srKFWkx6kIoA-xs.png" data-expand="300" alt=""></a></div></nav></footer></article></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(3)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(24)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(8)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li><li><a href="https://cryptoskillz.com/blog/wink/">wink</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>