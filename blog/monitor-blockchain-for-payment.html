<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Monitor blockchain for payment - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/monitor-blockchain-for-payment.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/monitor-blockchain-for-payment.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Monitor blockchain for payment"><meta property="og:image" content="https://cryptoskillz.com/blog/media/website/logo.png"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/monitor-blockchain-for-payment.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=58acac63961d23abccded091eaca6989"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/monitor-blockchain-for-payment.html"},"headline":"Monitor blockchain for payment","datePublished":"2018-09-24T18:12","dateModified":"2019-09-10T14:42","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685},"description":"<figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/5/1_aPTfDYe3RFisRnvYO5xIpQ.jpeg\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-2xl.jpeg 1600w\"  alt=\"\" width=\"640\" height=\"480\"></figure>\n<p> </p>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz","logo":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685}}}</script><script src="https://cryptoskillz.com/blog/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script></head><body><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4710117865976591" data-ad-slot="8475194151" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://cryptoskillz.com/blog/"><img src="https://cryptoskillz.com/blog/media/website/logo.png" alt="cryptoskillz"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li><li class="has-submenu"><a href="https://cryptoskillz.com/blog/ecs/" target="_self" aria-haspopup="true">BLOG</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://cryptoskillz.com/blog/ecs/" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blog/fullnode/" target="_self">FULLNODE</a></li><li><a href="https://cryptoskillz.com/blog/cyphernode/" target="_self">CYPHERNODE</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2018-09-24T18:12">September 24, 2018</time></div><h1>Monitor blockchain for payment</h1></div></header></div><div class="wrapper post__entry"><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/5/1_aPTfDYe3RFisRnvYO5xIpQ.jpeg" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/5/responsive/1_aPTfDYe3RFisRnvYO5xIpQ-2xl.jpeg 1600w" alt="" data-aspectratio="1.333333" width="640" height="480"></figure><p> </p><h1 id="ce3c" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Introduction</h1><p id="dfde" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous "<strong><a href="https://cryptoskillz.com/blog/generate-a-btc-address.html">article</a></strong>", we replaced "<strong class="lj lz"><a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> with custom "<strong class="lj lz"><a href="https://nodejs.org/en/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">node.js</a>"</strong> code.</p><p id="82ab" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Now we successfully generated an address and sent some Bitcoin to it we have to monitor the blockchain and monitor it so we know that the payment has been made and "<strong class="lj lz"><a href="https://www.buybitcoinworldwide.com/confirmations/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">confirmed</a>"</strong>.</p><p data-selectable-paragraph=""> </p><h1 id="2e4a" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The SQL</h1><p id="fa99" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We have added a field called processed to the database so that when “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/monitor/generate.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">generate.js</strong></a>” is run and a record has been added to the database the <strong class="lj lz">processed</strong> field is set to 0 to stop it from being reprocessed.</p><pre class="mf mg mh mi mj dv ge df"><span id="9ae3" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">CREATE TABLE "keys" <br>( `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `privatekey` TEXT,<br> `publickey` TEXT,<br> `address` TEXT,<br> `processed` INTEGER DEFAULT 0<br>)</span></pre><h1 id="76f1" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The Code</h1><p id="ff28" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The latest code can be found "<strong class="lj lz"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/monitor" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">here</a>"</strong> and it is listed below.</p><pre class="mf mg mh mi mj dv ge df"><span id="7f75" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">//load express<br>const express = require("express");<br>//load body parser<br>const bodyParser = require("body-parser");<br>//set up block.io<br>var BlockIo = require("block_io");<br>var version = 2; // API version<br>//set up block.io<br>var block_io = new BlockIo(<br>  process.env.blockiokey,<br>  process.env.blockiosecret,<br>  version<br>);<br>const sqlite3 = require("sqlite3").verbose();<br>//init it<br>const app = express();<br>//open a database connection<br>let db = new sqlite3.Database("./db/db.db", err =&gt; {<br>  if (err) {<br>    console.error(err.message);<br>  }<br>});<br>//check var<br>var checkIt;<br>//set an interval to 10 seconds<br>checkIt = setInterval(checkForPayment, 3000);<br>//function to check for payment<br>function checkForPayment() {<br>  //get the entrys<br>  let sql = `SELECT * FROM keys where processed = 0 `;</span><span id="8aaa" class="mk kv bf av ml b dz mp mq mr ms mt mn l mo" data-selectable-paragraph="">db.all(sql, [], (err, rows) =&gt; {<br>    if (err) {<br>      throw err;<br>    }<br>    rows.forEach(row =&gt; {<br>      var address = row.address;<br>      block_io.get_address_balance({ address: address }, function(error, data) {<br>        //some kind of error, deal with it (literately )<br>        if (error) return console.log("Error occurred:", error.message);<br>        //store the balance<br>        var balance = data.data.available_balance;<br>        //store the pending balance<br>        var pendingbalance = data.data.pending_received_balance;<br>        if (balance &gt; 0) {<br>          console.log("we got it");<br>          //update the database that the payment is successful<br>          let data = ["1", address];<br>          let sql = `UPDATE keys<br>                SET processed = ?<br>                WHERE address = ?`;<br>db.run(sql, data, function(err) {<br>            if (err) {<br>              return console.error(err.message);<br>            }<br>            console.log(`Row(s) updated: ${this.changes}`);<br>          });<br>        } else {<br>          if (pendingbalance &gt; 0) {<br>            console.log("awaiting confirmation for " + address);<br>          }<br>        }<br>      });<br>    });<br>  });<br>  console.log("finished checking");<br>}<br>app.listen(3000, () =&gt; {});</span></pre><p id="2a9a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">What is going in the code above?</strong></p><p id="71c3" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Most of this code is covered in the previous “<a class="cb bx lv lw lx ly" target="_blank" href="https://medium.com/bitcoin-e-commerce-development/using-bitcoin-to-accept-payments-part-2-421fe7803f34" rel="noopener noreferrer"><strong class="lj lz">tutorial</strong></a><strong class="lj lz">” </strong>so we are only going to cover the new code in this tutorial.</p><p id="1ad3" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">We are using environment variables to store the private information (such as our block.io API keys) you can find out how to set an env var "<strong><a class="cb bx lv lw lx ly" target="_blank" href="https://medium.com/ibm-watson-data-lab/environment-variables-or-keeping-your-secrets-secret-in-a-node-js-app-99019dfff716" rel="noopener noreferrer">here</a></strong>". We use mac and terminal so we set our env vars in the following manner. If you use some other configuration of hardware and software please adjust the code accordingly.</p><pre class="mf mg mh mi mj dv ge df"><span id="b9ea" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">export blockiokey=BLOCKIOKEY<br>export blockiosecret=BLOCKIOSECRET</span><span id="5f2b" class="mk kv bf av ml b dz mp mq mr ms mt mn l mo" data-selectable-paragraph="">BlockIo(process.env.blockiokey,process.env.blockiosecret, version);<br>const sqlite3 = require('sqlite3').verbose();</span></pre><p id="d688" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we start a timer so that and check the blockchain every 3 seconds. It would be more likely that we would set this to 1 minute but for development, this is a reasonable time.</p><pre class="mf mg mh mi mj dv ge df"><span id="3555" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">//check var<br>var checkIt;<br>//set an interval to 10 seconds<br>checkIt = setInterval(checkForPayment, 3000);</span><span id="4542" class="mk kv bf av ml b dz mp mq mr ms mt mn l mo" data-selectable-paragraph="">//function to check for payment<br>function checkForPayment() <br>{</span><span id="d0c4" class="mk kv bf av ml b dz mp mq mr ms mt mn l mo" data-selectable-paragraph="">}</span></pre><p id="d7c3" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we are run a SQL query to get all unprocessed transactions. Note we pull out the address as this is what we want to check for.</p><pre class="mf mg mh mi mj dv ge df"><span id="0300" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">//get the entrys <br> let sql = `SELECT * FROM keys where processed = 0 `;<br> <br> db.all(sql, [], (err, rows) =&gt; {<br>   if (err) {<br>     throw err;<br>   }<br>  rows.forEach((row) =&gt; {<br>     <br>     var address =  row.address;<br>   });<br> });</span></pre><p id="396c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we call the "<strong class="lj lz"><a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">bock.io</a>"</strong> API’s "<strong class="lj lz"><a href="https://block.io/api/simple/nodejs" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">getaddress balance</a>"</strong> function and process the results. As we only use each address once we can make some assumptions</p><p id="5130" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">1 It should never have a balance higher than we are looking for<br>2 It will always be the first transaction (0) <br>3 we are not going to do anything with pending balance <br>4 We are not going to do anything until it has been confirmed.</p><p id="8a4e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">To make a more robust code base we would check and deal with all of the above but for the sake of this simple tutorial, this is more than enough logic.</p><p id="ab73" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The last thing we do is update the table so that <strong class="lj lz">processed</strong> is equal to 1</p><pre class="mf mg mh mi mj dv ge df"><span id="95bc" class="mk kv bf av ml b dz mm mn l mo" data-selectable-paragraph="">block_io.get_address_balance({ address: address }, function(error, data) {<br>  //some kind of error, deal with it (literately )<br>  if (error) return console.log("Error occurred:", error.message);<br>  //store the balance<br>  var balance = data.data.available_balance;<br>  //store the pending balance<br>  var pendingbalance = data.data.pending_received_balance;<br>  //debug<br>  //console.log(balance);<br>  //console.log(pendingbalance);<br>  if (balance &gt; 0) {<br>    //update the database that the payment is successful<br>    let data = ["1", address];<br>    let sql = `UPDATE keys<br>                SET processed = ?<br>                WHERE address = ?`;</span><span id="c21a" class="mk kv bf av ml b dz mp mq mr ms mt mn l mo" data-selectable-paragraph="">db.run(sql, data, function(err) {<br>      if (err) {<br>        return console.error(err.message);<br>      }<br>      console.log(`Row(s) updated: ${this.changes}`);<br>    });<br>  } else {<br>    console.log("payment not received for " + address);<br>    if (pendingbalance &gt; 0) {<br>      console.log("awaiting confirmation for " + address);<br>    }<br>  }<br>});</span></pre><h1 id="2789" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Conclusion</h1><p id="711d" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">And that’s it. Very simply isn't it? we have checked the blockchain for the payment and once it has been confirmed we simply updated the database. However, we will add more functionality in the future such as sending emails to clients updating back-office systems etc.</p><p id="4ab2" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Also, this is the script that relies extensively on the block.io as a 3rd party and of course we want to be our own bank so in the future we will replace this by using our own "<strong class="lj lz"><a href="https://bitcoin.org/en/full-node" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">fullnode</a>"</strong> in a later tutorial.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 10, 2019</p><ul class="post__tag"><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a></li></ul><div class="post__share"><a href="https://twitter.com/share?url=https%3A%2F%2Fcryptoskillz.com%2Fblog%2Fmonitor-blockchain-for-payment.html&amp;via=crypto_skillz&amp;text=Monitor%20blockchain%20for%20payment" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span></a></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://cryptoskillz.com/blog/generate-a-btc-address.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Generate a BTC address</a></div><div class="post__nav-next"><a href="https://cryptoskillz.com/blog/move-payment-to-cold-storage.html" class="invert post__nav-link" rel="next"><span>Next</span> Move payment to cold storage </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://cryptoskillz.com/blog/monitor-blockchain-for-payment.html';
               		this.page.identifier = '5';
                       this.page.title = ' Monitor blockchain for payment';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://cryptoskillz-1.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__social"><a href="crypto_skillz" aria-label="Twitter"><svg><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg></a></div><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static CMS</a></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'overlay',
        animationSpeed: 300,
        submenuWidth: 240,
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>