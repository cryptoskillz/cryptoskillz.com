<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Part 10: Address 101 - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/address-101.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/address-101.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Part 10: Address 101"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/12/1_6p3MzX8zoEMi_Rjg53Wupg.jpeg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/address-101.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/address-101.html"},"headline":"Part 10: Address 101","datePublished":"2018-10-22T12:11","dateModified":"2019-10-10T23:37","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/12/1_6p3MzX8zoEMi_Rjg53Wupg.jpeg","height":5472,"width":3648},"description":"IntroductionThis guide aims to program a website to accept Bitcoin. In the last tutorial (\"part 9\"), we replaced all of our 3rd party code in favour of using fullnode to give us as total sovereignty. In this part, we are going to be looking into&hellip;","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2019-10-11T12:36">October 11, 2019</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(5472/3648 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-2xl.jpeg 1600w" data-sizes="auto" alt=""><figcaption>Photo by Timothy Eberly on Unsplash</figcaption></figure><header class="u-header post__header"><h1>Part 10: Address 101</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2018-10-22T12:11">October 22, 2018 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><h1 id="1a18" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Introduction</h1><p id="c7e7" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the last tutorial ("<strong><a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html">part 9</a></strong><strong class="lu mg">"</strong>), we replaced all of our 3rd party code in favour of using fullnode to give us as total sovereignty. In this part, we are going to be looking into addresses, how they function, the way they work and what we have to look for whilst using them.</p><p id="6d83" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This is part is not required to run a Bitcoin E-Commerce server, See it as extra credit for the people who like to get under the hood and deep dive subjects.</p><h1 id="f889" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">What is an address?</h1><p id="4942" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">A Bitcoin "<strong><a href="https://en.bitcoin.it/wiki/Address" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">address</a>"</strong> is a single-use token. Like an e-mail address, you can send bitcoins to a person by sending bitcoins to one of their addresses. However, unlike e-mail addresses, people have many different Bitcoin addresses and a unique address should be used for each transaction.</p><p id="d9bd" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">There are 3 address types we will cover in this tutorial.</p><p id="15ff" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><a href="https://en.bitcoin.it/wiki/Transaction#Pay-to-PubkeyHash" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">P2PKH</strong></a><strong class="lu mg">: Legacy<br></strong>This was the original address. We will not spend to much time discussing this as I am going to be using SegWit for all transactions going forward. If you want to use this address you are free to do and please make sure to change the code accordingly.</p><p id="ba0d" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><a href="http://script/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">P2SH</strong></a><strong class="lu mg">: Current<br></strong>This is current address in use called SegWit (shot for segregated witness)</p><p id="d2ec" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><a href="https://en.bitcoin.it/wiki/Bech32" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">Bech32</strong></a><strong class="lu mg">: Future <br></strong>This is a "<strong><a href="https://en.bitcoin.it/wiki/Segwit" target="_blank" rel="noopener noreferrer">SegWit</a></strong>" "<strong><a href="https://en.bitcoin.it/wiki/Address" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">address</a>"</strong> format specified by "<strong><a href="https://en.bitcoin.it/wiki/BIP_0173" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">BIP 0173</a>"</strong>. This address format is also known as “bc1 addresses”.</p><p id="793c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Network topology</strong></p><p id="f300" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Below is an excellent chart showing how the address flow in the Bitcoin network.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-xs.jpeg" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_4d5H3buq7gWZtwZuge3rnw-2xl.jpeg 1600w" alt="" width="3021" height="4000"></figure><p id="eb8c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We will be focusing on <strong class="lu mg">P2SH</strong> or <strong class="lu mg">current</strong> as we will be referring to it in the tutorial (for a complete list of addresses click "<strong><a href="https://en.bitcoin.it/wiki/List_of_address_prefixes" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong>) as this is the current standard address to use. The <strong class="lu mg">legacy</strong> was the previous address type and <strong class="lu mg">future</strong> address type is not supported across the network as yet.</p><p id="b9b8" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Using a Current address (Segwit)</strong></p><p id="02f2" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Let us look at how this relates to our "<strong><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/9-fullnode-part-2" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">code</a>"</strong>. When we call our REST method “<strong class="lu mg">/api/address”</strong> you will see this, in turn, calls the <strong class="lu mg">getNewAddress</strong> function which returns us an address (shown below).</p><pre class="ke kf kg kh ki dv ge df"><span id="56dd" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.getNewAddress(process.env.walletaccount).then(address =&gt; {<br>     <br>});</span><span id="d0cd" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//returns: 2Mx1TYm5J87WQAuqo4SBMQZJZLRPNjg716N</span></pre><p id="f3a8" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This address starts with a 2 that tells us this is a <strong class="lu mg">current</strong> (Segwit address) on the <strong class="lu mg">Test Network</strong>. If we were on the <strong class="lu mg">Main Network</strong> then it would start with a 3.</p><p id="6fb7" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We could have passed another paramater to this functions called address type which would generate a <strong class="lu mg">legacy</strong> or <strong class="lu mg">future</strong> address type.</p><p id="730c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">There are a number of different address types used in Bitcoin but as I said above we are only going to focus on the <strong class="lu mg">current</strong> address type, however, you can find the full list "<strong><a href="https://en.bitcoin.it/wiki/List_of_address_prefixes" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong> if you would like extra credit.</p><p id="1e12" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Once we have sent some funds to the address then we have to go ahead and sweep them, we do that using the functions below.</p><h2 id="8ea6" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/listunspent/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">listUnspent</a></h2><p id="ec0d" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The <strong class="lu mg">listUnspent</strong> function returns a list of unspent transactions when we call it we pass in 3 parameters.</p><p id="b118" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Minimum Confirmations<br></strong>The minimum number of confirmations the transaction containing an output must have in order to be returned. Use 0 to return outputs from unconfirmed transactions. The default is 1.</p><p id="2abd" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Maximum Confirmations<br></strong>The maximum number of confirmations the transaction containing an output may have in order to be returned. The default is 9999999.</p><p id="bf58" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">Addresses<br></strong>A JSON array of bitcoin addresses. If you do not pass an address it will return all the unspent transactions for the default account.<br>Note, when this account functionality is fully deprecated in the next version it is unknown (to me) how this function will change.</p><p id="97ce" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">There are various optional parameters we can also pass but these are beyond the scope of what we aim out to achieve with this tutorial, you can find these parameters by clicking "<strong><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/listunspent/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong> for more information.</p><p id="298f" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">When we call the <strong class="lu mg">listUnspent</strong> function, it returns an array of the unspent transactions and as this is <strong class="lu mg">current</strong> (SegWit) address it also returns a redeemScript and scriptPubKey for each of these (which we will use later).</p><pre class="ke kf kg kh ki dv ge df"><span id="111b" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.listUnspent(1,9999999,["2Mx1TYm5J87WQAuqo4SBMQZJZLRPNjg716N"]).then(result =&gt; {<br> console.log(result);<br>});</span><span id="12bf" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//results<br>[ { txid:<br>'eacd42149861188d3de61a36af3663c6988c5d8bc51d3881d3e56b6ce913a22d',<br>vout: 0,<br>address: '2N1j6CXWE24rWXC7P1GRdVeirVcTBPN8QWM',<br>label: 'woot',<br>redeemScript: '0014207f99f926c27456d9b91eac84f016d5896f91ac',<br>scriptPubKey: 'a9145d0626be3027c37d9c51b7c6a2a5f684e35a733487',<br>amount: 0.02,<br>confirmations: 8,<br>spendable: true,<br>solvable: true,<br>safe: true } <br>]</span></pre><p id="f08f" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Let’s quickly break down this object and see what each of the returned items is and what it is used for.</p><p id="1982" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">txid</strong>:<br>The transaction id, we use this later to make sure we can sign and broadcast the transaction correctly.</p><p id="7e19" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">vout</strong>: <br>vout refers to the index of the output address in question. The index starts from 0. So for example, if a <strong class="lu mg">tx</strong> has 10 output addresses, the <strong class="lu mg">vouts</strong> for the addresses would be from 0–9.<br>Note in our usage the vout should always be 0 as we never reuse an address.</p><p id="f3ee" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">address</strong>:<br>The Bitcoin address.</p><p id="d2ca" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">label</strong>:<br>The associated label that was set when the Bitcoin was spent. This is an optional paramater so it can be blank.</p><p id="7950" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><a href="https://bitcoin.org/en/glossary/redeem-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">redeemScript</strong></a><strong class="lu mg">:<br></strong>Similar to a "<strong class="lu mg"><a href="https://bitcoin.org/en/glossary/pubkey-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">scriptPubKey</a>"</strong><strong class="lu mg">. </strong>One copy of it is hashed to create a "<strong><a href="https://bitcoin.org/en/glossary/p2sh-address" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">P2SH address</a>"</strong> (used in an actual "<strong><a href="https://bitcoin.org/en/glossary/pubkey-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">pubkey script</a>"</strong>) and another copy is placed in the spending "<strong><a href="https://bitcoin.org/en/glossary/signature-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">signature script</a>"</strong> to enforce its conditions.</p><p id="806a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><a href="https://bitcoin.org/en/glossary/pubkey-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">scriptPubKey</strong></a>:<br>A script included in "<strong><a href="https://bitcoin.org/en/glossary/output" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">outputs</a>"</strong> which hold the conditions to spend the BTC. Data for fulfilling the conditions can be provided in a "<strong><a href="https://bitcoin.org/en/glossary/signature-script" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">signature script</a>"</strong>.</p><p id="d186" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">amount</strong>:<br>the transaction output amount in BTC</p><p id="c7ba" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">confirmations</strong>: <br>“confirmations”: n, (numeric) The number of confirmations</p><p id="e00c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">spendable</strong>:<br>Whether we have the private keys to spend this output</p><p id="536a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">solvable</strong>:<br>Whether we know how to spend this output, ignoring the lack of keys</p><p id="a46e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">safe</strong>:<br>Whether this output is considered safe to spend. Unconfirmed transaction</p><p id="75e8" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Note, as we generate a new address for every transaction we should never have more than 1 item in this array if we do then it is most likely someone has sent us money in error and we may write some code to work with these "<strong><a href="https://en.wikipedia.org/wiki/Edge_case" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">edge cases</a>"</strong> later.</p><h2 id="6203" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/wallet/dumpprivkey/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="ch">dumpPrivKey</strong></a></h2><p id="832e" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The <strong class="lu mg">dumpPrivKey</strong> function call returns the wallet-import-format ("<strong><a href="https://bitcoin.org/en/glossary/wallet-import-format" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">WIP</a>"</strong>) private key corresponding to an address. (But does not remove it from the wallet.) We use it by passing the address into the function.<br>Note, if we have control of this address then it will return the private key otherwise it will produce an error.</p><pre class="ke kf kg kh ki dv ge df"><span id="d470" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.dumpPrivKey(req.query.address).then(pkey =&gt; {<br>});</span><span id="a9ce" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//returns<br>cSxwAZCdWqEkextHde9RGsZxP1nJ36yHmGobiWgHB3XH1yRxyzwUQ</span></pre><h2 id="0c9f" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/util/estimatesmartfee/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">estimateSmartFee</a></h2><p id="3ae3" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We use the <strong class="lu mg">estimateSmartFee</strong> function to calculate a fee amount. Once we have this amount we deduct it from the amount to send to the recipient address.</p><p id="4a59" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Needless to say, It is important we get this right as we do not want to be the guy in the image below, that is a $1,300,000 mistake at today's prices.</p><p id="a69a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">signRawTranaction also has a high fee check (set to 0.1 BTC) which will further stop us from making costly mistakes.</p><figure class="post__image"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-xs.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/12/responsive/1_Z_JYHsqcb8uHuWf-EcQxvA-2xl.png 1600w" alt="" width="2390" height="1380"></figure><p id="56d3" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">When we call the function we pass 1 parameter and that is the maximum number of blocks a transaction should have to wait before it is predicted to be included in a block. As you can see we set this to <strong class="lu mg">6 </strong>(never put this below 3). We can also pass a second parameter called <strong class="lu mg">feetype</strong> by default it is set to conservative and this is good enough for our usage.</p><pre class="ke kf kg kh ki dv ge df"><span id="b8b4" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.estimateSmartFee(6).then((fee) =&gt; {<br>});</span><span id="26d9" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//retturns<br>{ <br> feerate: 0.00001017,<br> blocks: 6 <br>}</span></pre><p id="4b7e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The <strong class="lu mg">feerate</strong> is what is of interest to us and we simply deduct this from the amount from the array returned from the <strong class="lu mg">listUnpsent</strong> function. This gives us the amount we want to send as shown below.</p><pre class="ke kf kg kh ki dv ge df"><span id="e46d" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">var amounttosend = result[0].amount - fee.feerate;</span></pre><p id="ba7b" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We will go into a deep dive in fees in a later tutorial but if you want to read about it now, click "<strong><a href="https://bitzuma.com/posts/making-sense-of-bitcoin-transaction-fees/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong> for an excellent article on the topic.</p><p id="8b06" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Note you will see a lot of documentation referencing a function called "<strong class="lu mg"><a href="http://chainquery.com/bitcoin-api/estimatefee/6" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">estimatefee</a>"</strong> this has now been depreciated and should not be used.</p><h2 id="5591" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/rawtransactions/createrawtransaction/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">createRawTransaction</a></h2><p id="bcfe" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The <strong class="lu mg">createRawTransaction</strong> function creates an unsigned serialized transaction that spends a previous output to a new output. The transaction is not stored in the wallet or transmitted to the network.</p><p id="376a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We pass in a few parameters to create a raw transaction:</p><p id="64c2" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">txid</strong>:<br>this is the transaction id that we got from the <strong class="lu mg">listUnspent</strong> function.</p><p id="079a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">vout</strong>:<br>This is the vout that we got from the <strong class="lu mg">listUnspent</strong> function we have set this to zero as we are only using each address once. To make this function a little more robust we could match the addresses from the <strong class="lu mg">listtUnspent</strong> function with the address we pass in and use any vout in the result object.</p><p id="86ea" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The last parameter we pass id a "<strong><a href="https://searchenterprisedesktop.techtarget.com/definition/key-value-pair" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">key-value pair</a>"</strong> which is the address we want to send to and the amount to send (amount -fee)</p><p id="dc13" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This returns a hex string. It is beyond the scope of this tutorial to break this down but if you want to research it further click "<strong><a class="cb bx lb lc ld le" target="_blank" href="https://medium.com/coinmonks/how-to-create-a-raw-bitcoin-transaction-step-by-step-239b888e87f2" rel="noopener noreferrer">here</a>"</strong>.</p><pre class="ke kf kg kh ki dv ge df"><span id="5640" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.createRawTransaction(<br>[{"txid":result[0].txid,<br>"vout":0<br>}],<br>[{[process.env.toaddress]:amounttosend<br>}]<br>).then((txhash) =&gt; {</span><span id="61e0" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">});</span><span id="1152" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//results<br>02000000012da213e96c6be5d381381dc58b5d8c98c66336af361ae63d8d1861981442cdea0000000000ffffffff0198801e000000000017a91470d835143969a5921541ddd01f7eca615be2b9258700000000</span></pre><h2 id="3e8e" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/rawtransactions/signrawtransaction/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="ch">signRawTransaction</strong></a></h2><p id="1552" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The <strong class="lu mg">signRawTransaction</strong> function signs a transaction in the serialized transaction format using private keys stored in the wallet or provided in the call.</p><p id="8054" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">As you see this function takes the results from the previous functions <strong class="lu mg">dumpPrivKey, listUnspent, signRawTransaction </strong>and<strong class="lu mg">createRawTransaction.</strong></p><p id="157c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">txhash</strong>:<br>This is the hash that is returned from the <strong class="lu mg">createRawTransaction </strong>function</p><p id="a131" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">txid</strong>:<br>This the transaction id from the <strong class="lu mg">listUnspent </strong>function</p><p id="ba8c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">vout</strong>:<br>We set this to zero as we only ever send 1 transaction to this address as discussed above.</p><p id="258a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">amount</strong>:<br>This the amount from the <strong class="lu mg">listUnspent </strong>function</p><p id="ca35" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">scriptPubKey</strong>:<br>This the public key of the script from the <strong class="lu mg">listUnspent </strong>function</p><p id="5366" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">redeemScript</strong>:<br>This the redeem script from the <strong class="lu mg">listUnspent </strong>function</p><p id="6a97" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph=""><strong class="lu mg">pkey</strong>:<br>This the private key returned from the <strong class="lu mg">dumpPrivKey </strong>function</p><p id="3fec" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The <strong class="lu mg">signRawTransaction</strong> command returns another hex-encoded raw transaction which we broadcast to the network.</p><pre class="ke kf kg kh ki dv ge df"><span id="11e1" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.signRawTransaction(<br>txhash,[{<br>"txid":result[0].txid,<br>"vout":0,<br>"amount":result[0].amount,<br>"scriptPubKey":result[0].scriptPubKey,<br>"redeemScript":result[0].redeemScript<br>}],<br>[pkey]).then((signed) =&gt; {</span><span id="0144" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">});</span><span id="5e1b" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//results</span><span id="f7f3" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">{ <br>hex:<br>'02000000000101b3e3657a5c00adc03aa7ac19549c88a8284f7e60f0ba06c4723f3394c7627bc501000000171600142a8990cf46e4934aa2458f298086f7b07686c4a5ffffffff01473e0f000000000017a91470d835143969a5921541ddd01f7eca615be2b9258702473044022077326e84b3a0403447d31bd19acf7763d949eccc98f6e3760b48de2f59072f58022038b45c47019501d6f34025e15ac402376dbbea8d2dee4688df37b54ae7098a62012102f72a0b15f6be8cb80b3342172ee12723802ec8c874bc3bfa96113ee2bb4a735d00000000',<br>complete: true <br>}</span></pre><h2 id="a7b2" class="mo lg bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph=""><a href="https://bitcoincore.org/en/doc/0.17.0/rpc/rawtransactions/sendrawtransaction/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">sendRawTransaction</a></h2><p id="8119" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">The <strong class="lu mg">sendRawTransaction</strong> validates a transaction and broadcasts it to the peer-to-peer network. We use the hex has returned from the <strong class="lu mg">signRawTransaction </strong>function<strong class="lu mg">.</strong></p><p id="27f8" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">You can pass an optimal paramater called <strong class="lu mg">allowhighfees</strong> which overrides the 0.1 BTC fee check.</p><p id="9954" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The result (if valid) is the signed hex and the transaction has now been confirmed.</p><pre class="ke kf kg kh ki dv ge df"><span id="3ba3" class="mo lg bf av mp b dz mq mr l ms" data-selectable-paragraph="">client.sendRawTransaction(signed.hex).then((broadcasted) =&gt; {<br>});</span><span id="7472" class="mo lg bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">//results<br>c471ef3419fe487f701b039aabbf8d7897f6facc20bbdceb547f13d4766a21ef</span></pre><h1 id="4a65" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Major Foobar</h1><p id="592d" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">After spending the last couple of weeks reading about anything and everything to do with addresses it became clear I had made a major mistake with the sweep function. The fact that we send the funds to the same address each time is very bad practice and can lead to all sorts of issues such as being able to identify or even hack you or hack your private key. For a great article on an address, reuse click "<strong><a href="https://en.bitcoin.it/wiki/Address_reuse" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a></strong>"</p><p id="100a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This is something we will fix in our next tutorial by generating a bunch of address from a mnemonic using an offline line command line script. We are going to use this by bringing back BitcoinJs bip39.generateMnemonic() function. Yes, I thought we no longer required this and I was wrong, welcome to programming. We can generate this transaction yourself at a HEX level and using OpenSSL and terminal (and we may do so in the future) but for now, this is overkill. If you want to deep dive this subject there is an excellent tutorial "<strong><a class="cb bx lb lc ld le" target="_blank" href="https://medium.com/coinmonks/how-to-generate-a-bitcoin-address-step-by-step-9d7fcbf1ad0b" rel="noopener noreferrer">here</a></strong>".</p><p data-selectable-paragraph=""> </p><h1 id="cef6" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Conclusion</h1><p id="b8b1" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">So there we have a nice little introduction to address, I hope you find this useful and if you read it all, then well done you. Next time we are going to fix our sweep function (as described) and the admin section accordingly.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on October 10, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/working-with-fullnodes-part-2.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/11/responsive/1_63p4B8NFmprNKx3-VZHkeA-xs.jpeg" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Working with Fullnodes part 2</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/refactor-of-cold-storage.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Refactor of cold storage</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-xs.jpeg" data-expand="300" alt=""></a></div></nav></footer></article></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(3)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(24)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(8)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li><li><a href="https://cryptoskillz.com/blog/wink/">wink</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>