<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Part 4: Move payment to cold storage - cryptoskillz</title><meta name="description" content="blockchain,bitcoin,node js, fullnode"><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/part-4-move-payment-to-cold-storage.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/part-4-move-payment-to-cold-storage.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Part 4: Move payment to cold storage"><meta property="og:image" content="https://cryptoskillz.com/blog/media/website/logo.png"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="blockchain,bitcoin,node js, fullnode"><meta property="og:url" content="https://cryptoskillz.com/blog/part-4-move-payment-to-cold-storage.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=cdb7c8dfd06b8f0c89bc0574a7e7c931"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/part-4-move-payment-to-cold-storage.html"},"headline":"Part 4: Move payment to cold storage","datePublished":"2019-09-08T04:57","dateModified":"2019-09-09T00:35","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685},"description":"<figure class=\"post__image\"><img  src=\"https://cryptoskillz.com/blog/media/posts/6/1_YYI3zd3a5mRDlodesvewtw.jpeg\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-2xl.jpeg 1600w\"  alt=\"\" width=\"639\" height=\"426\"></figure>\n<p> </p>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz","logo":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685}}}</script><script src="https://cryptoskillz.com/blog/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-4710117865976591",
    enable_page_level_ads: true
  });</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://cryptoskillz.com/blog/"><img src="https://cryptoskillz.com/blog/media/website/logo.png" alt="cryptoskillz"></a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li><li class="has-submenu"><a href="https://cryptoskillz.com/blog/ecs/" target="_self" aria-haspopup="true">BLOG</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://cryptoskillz.com/blog/ecs/" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blog/fullnode/" target="_self">FULLNODE</a></li><li><a href="https://cryptoskillz.com/blog/cyphernode/" target="_self">CYPHERNODE</a></li></ul></li></ul></nav></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2019-09-08T04:57">September 8, 2019</time></div><h1>Part 4: Move payment to cold storage</h1><div class="post__meta post__meta--author"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" class="feed__author invert">cryptoskillz</a></div></div></header></div><div class="wrapper post__entry"><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_YYI3zd3a5mRDlodesvewtw.jpeg" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_YYI3zd3a5mRDlodesvewtw-2xl.jpeg 1600w" alt="" data-aspectratio="1.500000" width="639" height="426"></figure><p> </p><h1 id="d179" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Introduction</h1><p id="dfde" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous part, I monitored the blockchain with <a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">block.io</strong></a> to let us know when the payment was successful.</p><p id="d59d" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Now we aim to take processed funds and sweep them into a <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a>wallet. We do this with a new script called “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/sweep.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">sweep.js</strong></a>”.</p><blockquote class="mf mg mh"><p id="770b" class="lh li bf mi lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note cryptoskillz from the future here. It turns out I did this bit really badly you can read about in part 10 <a class="cb bx lv lw lx ly" target="_blank" href="https://medium.com/bitcoin-e-commerce-development/part-10-address-101-51868eb6bc9b" rel="noopener noreferrer">here</a> . As a result I would ignore this and instead wait to part 11 which fixes the issues. Ok, Bye, friend :]</p></blockquote><h1 id="05f0" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The SQL</h1><p id="fa99" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We have added a field called swept which is to check if we have moved the payment to our <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">cold storage</a> or not.</p><pre class="mj mk ml mm mn dv ge df"><span id="56d4" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">CREATE TABLE "keys" ( <br>`id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `privatekey` TEXT,<br> `publickey` TEXT,<br> `address` TEXT,<br> `processed` INTEGER DEFAULT 0,<br> `swept` INTEGER DEFAULT 0 <br>)</span></pre><h1 id="6cb3" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The Code</h1><p id="ff28" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The latest (branch sweep) code can be found <a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/sweep" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a> and it is listed below.</p><pre class="mj mk ml mm mn dv ge df"><span id="9ca2" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">/*<br>This is the sweep script that moves payment to our hard wallet.<br>*/<br>//init block.io<br>var BlockIo = require("block_io");<br>var version = 2; // API version<br>var block_io = new BlockIo(<br>  process.env.blockiokey,<br>  process.env.blockiosecret,<br>  version<br>);<br>//load express<br>const express = require("express");<br>//load body parser<br>const bodyParser = require("body-parser");<br>//load the bitcoin js files<br>var bitcoin = require("bitcoinjs-lib");<br>//load SQLlite (use any database you want or none)<br>//init it<br>const sqlite3 = require("sqlite3").verbose();<br>var request = require("request");<br>//init it<br>const app = express();<br>//open a database connection<br>let db = new sqlite3.Database("./db/db.db", err =&gt; {<br>  if (err) {<br>    console.error(err.message);<br>  }<br>});<br>//set up the network we would like to connect to. in this case test net.<br>const TestNet = bitcoin.networks.testnet;<br>//build the query<br>let sql = `SELECT * FROM keys where processed = 1 and swept = 0 limit 0,1`;<br>//run the query<br>db.all(sql, [], (err, rows) =&gt; {<br>  if (err) {<br>    throw err;<br>  }<br>  rows.forEach(row =&gt; {<br>    //get the address<br>    var address = row.address;<br>    //get the private key<br>    var privateKey = row.privatekey;</span><span id="9328" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">block_io.get_transactions(<br>      { type: "received", addresses: address },<br>      function(error, data) {<br>        //get the tx transaction id<br>        var txid = data.data.txs[0].txid;<br>        //get the amount in the transaction<br>        let amountReceived = data.data.txs[0].amounts_received[0].amount;<br>        //estimate the fee<br>        block_io.get_network_fee_estimate(<br>          { amounts: amountReceived, to_addresses: process.env.toaddress },<br>          function(error2, data2) {<br>            //store the network fee.<br>            var networkfee = data2.data.estimated_network_fee;<br>            //init a new transaction<br>            let tx = new bitcoin.TransactionBuilder(TestNet);<br>            //get the WIF from the private key so we can sign the transaction later.<br>            let hotKeyPair = new bitcoin.ECPair.fromWIF(privateKey, TestNet);<br>            //work out the amount to send<br>            let amountToSend = amountReceived - networkfee;<br>            //turn the amount recieved into satoshis<br>            amountToSendSatoshi = amountToSend * 100000000;<br>            tx.addInput(txid, 0, 0xfffffffe);<br>            //note : this seems to do the fee on of its own accord.<br>            tx.addOutput(process.env.toaddress, amountToSendSatoshi);<br>            //sign the transaction with our private key<br>            tx.sign(0, hotKeyPair);<br>            //output it<br>            //note we have to figure out how to push this to the network and not use <a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a><br>            console.log(tx.build().toHex());<br>            // Set the headers<br>            var headers = {<br>              "User-Agent": "Super Agent/0.0.1",<br>              "Content-Type": "application/x-www-form-urlencoded"<br>            };<br>            // Configure the request<br>            var options = {<br>              url: "<a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a>",<br>              method: "POST",<br>              headers: headers,<br>              form: { tx: tx.build().toHex() }<br>            };<br>            // Start the request<br>            request(options, function(error, response, body) {<br>              //console.log(response)<br>              if (!error &amp;&amp; response.statusCode == 200) {<br>                // Print out the response body<br>                console.log(body);<br>                let sqldata = ["1", address];<br>                let sql = `UPDATE keys<br>                 SET swept = ?<br>                 WHERE address = ?`;<br>                db.run(sql, sqldata, function(err) {<br>                  if (err) {<br>                    return console.error(err.message);<br>                  }<br>                  console.log(`Row(s) updated: ${this.changes}`);<br>                });<br>              }<br>            });<br>          }<br>        );<br>      }<br>    );<br>  });<br>});<br>app.listen(3000, () =&gt; {});</span></pre><p id="6d5b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">What is going in the code above?</strong></p><p id="c316" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">We will skip to the new code check out the previous parts of this tutorial for an explanation on what <a href="http://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">block.io</strong></a> is etc.</p><p id="d591" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The first new thing you will see is we have included the package called <a href="https://www.npmjs.com/package/request" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">request</strong></a> this is we can post to the signing service later.</p><pre class="mj mk ml mm mn dv ge df"><span id="238d" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">var request = require('request');</span></pre><p id="8bc7" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">We have also set a new environment variable which holds the address of the <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a> <a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">wallet</strong></a>. At the moment this is just one address but we could create a new address for each transaction (and we will) we could interface with our <a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">hardware wallet</a> and generate an address (and we will). There are a number of things we can do here and will be looking to make this more secure and private later.</p><pre class="mj mk ml mm mn dv ge df"><span id="a464" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">process.env.toaddress</span></pre><p id="08a4" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we are pulling out all of the processed payments from the table. A processed payment basically means that the monitor script has picked up this payment as it has been <a href="https://en.bitcoin.it/wiki/Confirmation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">confirmed</strong></a> in the <a href="https://en.wikipedia.org/wiki/Blockchain" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">blockchain</strong></a>.</p><p id="2653" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note we are storing the private keys in the database just to make this part of the tutorials easy to understand. In the future, we will refactor this so the private keys are stored by the <a href="https://bitcoin.org/en/full-node" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">fullnode</strong></a> and secured by your <a href="https://en.bitcoin.it/wiki/Passphrase_generation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">passphrase</strong></a> (as they should be)</p><pre class="mj mk ml mm mn dv ge df"><span id="aa2b" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">let sql = `SELECT * FROM keys where processed = 1 and swept = 0 limit 0,1`;<br>//run the query<br>db.all(sql, [], (err, rows) =&gt; {<br>  if (err) {<br>    throw err;<br>  }<br>  rows.forEach(row =&gt; {});<br>});</span></pre><p id="ff92" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">After that, we grab the address and <a href="https://en.bitcoin.it/wiki/Private_key" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">private key</strong></a> from the database.</p><pre class="mj mk ml mm mn dv ge df"><span id="f0d4" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">var address = row.address;<br>//get the private key<br>var privateKey = row.privatekey;<br>block_io.get_transactions({ type: "received", addresses: address }, function(<br>  error,<br>  data<br>) {});</span></pre><p id="47bf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to use this address to contact <a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">block.io</strong></a> and get the transaction information. Note we are storing the <a href="https://bitcoin.org/en/glossary/txid" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">txid</strong></a> and amount as we are about to use this estimate the fee and sign the transaction.</p><pre class="mj mk ml mm mn dv ge df"><span id="a227" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">block_io.get_transactions({ type: "received", addresses: address }, function(<br>  error,<br>  data<br>) {<br>  //todo : check for no transactions<br>  //console.dir(data, { depth: null });<br>  //get the tx transaction id<br>  var txid = data.data.txs[0].txid;<br>  //get the amount in the transaction<br>  let amountReceived = data.data.txs[0].amounts_received[0].amount;<br>});</span></pre><p id="790b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to get the estimated network fee from <a href="https://block.io/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">block.io</strong></a></p><pre class="mj mk ml mm mn dv ge df"><span id="7fda" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">block_io.get_network_fee_estimate(<br>  { amounts: amountReceived, to_addresses: process.env.toaddress },<br>  function(error2, data2) {<br>    //store the network fee.<br>    var networkfee = data2.data.estimated_network_fee;<br>  }<br>);</span></pre><p id="a629" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we want to create and sign a <a href="https://en.bitcoin.it/wiki/Transaction" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">transaction</strong></a>. We do this by using the transaction builder work out the amount send and sign it. Note this was one of the hardest things to do out of all the steps so if this does not immediately click do not worry it will eventually.</p><pre class="mj mk ml mm mn dv ge df"><span id="f472" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">//init a new transaction<br>let tx = new bitcoin.TransactionBuilder(TestNet);<br>//get the WIF from the private key so we can sign the transaction later.<br>let hotKeyPair = new bitcoin.ECPair.fromWIF(privateKey, TestNet);<br>//work out the amount to send<br>let amountToSend = amountReceived - networkfee;<br>//turn the amount recieved into satoshis<br>amountToSendSatoshi = amountToSend * 100000000;<br>tx.addInput(txid, 0, 0xfffffffe);<br>tx.addOutput(process.env.toaddress, amountToSendSatoshi);<br>//sign the transaction with our private key<br>tx.sign(0, hotKeyPair);</span></pre><p id="770c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The next thing we want to do is <a href="https://en.bitcoin.it/wiki/Transaction_broadcasting" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">broadcast</strong></a> this transaction to the network. We are using blockchain.info tool which can be found <a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a>. There are many of these tools and they all do the same thing and yes we will be doing this ourselves once we upgrade to a <a href="https://bitcoin.org/en/full-node" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">fullnode</strong></a>.</p><p id="f0a9" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Lastly, we update the database so we do not have to process this entry again.</p><pre class="mj mk ml mm mn dv ge df"><span id="0308" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">// Set the headers<br>   var headers = {<br>       'User-Agent':       'Super Agent/0.0.1',<br>       'Content-Type':     'application/x-www-form-urlencoded'<br>   }</span><span id="8507" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">// Configure the request<br>var options = {<br>  url: "<a href="https://testnet.blockchain.info/pushtx" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://testnet.blockchain.info/pushtx</a>",<br>  method: "POST",<br>  headers: headers,<br>  form: { tx: tx.build().toHex() }<br>};<br>// Start the request<br>request(options, function(error, response, body) {<br>  if (!error &amp;&amp; response.statusCode == 200) {<br>    // Print out the response body<br>    console.log(body);<br>    let sqldata = ["1", address];<br>    let sql = `UPDATE keys<br>                 SET swept = ?<br>                 WHERE address = ?`;</span><span id="b384" class="mo kv bf av mp b dz mt mu mv mw mx mr l ms" data-selectable-paragraph="">db.run(sql, sqldata, function(err) {<br>      if (err) {<br>        return console.error(err.message);<br>      }<br>      console.log(`Row(s) updated: ${this.changes}`);<br>    });<br>  }<br>});</span></pre><p id="e322" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">That’s it we now have a “server” which allows us to generate an address, monitor the blockchain for payment and finally move the funds to <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a>, neat. Let’s test it, shall we?</p><h2 id="1904" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step 1: Generate an address</h2><p id="c6ba" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">go to your terminal client and type and navigate to the directory with your code and type.</p><pre class="mj mk ml mm mn dv ge df"><span id="762f" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node generate.js</span></pre><p id="830b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">You will be presented with an address in the console (as shown in the screenshot below).</p><p id="b33a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note, it will be a different address than the in the screenshot obviously.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_sfCOFd3iVkx79EiQIgdkPQ.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_sfCOFd3iVkx79EiQIgdkPQ-2xl.png 1600w" alt="" data-aspectratio="12.156250" width="778" height="64"></figure><p data-selectable-paragraph="">Copy this and load <a href="https://bitcoin.org/en/download" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">bitcoin-qt</a> and send some Bitcoin to this address. As shown below.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_274A47zh3h_-0QVr4MruKg.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_274A47zh3h_-0QVr4MruKg-2xl.png 1600w" alt="" data-aspectratio="5.689420" width="3334" height="586"></figure><p id="88bf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Let's see if it is on the network. You can use a blockchain explorer to monitor the status of the transaction. An example of a blockchain explorer with our address can be found <a href="https://live.blockcypher.com/btc-testnet/address/muSjmRdrwhjxpXFa8BBEd3BduGvh7YEYwX/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a> as shown in the screenshot below.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_Qtu_mUMozmlzF5chhGH2TQ.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Qtu_mUMozmlzF5chhGH2TQ-2xl.png 1600w" alt="" data-aspectratio="1.651542" width="2839" height="1719"></figure><p id="3b85" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Because this is a public blockchain anyone can write a block explorer. In fact, this is essentially what we have done with “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a><strong class="lj lz">”</strong> it is a simple, hyper-focused blockchain explorer.</p><h2 id="0fbe" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step2: Monitor for the confirmed transaction</h2><p id="a31c" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">Now let’s run monitor by going to the terminal (stopping generate.js if it still running by pressing control &amp; c) and type the following:</p><pre class="mj mk ml mm mn dv ge df"><span id="c43f" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node monitor.js</span></pre><p id="fb7c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">When you do this you will see the following (screenshot below). What is happening here is that “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a>” checking the blockchain to make sure the payment has been <a href="https://en.bitcoin.it/wiki/Confirmation" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">confirmed</strong></a>. This takes a period of time, usually 10 minutes for each confirmation and you free to set whatever confirmation threshold you want (3 confirmations is normal). Note you could also do something when it is in it’s pending state. Though in the case we have not.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_ik2rljI2JifzxC9KC8fmkg.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_ik2rljI2JifzxC9KC8fmkg-2xl.png 1600w" alt="" data-aspectratio="1.036442" width="967" height="933"></figure><p data-selectable-paragraph=""><strong class="lj lz">“</strong><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">Monitor.js</strong></a><strong class="lj lz">” </strong>is on a timer that is set to check every 3 seconds, again you can set this to whatever time you want to. Eventually, you will see a confirmation (as shown in the screenshot below) and you will be able to go ahead and do the last step which moves the funds to our <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">wallet</strong></a> using “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/sweep.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">sweep.js</strong></a><strong class="lj lz">”</strong></p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_BdGYeoOQ3q4IsnF2-cjEIQ.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_BdGYeoOQ3q4IsnF2-cjEIQ-2xl.png 1600w" alt="" data-aspectratio="3.020833" width="1015" height="336"></figure><p id="7943" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">To move the funds back again go to terminal and type the following. Note make sure the funds have confirmed or this will not work.</p><h2 id="647b" class="mo kv bf av au el my mz na nb nc nd ne nf ng nh ni" data-selectable-paragraph="">Step3: Move funds back to cold storage</h2><pre class="mj mk ml mm mn dv ge df"><span id="2007" class="mo kv bf av mp b dz mq mr l ms" data-selectable-paragraph="">node sweep.js</span></pre><p id="e95e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This will sign a transaction and move it back to <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a> you will see the following output which is the hex transaction as shown in the screenshot below</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_Zw-wQmKdWACYfL49PDGWpA.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Zw-wQmKdWACYfL49PDGWpA-2xl.png 1600w" alt="" data-aspectratio="23.851240" width="2886" height="121"></figure><p id="3873" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Again we can monitor this transaction with a blockchain explorer we could also modify “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/sweep/monitor.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">monitor.js</strong></a>” to check these payments (and we will later) but after about the same period of time as it took to receive the payment you will see this transaction has been confirmed and is now in your <a href="https://en.bitcoin.it/wiki/Cold_storage" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cold storage</strong></a><strong class="lj lz"> </strong><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">wallet</strong></a>.</p><p id="fc5c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note for the purposes of this demo I have used <a href="https://bitcoin.org/en/download" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">bitcoin-qt</strong></a> (later renamed to Bitcoin Core) to send these funds back to but I recommend you use a hardware wallet such as a <a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">ledger nano s</strong></a>.</p><p id="73ca" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">As you can see from the screenshot below that the funds are now safely in our wallet.</p><figure class="post__image"><img class="lazyload" data-src="https://cryptoskillz.com/blog/media/posts/6/1_Tt4n_Jgl8BcrDpHDN51uEA.png" data-sizes="auto" data-srcset="https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/6/responsive/1_Tt4n_Jgl8BcrDpHDN51uEA-2xl.png 1600w" alt="" data-aspectratio="2.419321" width="2279" height="942"></figure><p data-selectable-paragraph=""> </p><h1 id="4ea9" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Conclusion</h1><p id="c76f" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">Now we pretty much have a functional bitcoin payment server written in “<a href="https://nodejs.org/en/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">node.js</strong></a>”. Of course, you would never use this in production we have to do a lot more to it for that to be the case. It does, however, serve its purpose of showing how to do all the major components of the Bitcoin network and how to use them to process Bitcoin transactions.</p><p id="6888" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">In the next tutorial, we are going to start to turn this into a microservice architecture with a rest API and build a front end to take advantage of the code we have written in the previous tutorials. You can check out a quick demo <a href="https://cryptoskillz.com/srcrypto/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a> and if you would like to check out the active branch then go <a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/www" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a>.</p></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on September 9, 2019</p><ul class="post__tag"><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a></li></ul><div class="post__share"><a href="https://twitter.com/share?url=https%3A%2F%2Fcryptoskillz.com%2Fblog%2Fpart-4-move-payment-to-cold-storage.html&amp;via=crypto_skillz&amp;text=Part%204%3A%20Move%20payment%20to%20cold%20storage" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span></a></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://cryptoskillz.com/blog/part-3-monitor-blockchain-for-payment.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Part 3: Monitor blockchain for payment</a></div><div class="post__nav-next"><a href="https://cryptoskillz.com/blog/part-5-www-and-modularisation.html" class="invert post__nav-link" rel="next"><span>Next</span> Part 5: WWW and modularisation </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2019-09-08T18:03" class="feed__date">September 8, 2019</time></div><h3 class="h1"><a href="https://cryptoskillz.com/blog/part-6-create-an-admin-and-hosting.html" class="invert">Part 6: Create an Admin and hosting</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-09-08T04:58" class="feed__date">September 8, 2019</time></div><h3 class="h1"><a href="https://cryptoskillz.com/blog/part-5-www-and-modularisation.html" class="invert">Part 5: WWW and modularisation</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2019-09-08T00:12" class="feed__date">September 8, 2019</time></div><h3 class="h1"><a href="https://cryptoskillz.com/blog/part-3-monitor-blockchain-for-payment.html" class="invert">Part 3: Monitor blockchain for payment</a></h3></article></div></div><div class="post__comments"><div class="wrapper"><h2 class="h5">Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://cryptoskillz.com/blog/part-4-move-payment-to-cold-storage.html';
               		this.page.identifier = '6';
                       this.page.title = ' Part 4: Move payment to cold storage';
                   };
               
                   var disqus_loaded = false;
               
                   function publiiLoadDisqus() {
                       if(disqus_loaded) {
                           return false;
                       }
               
                       var top = document.getElementById('disqus_thread').offsetTop;
               
                       if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                           disqus_loaded = true;
               
                           (function () {
                               var d = document, s = d.createElement('script');
                               s.src = 'https://cryptoskillz-1.disqus.com/embed.js';
                               s.setAttribute('data-timestamp', +new Date());
                               (d.head || d.body).appendChild(s);
                           })();
                       }
                   }
               
                   publiiLoadDisqus();
               
                   window.onscroll = function() {
                       publiiLoadDisqus();
                   };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer class="footer"><div class="footer__social"><a href="crypto_skillz" aria-label="Twitter"><svg><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#twitter"/></svg></a></div><div class="footer__copyright">Powered by <a href="https://getpublii.com" target="_blank" rel="nofollow noopener noreferrer">Publii Static CMS</a></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://cryptoskillz.com/blog/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>