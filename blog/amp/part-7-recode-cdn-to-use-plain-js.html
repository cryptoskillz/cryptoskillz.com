<!doctype html><html amp lang="en"><head><meta charset="utf-8"><title>Part 7: Recode CDN to use plain js - cryptoskillz</title><meta name="description" content="blockchain,bitcoin,node js, fullnode"><link rel="canonical" href="https://cryptoskillz.com/blog/part-7-recode-cdn-to-use-plain-js.html"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css"><script async custom-element="amp-sidebar" src="https://cdn.ampproject.org/v0/amp-sidebar-0.1.js"></script><script async custom-element="amp-social-share" src="https://cdn.ampproject.org/v0/amp-social-share-0.1.js"></script><script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script><script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script><script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/amp/part-7-recode-cdn-to-use-plain-js.html"},"headline":"Part 7: Recode CDN to use plain js","datePublished":"2019-09-08T18:16","dateModified":"2019-09-09T00:34","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685},"description":"<figure class=\"post__image\"><amp-img  src=\"https://cryptoskillz.com/blog/media/posts/9/1_SbYlu5R2xvkYwvQ5m6iDaw.jpeg\" sizes=\"(max-width: 48em) 100vw, 768px\" srcset=\"https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-2xl.jpeg 1600w\"  alt=\"\" width=\"639\" height=\"498\" layout=\"responsive\"></amp-img></figure>\n<p> </p>\n","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz","logo":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/website/logo.png","height":178,"width":685}}}</script><style amp-custom>article,
aside,
footer,
header,
hgroup,
main,
nav,
section {
  display: block; }

*,
*:before,
*:after {
  -webkit-box-sizing: content-box;
  box-sizing: content-box;
  margin: 0;
  padding: 0; }

li {
  list-style: none; }

amp-img {
  max-width: 100%; }

button,
input,
select,
textarea {
  font: inherit; }

html {
  font-size: 1rem; }

body {
  background: #f1f1f1;
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  line-height: 1.6; }

a {
  color:  #039be5;
  text-decoration: none;
  -webkit-transition: all 0.12s linear 0s;
  -o-transition: all 0.12s linear 0s;
  transition: all 0.12s linear 0s; }

a:hover {
  color: #262626;
  text-decoration: underline;
  -webkit-text-decoration-skip: ink;
  text-decoration-skip: ink; }

a:active {
  color: #262626; }

a:focus {
  outline: 2px dotted #039be5; }

figure,
blockquote,
p,
ul,
ol,
dl,
table,
hr,
fieldset {
  margin-top: 1.6rem; }

h1,
h2,
h3,
h4,
h5,
h6 {
  color: #262626;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-weight: 500;
  line-height: 1.2;
  margin-top: 2.13333rem; }

h1 {
  font-size: 1.67583rem;
  font-weight: normal; }

h2 {
  font-size: 1.4729rem; }

h3 {
  font-size: 1.29454rem; }

h4 {
  font-size: 1.13778rem; }

h5 {
  font-size: 1rem; }

h6 {
  font-size: 0.87891rem; }

h2 + p,
h3 + p,
h4 + p,
h5 + p,
h6 + p {
  margin-top: 0.8rem; }

b,
strong {
  font-weight: 600; }

blockquote {
  color: #6c7175;
  font-family: "Droid Serif", "Times", "Source Serif Pro", serif;
  font-style: italic;
  padding: 1.33333rem 0.53333rem 1.33333rem 3.2rem;
  position: relative; }
  blockquote:before {
    display: block;
    content: "\201C";
    font-size: 4.41226rem;
    position: absolute;
    left: 0;
    top: -12px;
    color: rgba(108, 113, 117, 0.5); }
  blockquote > :nth-child(1) {
    margin-top: 0; }

ul,
ol {
  margin-left: 2rem; }
  ul > li,
  ol > li {
    list-style: inherit;
    padding: 0 0 0.26667rem 0.26667rem; }

dl dt {
  color: #262626;
  font-weight: 600; }

code,
pre {
  background-color: #f1f1f1;
  font-family: monospace; }

pre {
  margin: 1.6rem 0 0;
  padding: 1.6rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-x: auto; }
  pre > code {
    color: #262626;
    padding: 0; }

code {
  border-radius: 3px;
  color: #262626;
  padding: 0.26667rem 0.53333rem; }

table {
  border-collapse: collapse;
  border-spacing: 0;
  border: 1px solid #d4d4d4;
  width: 100%;
  overflow-x: auto;
  vertical-align: top;
  text-align: left;
  white-space: nowrap; }
  table th {
    font-weight: 500;
    padding: 0.53333rem 1.06667rem; }
  table tr {
    border-bottom: 1px solid #d4d4d4; }
    table tr:nth-child(2n) {
      background: #f1f1f1; }
  table td {
    padding: 0.53333rem 1.06667rem; }

figcaption {
  clear: both;
  color: rgba(108, 113, 117, 0.6);
  font-size: 0.82397rem;
  margin: 0.8rem 0 0;
  text-align: center; }

sub,
sup {
  font-size: 65%; }

hr {
  border: 0;
  height: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3); }

.btn, [type=button],
[type=submit],
button {
  background: #039be5;
  border: none;
  border-radius: 2px;
  color: #ffffff;
  cursor: pointer;
  display: inline-block;
  font-size: 0.87891rem;
  font-weight: 500;
  line-height: 1.9;
  padding: 0.53333rem 1.33333rem;
  text-align: center;
  text-decoration: none;
  -webkit-transition: all .15s ease;
  -o-transition: all .15s ease;
  transition: all .15s ease;
  width: auto; }
  .btn:hover, [type=button]:hover,
  [type=submit]:hover,
  button:hover {
    background: #262626;
    color: #ffffff; }
  .btn:focus, [type=button]:focus,
  [type=submit]:focus,
  button:focus {
    outline: none; }
  .btn-outline {
    border: 1px solid #ddd;
    background: #ffffff;
    border-radius: 3px;
    color: #262626; }

[type=button],
[type=submit],
button {
  text-transform: uppercase;
  -webkit-appearance: none;
  -moz-appearance: none; }

.navbar {
  background: #039be5;
  -webkit-box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  box-shadow: 0 0 6px 0 rgba(0, 0, 0, 0.2);
  line-height: 3;
  max-height: 4rem; }
  .navbar > div {
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    text-align: left;
    max-width: 700px;
    margin: 0 auto; }
  .navbar a {
    color: #ffffff;
    text-decoration: none; }
  .navbar-sidebar-toggle {
    left: 0;
    position: relative;
    text-indent: -99999rem; }
    .navbar-sidebar-toggle:before {
      content: "";
      display: block;
      border-top: 0.375rem double #ffffff;
      border-bottom: 0.125rem solid #ffffff;
      height: 0.125rem;
      position: absolute;
      text-indent: 0;
      top: 50%;
      width: 1.3rem;
      -webkit-transform: translate(0px, -50%);
      -ms-transform: translate(0px, -50%);
      transform: translate(0px, -50%); }


.logo {
                    background-image: url('https://cryptoskillz.com/blog/media/website/logo.png');
                    background-size: auto 2rem;
                    background-repeat: no-repeat;
                    background-position: center center;
            display: inline-block;
  font-weight: 600;
  line-height: 1;
            margin: 0 auto;
            height: 2rem;
            text-indent: -9999px;
            width: 240px;vertical-align: middle;
        }
        .logo.logo-text {
            line-height: 2;
            text-align: center;
            text-indent: 0;
        }

amp-sidebar {
  background: #ffffff;
  width: 240px; }
  amp-sidebar > ul {
    margin: 0.8rem 0 0;
    padding: 0; }
    amp-sidebar > ul ul {
      border-left: 1px solid #d4d4d4;
      margin: 0.53333rem 0 0; }
    amp-sidebar > ul li {
      color: #262626;
      font-size: 0.9375rem;
      font-weight: 600;
      list-style: none;
      line-height: 1.4;
      padding: 0.42667rem 1.06667rem; }
      amp-sidebar > ul li li {
        font-weight: normal;
        padding: 0.26667rem 0 0.26667rem 1.06667rem; }
    amp-sidebar > ul a,
    amp-sidebar > ul a:visited {
      color: #262626; }

.bg-white {
  background: #ffffff; }

.wrap-page {
  max-width: 700px;
  margin: 0 auto; }

@media all and (max-width: 43.6875em) {
  .wrap-inner {
    padding: 0 6%; } }

.page-title {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding: 1.6rem 6%; }
  .page-title > h1 {
    margin: 0;
    font-size: 1.29454rem; }
  .page-title > p {
    font-size: 0.87891rem;
    color: #6c7175;
    line-height: 1.3;
    margin: 0.26667rem 0 0; }
  .page-title-author {
    border-radius: 50%;
    float: left;
    height: 2.5rem;
    width: 2.5rem; }
    .page-title-author + h1 {
      margin-left: 3.5rem; }
      .page-title-author + h1 + p {
        margin-left: 3.5rem; }

.card {
  background: #ffffff;
  -webkit-box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  box-shadow: 0 2px 3px rgba(38, 38, 38, 0.1);
  margin-bottom: 0.8rem;
  padding-bottom: 1.06667rem; }

  .card-meta {
    border-top: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-top: 1.06667rem;
    text-transform: uppercase; }
    .card-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .card-text {
    font-size: 0.9375rem;
    overflow: hidden;
    padding: 0 6%; }
    .card-text h2 {
      font-size: 1.13778rem; }

.post {
  margin-bottom: 2.13333rem; }
  .post-featured-image {
    margin-top: 0;
    position: relative; }
    .post-featured-image > figcaption {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      color: #ffffff;
      position: absolute;
      bottom: 0.8rem;
      padding: 0 0.26667rem;
      right: 6%; }
  .post-header {
    margin-bottom: 2.13333rem; }
  .post-meta {
    border-bottom: 1px solid #d4d4d4;
    color: rgba(108, 113, 117, 0.6);
    font-size: 0.7242rem;
    font-weight: 500;
    margin-top: 1.06667rem;
    padding-bottom: 1.06667rem;
    text-transform: uppercase; }
    .post-meta a + time:before {
      content: "";
      background: #d4d4d4;
      display: inline-block;
      height: 3px;
      margin: 0 8px;
      width: 3px;
      vertical-align: middle;
      border-radius: 50%; }
  .post-tag {
    margin: 0; }
    .post-tag > li {
      display: inline-block;
      padding: 0; }
      .post-tag > li a {
        background: #f1f1f1;
        border-radius: 2px;
        color: #6c7175;
        font-size: 0.77248rem;
        display: inline-block;
        margin: 0 0.26667rem 0.26667rem 0;
        padding: 0.26667rem 0.53333rem; }
        .post-tag > li a:hover {
          background: #039be5;
          color: #ffffff;
          text-decoration: none; }
  .post-share {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: normal;
    -ms-flex-direction: row;
    flex-direction: row;
    -webkit-box-pack: justify;
    -ms-flex-pack: justify;
    justify-content: space-between;
    margin-top: 1.6rem;
    width: 100%; }
    .post-share amp-social-share {
      -webkit-box-flex: 1;
      -ms-flex: 1 0 auto;
      flex: 1 0 auto;
      background-size: 24px; }
  .post-scroll {
    color: #ffffff;
    background: #039be5;
    bottom: 10px;
    border-radius: 50%;
    border: none;
    -webkit-box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    box-shadow: 0 1px 1.5px 0 rgba(38, 38, 38, 0.12), 0 1px 1px 0 rgba(38, 38, 38, 0.24);
    font-size: 1.13778rem;
    height: 46px;
    opacity: 0;
    outline: none;
    position: fixed;
    padding: 0;
    right: 4%;
    visibility: hidden;
    width: 46px;
    z-index: 9999; }
    .post-scroll-marker {
      height: 0px;
      position: absolute;
      top: 100px;
      width: 0px; }
        .post-pagination {
    background: #f1f1f1;
    -webkit-box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    box-shadow: inset 0 2px 3px rgba(38, 38, 38, 0.1);
    border-top: 1px solid #d4d4d4;
    padding: 1.06667rem 0; }
    .post-pagination > div {
      line-height: 1.2;
      padding: 0.53333rem 1.06667rem;
      text-align: center; }
      .post-pagination > div span {
        display: block;
        color: #6c7175;
        font-size: 0.7242rem;
        font-weight: 500;
        margin-bottom: 0.26667rem;
        text-transform: uppercase; }
    .post-pagination-prev a:before {
      content: "\2190";
      margin-right: 0.26667rem; }
    .post-pagination-next a:after {
      content: "\2192";
      margin-left: 0.26667rem; }

aside {
  margin: 1.6rem 0 0; }

.align-left {
  text-align: left; }

.align-right {
  text-align: right; }

.align-center {
  text-align: center; }

.align-justify {
  text-align: justify; }

.msg {
  border-left: 2px solid transparent;
  padding: 1.06667rem 1.06667rem; }
  .msg--highlight {
    background-color: #fff8e6;
    border-color: #e2ac4f; }
  .msg--info {
    background: rgba(45, 97, 201, 0.03);
    border-color: #039be5; }
  .msg--success {
    background: #f7fbf6;
    border-color: #5ab44b; }
  .msg--warning {
    background: #fff3f3;
    border-color: #c06367;
    color: #a94442; }

.dropcap:first-letter {
  float: left;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
  font-size: 2.16943rem;
  line-height: 0.7;
  margin-right: 0.53333rem;
  padding: 0.53333rem 0.53333rem 0.53333rem 0; }

.pagination {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: justify;
  -ms-flex-pack: justify;
  justify-content: space-between;
  margin: 0.8rem 0; }
  .pagination > a {
    padding-left: 0;
    padding-right: 0;
    width: 49%; }
  .pagination-right {
    margin-left: auto; }

.bottom {
  background: #039be5;
  color: #ffffff;
  padding: 1.06667rem 4%;
  text-align: center; }</style><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><script async src="https://cdn.ampproject.org/v0.js"></script><script custom-element="amp-animation" src="https://cdn.ampproject.org/v0/amp-animation-0.1.js" async></script><script custom-element="amp-position-observer" src="https://cdn.ampproject.org/v0/amp-position-observer-0.1.js" async></script><script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script></head><body class="bg-white"><nav class="navbar wrap-inner" id="top"><div><a on="tap:navbar-sidebar.toggle" class="navbar-sidebar-toggle" title="Menu">Menu</a> <a class="logo" href="https://cryptoskillz.com/blog/amp/">cryptoskillz</a></div></nav><main class="wrap-page"><article class="post"><div class="wrap-inner"><header class="post-header"><h1>Part 7: Recode CDN to use plain js</h1><p class="post-meta"><time datetime="2019-09-08T18:16">September 8, 2019</time></p></header><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_SbYlu5R2xvkYwvQ5m6iDaw.jpeg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_SbYlu5R2xvkYwvQ5m6iDaw-2xl.jpeg 1600w" alt="" width="639" height="498" layout="responsive"></amp-img></figure><p> </p><h1 id="1e6f" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Introduction</h1><p id="ca56" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the previous article, we coded the admin section in <a href="https://nodejs.org/en/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">node.js</strong></a> and hosted all of the various microservices.</p><p id="cc89" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This time, we are going to refactor the CDN part (<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/refactor1/cdn/js/sr.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">sr.js</a>) coding it in plain javascript this allows it to be deployed without any issues on the highest number of websites. In other words, we are going to make it <a href="https://www.commonplaces.com/blog/are-you-technology-agnostic/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">agnostic</a>.</p><h1 id="0682" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">The SQL</h1><p id="c75b" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">Before we get into the updates to the database for this part of the tutorial there are a couple of concepts that are worth discussing.</p><p id="9573" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The way the database is set up only allows one product per order, again this is done for simplicity and works with the simple “Pay button” concept I will discuss later. When we add new “widgets” in later tutorials that will allow multiple products in one order.</p><p id="3901" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Furthermore, the database is not designed to be working in a SAAS manner it works with one user admin account that manages all orders. We fell this works well with the concept of Bitcoin sovereignty. All the software required to process transactions on the of an e-commerce store should belong to that store.</p><p id="6592" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">If you have 10 sites deploy the software 10 times. We may turn it into a SAAS product one day if there is a demand for such a thing.</p><p id="51d2" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Ok, now on to the changes.</p><h2 id="b158" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">Product table</h2><p id="e88c" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We added a product to store the product details. We also store the details for the order in this and at present, we only chose to store the email address. It may make sense to store billing/shipping address etc. We can do this later for we are accepting the minimum of details to get the system working.</p><pre class="ke kf kg kh ki dv ge df"><span id="e855" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">CREATE TABLE "product" <br>( `id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `address` TEXT,<br> `name` TEXT,<br> `price` TEXT,<br> `quantity` INTEGER,<br> `email` TEXT <br>)</span></pre><h1 id="8e2f" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Code sections</h1><p id="1ad2" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The latest branch that deals with code in this tutorial can be found “<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/refactor1" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a>”</p><h2 id="b7d0" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">Admin</h2><p id="a677" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We made minimal changes to the admin this time around and the demo can be found “<a href="https://cryptoskillz.com/srcrypto/prod/admin/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">here</strong></a>”. We suggest you host it locally whilst you run through the examples below.</p><h2 id="2a6d" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/admin/admin/payments.html" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">payments.html</a></h2><p id="e236" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We made 1 small change to this screen and that was to make ID clickable and it goes to a new screen called orders.</p><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_B88mqW1N6p-KhE81dK6GHQ.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_B88mqW1N6p-KhE81dK6GHQ-2xl.png 1600w" alt="" width="2413" height="612" layout="responsive"></amp-img></figure><h2 id="16ca" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph=""><a href="http://s3.eu-west-1.amazonaws.com/srcrypto/admin/order.html?address=mykxm3ydhhCehY2NVszeEYaoc2MFVSYncL" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">order.html</a></h2><p id="c75e" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The order screen shows the details for the order</p><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_zeA18eMH24svKRu87s8KYw.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-2xl.png 1600w" alt="" width="1525" height="454" layout="responsive"></amp-img></figure><h2 id="d21f" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">Server</h2><p id="19ae" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We added a few endpoints to the server as shown below.</p><p id="de6b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">Order endpoint</strong></p><p id="72a5" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The order endpoint returns orders to the admin, smart!</p><pre class="ke kf kg kh ki dv ge df"><span class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//orders<br>app.get("/admin/order", (req, res) =&gt; {<br>  //set the headers<br>  res = setHeaders(res);<br>  let sql =<br>    `select *<br>         from product<br>            WHERE product.address = '` +<br>    req.query.address +<br>    `'`;<br>  var jsonStr = '{"results":[]}';<br>  var obj = JSON.parse(jsonStr);<br>  //jsonStr = JSON.stringify(obj)<br>  db.all(sql, [], (err, rows) =&gt; {<br>    if (err) {<br>      throw err;<br>    }<br>    rows.forEach(row =&gt; {<br>      //console.log(row);<br>      //myObj.push(row);<br>      //obj.push('dsss');<br>      obj["results"].push(row);<br>    });<br>    jsonStr = JSON.stringify(obj);<br>    //console.log('done');<br>    //console.log(jsonStr);<br>    res.send(jsonStr);<br>  });<br>})</span></pre><figure class="post__image"><span id="7e67" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph=""><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_zeA18eMH24svKRu87s8KYw.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_zeA18eMH24svKRu87s8KYw-2xl.png 1600w" alt="" width="1525" height="454" layout="responsive"></amp-img></span></figure><p></p><p id="e558" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">Storedetails endpoint</strong></p><p id="9d06" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This endpoint stores the user order details.</p><pre class="ke kf kg kh ki dv ge df"><span id="439d" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//store user details<br>app.get("/api/storeuserdetails", (req, res) =&gt; {<br>  //set the headers<br>  res = setHeaders(res);<br>  let data = [req.query.email, req.query.address];<br>  let sql = `UPDATE product<br>             SET email = ?<br>             WHERE address = ?`;</span><span id="f28b" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">db.run(sql, data, function(err) {<br>    if (err) {<br>      return console.error(err.message);<br>    }<br>    //console.log(`Row(s) updated: ${this.changes}`);<br>    res.send(JSON.stringify({ status: "ok" }));<br>  });<br>});</span></pre><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_qPk4B69hJoxCk1d1x5oR1w.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_qPk4B69hJoxCk1d1x5oR1w-2xl.png 1600w" alt="" width="889" height="802" layout="responsive"></amp-img></figure><p id="7edf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">storeproduct endpoint</strong></p><p id="7da8" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This endpoint store the details of the order as you can it handles delete/update/insert all from the one function. This works as we are only allowing one product in each order at this moment in time thus keeping the logic nice and simple.</p><pre class="ke kf kg kh ki dv ge df"><span id="b8de" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//storeproduct<br>app.get('/api/storeproduct', (req, res) =&gt; {<br> //set the headers<br> res = setHeaders(res); <br> //check if it is in the product table<br> if (req.query.quantity == 0)<br> {<br>  //delete the record<br>  let data = [req.query.address];<br>  let sql = `delete FROM product WHERE address = ?`;<br>  db.run(sql, data, function(err) <br>  {<br>    if (err) {<br>      return console.error(err.message);<br>    }   <br>  });<br>    <br> }<br> else<br> {<br>  //see if we have it already <br>  let sql = `SELECT * FROM product where address = "`+req.query.address+`"`;<br>  //debug<br>  //console.log(sql);</span><span id="99bf" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">db.all(sql, [], (err, rows) =&gt; {<br>    if (err) {<br>      throw err;<br>    }<br>    //check we have a result<br>    if (rows.length == 0)<br>    {<br>     //insert it<br>     //delete the record<br>   db.run(`INSERT INTO product(address,name,price,quantity) VALUES(?,?,?,?)`, [req.query.address,req.query.name,req.query.price,req.query.quantity], function(err) {<br>    if (err) {<br>      return console.log(err.message);<br>    }<br>   });<br>    }<br>    else<br>    {<br>     //update it<br>     let data = [req.query.quantity,req.query.address];<br>   let sql = `UPDATE product SET quantity = ? WHERE address = ?`;<br>   db.run(sql, data, function(err) {<br>     if (err) {<br>       return console.error(err.message);<br>     }<br>     <br>   });</span><span id="e63a" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">}<br>  });<br> }<br> //debug<br> //console.log(req.query.name);<br> //console.log(req.query.price);<br> //console.log(req.query.quantity);<br> //console.log(req.query.address);<br> res.send(JSON.stringify({status: "ok"}));<br>})</span></pre><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_ukrYWhpsLPw5PoJmv43rBA.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-2xl.png 1600w" alt="" width="162" height="167" layout="responsive"></amp-img></figure><h2 id="ac1d" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">WWW</h2><p id="7bf9" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">We have really simplified the www. Let’s take a look at the index page.</p><pre class="ke kf kg kh ki dv ge df"><span id="1232" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">&lt;!doctype html&gt;<br>&lt;html lang="en" class="no-js"&gt;<br>&lt;head&gt;<br> &lt;meta charset="UTF-8"&gt;<br> &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;<br> &lt;link rel="stylesheet" href="css/reset.css"&gt; <br>  &lt;script src="js/modernizr.js"&gt;&lt;/script&gt; &lt;!-- Modernizr --&gt;</span><span id="6680" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">&lt;title&gt;&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;main&gt;<br> &lt;h1&gt;Add to Cart Interaction&lt;/h1&gt;<br> &lt;a href="#0" id="cd-add-to-cart" class="cd-add-to-cart" data-price="0.1" data-name="a product"&gt;Add To Cart&lt;/a&gt;<br>&lt;/main&gt;</span><span id="cf31" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">&lt;!-- this is were we host the js file that andles cart interaction etc you can dwnload and self host this if you prefer<br>&lt;script type="text/javascript" src="<a href="https://s3.eu-west-1.amazonaws.com/srcrypto/js/sr.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://s3.eu-west-1.amazonaws.com/srcrypto/js/sr.js</a>"&gt;<br>&lt;script type="text/javascript"&gt;<br>   /*<br>     0 = server url<br>     1 = animated<br>     2 = quantity count<br>     3 = cdn url<br>     4 = uid<br>   */<br>  SR.init(["<a href="http://srcryptoapi.eu-west-1.elasticbeanstalk.com/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://srcryptoapi.eu-west-1.elasticbeanstalk.com/</a>", false,15,"<a href="http://s3.eu-west-1.amazonaws.com/srcrypto/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://s3.eu-west-1.amazonaws.com/srcrypto/</a>","3",""]);<br>&lt;/script&gt;</span><span id="0546" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">&lt;/body&gt;<br>&lt;/html&gt;</span></pre><p id="f5f5" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">So, what is happening? Firstly we are including or E-commerce engine via the javascript call.</p><pre class="ke kf kg kh ki dv ge df"><span id="48d0" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">&lt;script type="text/javascript" src="<a href="https://s3.eu-west-1.amazonaws.com/srcrypto/js/sr.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://s3.eu-west-1.amazonaws.com/srcrypto/js/sr.js</a>"&gt;</span></pre><p id="11a4" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Then we are initialising the e-commerce engine.</p><pre class="ke kf kg kh ki dv ge df"><span id="b311" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">&lt;script type="text/javascript"&gt;<br>   /*<br>     0 = server url<br>     1 = animated<br>     2 = quantity count<br>     3 = cdn url<br>     4 = uid<br>   */<br>  SR.init(["<a href="http://srcryptoapi.eu-west-1.elasticbeanstalk.com/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://srcryptoapi.eu-west-1.elasticbeanstalk.com/</a>", false,15,"<a href="http://s3.eu-west-1.amazonaws.com/srcrypto/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://s3.eu-west-1.amazonaws.com/srcrypto/</a>","3",""]);<br>&lt;/script&gt;</span></pre><p id="e232" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Lastly, we have added a “<strong class="lj lz">pay button</strong>” to the page. We give it the class “<strong class="lj lz">cd-add-to-cart</strong>” our sr.js is looking for this class and will interact with it once found. This class has the attributes “<strong class="lj lz">data-price</strong>” and “<strong class="lj lz">data-name</strong>” which we use for the actual product details.</p><p id="3920" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Doing it this way means we do not have to control product inventory in the admin area, though we may add such functionality later. It is worth saying the reason we can do this is that of the way Bitcoin works, there is no payment processor in the middle and no credit card provider and no <a href="https://en.wikipedia.org/wiki/Chargeback" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">CHARGEBACKS</a>.</p><p id="06f5" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">If a user modifies this page to say decrease price. You can as a store owner can just say “you did not send enough BTC please send more to complete the order”. Take it from me this requires a ton of code in current payment gateways to achieve the same results.</p><pre class="ke kf kg kh ki dv ge df"><span id="460a" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">&lt;a href="#0" id="cd-add-to-cart" class="cd-add-to-cart" data-price="0.1" data-name="a product"&gt;Add To Cart&lt;/a&gt;</span></pre><p id="2c9e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">And that is it. The majority of the work in this part of the tutorial was in the CDN so let’s go ahead and break that down.</p><h2 id="bba0" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph=""><strong class="ch">CDN</strong></h2><p id="297b" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">The concept for the CDN part of this project is to have 1 line of code that we can <a href="https://www.wikihow.com/Use-JavaScript-Injections" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">inject</a> into any website and it just works, that seems like a very simple idea easy to implement right? It is actually much harder than you first imagine, in fact even though this took a little under 2 weeks to code it is actually built on 5 years of near constant development (from a previous life).</p><p id="68ab" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">To get the working we have a couple of tenets that we have adhered to achieve our goals</p><ul><li id="6b02" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu np nq nr" data-selectable-paragraph="">It has to be coded in plain javascript</li><li id="8592" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">It has to have its own namespace (annoying with injected elements)</li><li id="2125" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">It has to have full e-commerce functionality from one line of code</li><li id="e1b4" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">It has to look good and not break the design of the site it is injected into</li><li id="eafe" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">It has to be fast with low latency</li></ul><p id="eb7c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Now we know what we have to do let’s take a look at what we did to achieve the above.</p><h2 id="789a" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph=""><strong class="ch">The Code</strong></h2><pre class="ke kf kg kh ki dv ge df"><span id="2529" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">var SR =<br>  SR ||<br>  (function() {<br>    /*<br> **=========================<br> *START OF GLOBAL FUNCTIONS<br> *=========================<br> */</span><span id="14ee" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//holdthe number of product<br>    var itemcount = 0;<br>    //hold the price of the product<br>    var price = "";<br>    //hold the name of the product<br>    var name = "";<br>    //hold the addres of the product<br>    var address = "";</span><span id="2dbc" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//hold the email<br>    var email = "";<br>    //hold the user id<br>    //note : Right now we only allow one user but we will expand this later to make it more of a SAAS product.<br>    var uid = "";<br>    //hold the server url can be overridden in init<br>    var serverurl = "<a href="http://srcryptoapi.eu-west-1.elasticbeanstalk.com/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://srcryptoapi.eu-west-1.elasticbeanstalk.com/</a>";<br>    //hold the cdn url can be overridden in init<br>    var cdnurl = "<a href="http://s3.eu-west-1.amazonaws.com/srcrypto/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://s3.eu-west-1.amazonaws.com/srcrypto/</a>";</span><span id="40c9" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//var to hold the arguments passed in from init<br>    var _args = {}; // private</span><span id="d300" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">var quantity = 9;</span><span id="d681" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//hold the animating flag<br>    var animating = false;</span><span id="dd38" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">var theme = "cart";<br>    /*<br> **=========================<br> *END OF GLOBAL FUNCTIONS<br> *=========================<br> */</span><span id="d68d" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">/*<br> **=========================<br> *START OF GENERIC FUNCTIONS<br> *=========================<br> */</span><span id="24fd" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function adds a class using a  class or id<br>    function addClass(elements, myClass) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="43cc" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="e11b" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="4568" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// add class to all chosen elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        // if class is not already found<br>        if (<br>          (" " + elements[i].className + " ").indexOf(" " + myClass + " ") &lt; 0<br>        ) {<br>          // add class<br>          elements[i].className += " " + myClass;<br>        }<br>      }<br>    }</span><span id="84e9" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function removes a class using a class or id<br>    function removeClass(elements, myClass) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="cc8e" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="ed89" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="d3f8" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// create pattern to find class name<br>      var reg = new RegExp("(^| )" + myClass + "($| )", "g");</span><span id="eebe" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// remove class from all chosen elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        elements[i].className = elements[i].className.replace(reg, " ");<br>      }<br>    }</span><span id="b5fc" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function chnages the text of a div/span etc using a class or id<br>    function changeClassText(elements, value) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="1d40" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="2827" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="9453" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// add class to all chosen elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        elements[i].innerHTML = value;<br>      }<br>    }</span><span id="e165" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function checks if an element has class<br>    function hasClass(elements, value) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="8bed" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="6cc4" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="b350" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//loop the elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        //check if it is the one<br>        //debug<br>        //console.log(elements[i].className)<br>        //console.log(value);<br>        if (elements[i].className.indexOf(value) != -1) {<br>          return 1;<br>        }<br>      }<br>      return 0;<br>    }</span><span id="1d1c" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function hides an element<br>    function hideClass(elements) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="51f7" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="5a2b" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="c35d" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//loop the elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        elements[i].style.display = "none";<br>      }<br>    }</span><span id="b840" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function shows an element<br>    function showClass(elements) {<br>      // if there are no elements, we're done<br>      if (!elements) {<br>        return;<br>      }</span><span id="ce22" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a selector, get the chosen elements<br>      if (typeof elements === "string") {<br>        elements = document.querySelectorAll(elements);<br>      }</span><span id="db0e" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">// if we have a single DOM element, make it an array to simplify behavior<br>      else if (elements.tagName) {<br>        elements = [elements];<br>      }</span><span id="e031" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//loop the elements<br>      for (var i = 0; i &lt; elements.length; i++) {<br>        elements[i].style.display = "";<br>      }<br>    }</span><span id="0951" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this functions updates the totals for the cart<br>    function carttotal() {<br>      //multipily the price by the number of items in the cart<br>      var producttotal = price * itemcount;<br>      //set it to 8 decimal places as it's Bitcoin<br>      producttotal = parseFloat(producttotal).toFixed(8);<br>      changeClassText(document.getElementById("checkouttotal"), producttotal);<br>      //update counter<br>      changeClassText(document.querySelector(".cd-count"), itemcount);<br>      //store product<br>      var url =<br>        serverurl +<br>        "api/storeproduct?name=" +<br>        name +<br>        "&amp;quantity=" +<br>        itemcount +<br>        "&amp;address=" +<br>        address +<br>        "&amp;price=" +<br>        price;<br>      //call the store produt endpoint<br>      fetchurl(url, "storeproduct");<br>    }</span><span id="23a8" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function calls endpoints on the server<br>    //note : This has to be extended to handle post, put etc it only uses GET at the moment.<br>    //   Also it would be good to have proper called backs for the method if we add many more we will make it asynv<br>    function fetchurl(url, method) {<br>      var request = new XMLHttpRequest();<br>      request.open("GET", url, true);<br>      //call it<br>      request.onload = function() {<br>        if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>          if (method == "getaddress") {<br>            // parse the data<br>            var data = JSON.parse(request.responseText);<br>            //debug<br>            //console.log(data)<br>            //set the address<br>            address = data.address;<br>            //set the address in the checkout<br>            var elbtcaddress = document.getElementById("bitcoinaddress");<br>            //set the href<br>            elbtcaddress.setAttribute("href", "bitcoin:" + address);<br>            //set the address<br>            elbtcaddress.innerText = address;<br>            //debug<br>            //console.log(elbtcaddress)</span><span id="8a9d" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//generate the qr code<br>            var elbtcqr = document.getElementById("bitcoinqrcode");<br>            elbtcqr.setAttribute(<br>              "src",<br>              "<a href="https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=</a>" +<br>                address<br>            );<br>            //debug<br>            //console.log(elbtcqr)<br>          }<br>          if (method == "storeproduct") {<br>            //do stuff if you want.<br>          }<br>          if (method == "carttemplate") {<br>            //debug<br>            //console.log(request.responseText);</span><span id="ecd4" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add the cart templatehtml<br>            document.body.insertAdjacentHTML("beforeend", request.responseText);<br>            //add the click elements listeners<br>            clickElements();<br>            //get an address<br>            var url = serverurl + "api/address?uid=" + uid;<br>            fetchurl(url, "getaddress");<br>          }<br>          if (method == "storeuserdetails") {<br>            cartstate(4);<br>          }<br>        } else {<br>          // We reached our target server, but it returned an error<br>        }<br>      };<br>      request.onerror = function() {<br>        // There was a connection error of some sort<br>      };<br>      request.send();<br>    }</span><span id="b891" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//this function works with how the cart should look and sets the correct viusal elements<br>    function cartstate(state) {<br>      /*<br>   1 = show cart product details<br>   2 = show customer details screen<br>   3 = customer detals back<br>   4 = custmer details pay click<br>   5 = bitcoin details back click<br>  */<br>      switch (state) {<br>        case 1:<br>          //hide btc stuff<br>          hideClass(document.getElementById("checkoutbitocoin"));<br>          hideClass(document.getElementById("bitcoinaddresswrapper"));<br>          //hide the customer details<br>          hideClass(document.getElementById("customerdetailswrapper"));<br>          //hide customer detals back<br>          hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>          //open it<br>          addClass(document.querySelector(".cd-cart-container"), "cart-open");<br>          //show the product details<br>          showClass(document.getElementById("cartlistitems"));<br>          break;<br>        case 2:<br>          //hide the product details<br>          hideClass(document.getElementById("cartlistitems"));<br>          //show the customer details<br>          showClass(document.getElementById("customerdetailswrapper"));<br>          showClass(document.getElementById("checkoutcustomerdetailsback"));<br>          //hide btc stuff<br>          hideClass(document.getElementById("bitcoinaddresswrapper"));<br>          break;<br>        case 3:<br>          //show the product details<br>          showClass(document.getElementById("cartlistitems"));<br>          //hide btc stuff<br>          hideClass(document.getElementById("bitcoinaddresswrapper"));<br>          //hide the customer details<br>          hideClass(document.getElementById("customerdetailswrapper"));<br>          hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>          break;<br>        case 4:<br>          //hide the product details<br>          hideClass(document.getElementById("cartlistitems"));<br>          //show btc stuff<br>          showClass(document.getElementById("bitcoinaddresswrapper"));<br>          showClass(document.getElementById("checkoutbitocoin"));<br>          //hide the customer details<br>          hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>          hideClass(document.getElementById("customerdetailswrapper"));<br>          break;<br>        case 5:<br>          //hide the product details<br>          hideClass(document.getElementById("cartlistitems"));<br>          //show the customer details<br>          showClass(document.getElementById("checkoutcustomerdetailsback"));<br>          showClass(document.getElementById("customerdetailswrapper"));<br>          //show btc stuff<br>          hideClass(document.getElementById("bitcoinaddresswrapper"));<br>          hideClass(document.getElementById("checkoutbitocoin"));<br>          break;<br>      }<br>    }</span><span id="9420" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">/*<br> *=========================<br> *END OF GENERIC FUNCTIONS<br> *=========================<br> */</span><span id="90b6" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">function clickElements() {<br>      /*<br>  *===============================<br>  *START OF ELEMENT CLICK FUNCTIONS<br>  *================================<br>  */</span><span id="51d6" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//bitcoin back click<br>      document<br>        .getElementById("checkoutbitocoin")<br>        .addEventListener("click", function() {<br>          cartstate(5);<br>        });<br>      //payment click<br>      document.getElementById("sr-pay").addEventListener("click", function() {<br>        //get the email<br>        //note: We want to update this when we collect more than email, shipping address etc.<br>        var useremail = document.getElementById("sr-email").value;<br>        //only send the email if it has not been sent<br>        if (email != useremail) {<br>          email = useremail;<br>          var url =<br>            serverurl +<br>            "api/storeuserdetails?email=" +<br>            email +<br>            "&amp;address=" +<br>            address;<br>          //call the store produt endpoint<br>          fetchurl(url, "storeuserdetails");<br>        } else {<br>          cartstate(4);<br>        }<br>      });<br>      //customer back click<br>      document<br>        .getElementById("checkoutcustomerdetailsback")<br>        .addEventListener("click", function() {<br>          cartstate(3);<br>        });<br>      //add to cart click element<br>      document.querySelector(".checkout").addEventListener("click", function() {<br>        cartstate(2);<br>      });</span><span id="5ba6" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add to cart click element<br>      document<br>        .querySelector(".cd-add-to-cart")<br>        .addEventListener("click", function() {<br>          //get details<br>          var elproduct = document.getElementById("cd-add-to-cart");<br>          price = elproduct.getAttribute("data-price");<br>          name = elproduct.getAttribute("data-name");<br>          //will update when we use multipile products<br>          var productid = 1;<br>          //todo<br>          var previewpic = "";<br>          //increment count (quantity)<br>          if (itemcount &lt;= quantity) {<br>            itemcount = itemcount + 1;<br>            carttotal(price);</span><span id="99c8" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//show it<br>            showClass(document.querySelector(".cd-cart-container"));</span><span id="8e77" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add item to cart<br>            var productlist = document.getElementById("cartlistitems");<br>            var itemlist = document.createElement("li");<br>            itemlist.className = "product ";</span><span id="b171" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//build produt<br>            var prodcuthtml = "";<br>            //product image<br>            var prodcuthtml =<br>              prodcuthtml +<br>              '&lt;div class="product-image"&gt;&lt;a href="#0"&gt;&lt;img src="img/product-preview.png" alt="placeholder"&gt;&lt;/a&gt;&lt;/div&gt;';<br>            //product name<br>            prodcuthtml =<br>              prodcuthtml +<br>              '&lt;div class=""&gt;&lt;h3&gt;&lt;a href="#0"&gt;' +<br>              name +<br>              "&lt;/a&gt;&lt;/h3&gt;";<br>            //product price<br>            prodcuthtml =<br>              prodcuthtml + '&lt;span class="price"&gt;' + price + " BTC&lt;/span&gt;";<br>            //actions div<br>            prodcuthtml = prodcuthtml + '&lt;div class="actions"&gt;';</span><span id="98b7" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//delete option<br>            prodcuthtml =<br>              prodcuthtml +<br>              '&lt;a href="javascript:SR.deleteitem()" class="delete-item"&gt;Delete&lt;/a&gt;';<br>            prodcuthtml = prodcuthtml + '&lt;div class="quantity"&gt;';<br>            //quantity label<br>            prodcuthtml =<br>              prodcuthtml +<br>              '&lt;label for="cd-product-' +<br>              productid +<br>              '"&gt;Qty&lt;/label&gt;';<br>            //quantity select<br>            prodcuthtml =<br>              prodcuthtml +<br>              '&lt;span class="select"&gt;&lt;select id="productquantity" name="productquantity" onchange="SR.changequantity()"&gt;';<br>            var i = 0;<br>            for (i = 1; i &lt; quantity; i++) {<br>              if (i == itemcount)<br>                prodcuthtml =<br>                  prodcuthtml +<br>                  '&lt;option value="' +<br>                  i +<br>                  '" selected&gt;' +<br>                  i +<br>                  "&lt;/option&gt;";<br>              else<br>                prodcuthtml =<br>                  prodcuthtml + '&lt;option value="' + i + '"&gt;' + i + "&lt;/option&gt;";<br>            }<br>            prodcuthtml = prodcuthtml + "&lt;/select&gt;&lt;/span&gt;";<br>            //end of quantiy div<br>            var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>            //end of actions div<br>            var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>            //end of products details div<br>            var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>            //end of product div<br>            //add to the list<br>            itemlist.innerHTML = prodcuthtml;<br>            // append  to the end of theParent<br>            productlist.innerHTML = "";<br>            productlist.appendChild(itemlist);<br>          }<br>        });<br>      //cart clicked element<br>      document<br>        .querySelector(".cd-cart-trigger")<br>        .addEventListener("click", function() {<br>          //check if cart shoud be shown<br>          //debug<br>          //itemcount = 1;<br>          if (itemcount == 0) {<br>            //always remove as its 0<br>            removeClass(<br>              document.querySelector(".cd-cart-container"),<br>              "cart-open"<br>            );<br>          } else {<br>            //see if the cart is open and toggle it<br>            var res = hasClass(<br>              document.querySelector(".cd-cart-container"),<br>              "cart-open"<br>            );<br>            if (res == 1) {<br>              //close it<br>              removeClass(<br>                document.querySelector(".cd-cart-container"),<br>                "cart-open"<br>              );<br>            } else {<br>              cartstate(1);<br>            }<br>          }<br>        });<br>      /*<br>  *===============================<br>  *END OF ELEMENT CLICK FUNCTIONS<br>  *================================<br>  */<br>    }<br>    return {<br>      init: function(Args) {<br>        /*</span><span id="81f5" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">Server vars you can pass set to "" to ignore<br>         0 = server url. string<br>         1 = animating.  True or false<br>         2 = quantity<br>   3 = cdnurl<br>   4 = uid<br>   5 = theme</span><span id="fc57" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">*/<br>        _args = Args;</span><span id="4280" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//override the server url<br>        if (_args[0] != "") {<br>          serverurl = _args[0];<br>          //alert(serverurl);<br>        }<br>        //check if it is a boolean and if so then set it.<br>        if (typeof _args[1] === "boolean") {<br>          animating = _args[1];<br>        }<br>        //quantity<br>        if (_args[2] != "") {<br>          quantity = _args[2];<br>        }<br>        //cdn url<br>        if (_args[3] != "") {<br>          cdnurl = _args[3];<br>        }<br>        //uid<br>        if (_args[4] != "") {<br>          uid = _args[4];<br>        }<br>        //theme<br>        if (_args[5] != "") {<br>          theme = _args[5];<br>        }</span><span id="0656" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//load css</span><span id="a18d" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">document.head.innerHTML =<br>          document.head.innerHTML +<br>          '&lt;link href="' +<br>          cdnurl +<br>          "theme/" +<br>          theme +<br>          '.css" rel="stylesheet"&gt;';</span><span id="a56d" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//fetch the template so we can use themes<br>        fetchurl(cdnurl + "theme/" + theme + ".html", "carttemplate");<br>      },<br>      //this function changes the quantity of the item in the cart<br>      //note : it is in the name space like this as the cart items are created dynamically so the dom does not always know about it's existence<br>      //   which means that we have to call it from the onchange in the select old school I.E javascript:SR.chanagequantity() which is not ideal<br>      //   and we will fix it later.<br>      changequantity: function() {<br>        var elquantity = document.getElementById("productquantity");<br>        itemcountq = elquantity.options[elquantity.selectedIndex];<br>        itemcount = parseInt(itemcountq.value);<br>        carttotal();<br>      },<br>      //this function deletes an item in the cart<br>      //note : it is in the name space like this as the cart items are created dynamically so the dom does not always know about it's existence<br>      //   which means that we have to call it from the onchange in the select old school I.E javascript:SR.chanagequantity() which is not ideal<br>      //   and we will fix it later.<br>      deleteitem: function() {<br>        itemcount = 0;<br>        var productlist = document.getElementById("cartlistitems");<br>        productlist.innerHTML = "";<br>        carttotal();<br>        //close it<br>        removeClass(document.querySelector(".cd-cart-container"), "cart-open");<br>      }<br>    };<br>  })();</span></pre><p id="4d7f" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Wowsers, that is a chunk of code maybe we should break that down a little.</p><p id="7c57" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The first thing we do it create a <a href="https://addyosmani.com/blog/essential-js-namespacing/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">namespace</a> where we can store all of the e-commerce code. It is really important we put all the code in here or we can easily have conflicts or even worse, <a href="https://medium.freecodecamp.org/how-javascript-variable-scoping-is-just-like-multiple-levels-of-government-d7ddabc49bf1" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">scoping issues!</a></p><pre class="ke kf kg kh ki dv ge df"><span id="3c23" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">var SR = SR ||<br>  (function() {</span><span id="8ab0" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">  })();</span></pre><p id="5986" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we have a few global variables. Now we know some of the hotshot kids out there hate global variables. We do not, they have a place and we use them accordingly if you do not like global variables please fork and refactor accordingly.</p><pre class="ke kf kg kh ki dv ge df"><span id="7b68" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//holdthe number of product<br>var itemcount = 0;<br>//hold the price of the product<br>var price = "";<br>//hold the name of the product<br>var name = "";<br>//hold the addres of the product<br>var address = "";<br>//hold the email<br>var email = "";<br>//hold the user id<br>var uid = "";<br>//hold the server url can be overridden in init<br>var serverurl = "<a href="http://srcryptoapi.eu-west-1.elasticbeanstalk.com/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://srcryptoapi.eu-west-1.elasticbeanstalk.com/</a>";<br>//hold the cdn url can be overridden in init<br>var cdnurl = "<a href="http://s3.eu-west-1.amazonaws.com/srcrypto/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">http://s3.eu-west-1.amazonaws.com/srcrypto/</a>";</span></pre><p id="95e0" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we have our init function. This is where we take the parameters you pass in from the index page of WWW and add them to global variables where appropriate.</p><p id="e4b2" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Once the vars have been set we inject our CSS into the dom via the code line using the URL of the theme.</p><pre class="ke kf kg kh ki dv ge df"><span id="d889" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph=""><strong class="mr lz">document.head.innerHTML = document.head.innerHTML +’&lt;link href=”’+cdnurl+’theme/’+theme+’.css” rel=”stylesheet”&gt;</strong>’</span></pre><p id="dffd" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Lastly, we make an AJAX call via the fetchurl function to get the cart.html</p><pre class="ke kf kg kh ki dv ge df"><span id="2568" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">init : function(Args) <br>{<br><br>   _args = Args;</span><span id="94f7" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">   //override the server url<br>   if (_args[0] != '')<br>   {<br>    serverurl = _args[0];<br>    //alert(serverurl);<br>   }<br>   //check if it is a boolean and if so then set it.<br>   if (typeof(_args[1]) === "boolean")<br>   {<br>    animating = _args[1]<br>   }<br>   //quantity<br>   if (_args[2] != "")<br>   {<br>    quantity = _args[2]<br>   }<br>   //cdn url<br>   if (_args[3] != "")<br>   {<br>    cdnurl = _args[3]<br>   } <br>   //uid<br>   if (_args[4] != "")<br>   {<br>    uid = _args[4]<br>   }<br>   //theme<br>   if (_args[5] != "")<br>   {<br>    theme = _args[5]<br>   }</span><span id="1c5f" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//load css</span><span id="2237" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">document.head.innerHTML = document.head.innerHTML +'&lt;link href="'+cdnurl+'theme/'+theme+'.css" rel="stylesheet"&gt;'</span><span id="d4e2" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//fetch the template so we can use themes <br>   fetchurl(cdnurl+'theme/'+theme+'.html','carttemplate');<br>}</span></pre><p id="d55a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">Fetchurl</strong></p><p id="f72e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">This function calls endpoints on the server. and has a simple if structure to deal with the response ideally, it should use callbacks and events but that would mean delving into async functionality and all the fun that comes with that. We will do this later but for now, let’s keep it nice and simple.</p><p id="e02b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">From the code below you can see it calls four endpoints</p><ul><li id="1170" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu np nq nr" data-selectable-paragraph="">getaddress</li><li id="d274" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">storeproduct</li><li id="e7be" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">carttemplate</li><li id="4324" class="lh li bf av lj b lk ns lm nt lo nu lq nv ls nw lu np nq nr" data-selectable-paragraph="">storeuserdetails</li></ul><p id="1d05" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">the above with the exception of <strong class="lj lz">carttemplate</strong> (calls in the cart HTML in theme, explained in the themes section) are endpoints on the server and.</p><pre class="ke kf kg kh ki dv ge df"><span id="1b75" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph=""> function fetchurl(url,method)<br> {<br>  var request = new XMLHttpRequest();<br>  request.open('GET',url, true);<br>  //call it<br>  request.onload = function() {<br>    if (request.status &gt;= 200 &amp;&amp; request.status &lt; 400) {<br>      if (method == "getaddress")<br>      {<br>       // parse the data<br>       var data = JSON.parse(request.responseText);<br>       //debug<br>       //console.log(data)<br>       //set the address<br>       address = data.address;<br>       //set the address in the checkout<br>       var elbtcaddress = document.getElementById('bitcoinaddress');<br>       //set the href<br>       elbtcaddress.setAttribute('href', "bitcoin:"+address);<br>       //set the address<br>       elbtcaddress.innerText =address;<br>       //debug<br>       //console.log(elbtcaddress)</span><span id="15c5" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//generate the qr code<br>       var elbtcqr = document.getElementById('bitcoinqrcode');<br>    elbtcqr.setAttribute('src', "<a href="https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=</a>"+address);<br>       //debug<br>       //console.log(elbtcqr)<br>      }<br>      if (method == "storeproduct")<br>      {<br>       //do stuff if you want.<br>      }<br>      if (method == "carttemplate")<br>      {<br>       //debug<br>       //console.log(request.responseText);</span><span id="4790" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add the cart templatehtml<br>    document.body.insertAdjacentHTML("beforeend", request.responseText);<br>    //add the click elements listeners<br>    clickElements()<br>    //get an address<br>    var url = serverurl+"api/address?uid="+uid;<br>    fetchurl(url,'getaddress')<br>      }<br>      if (method == "storeuserdetails")<br>      {<br>       cartstate(4);<br>      }</span><span id="3374" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">} <br>    else<br>    {<br>      // We reached our target server, but it returned an error</span><span id="216a" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">}<br>  };<br>  request.onerror = function() {<br>     // There was a connection error of some sort<br>  };<br>  request.send();<br> }</span></pre><p id="d7be" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">Theme</strong></p><p id="de1a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The code is designed to be themeable and as a result, we have a directory called theme and it contains the following files:</p><p id="33dc" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><a href="https://s3.eu-west-1.amazonaws.com/srcrypto/theme/cart.html" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cart.html</strong></a></p><p id="a723" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><a href="https://s3.eu-west-1.amazonaws.com/srcrypto/theme/cart.css" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">cart.css</strong></a></p><p id="3678" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">These are inserted dynamically into the <a href="https://www.w3schools.com/js/js_htmldom.asp" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">DOM</a> of the website from the <a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/refactor1/cdn/js/sr.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer"><strong class="lj lz">SR.js</strong></a>and of course as they are being loaded externally take an amount of time to load you speed things up by putting these files directly into your WWW (if it is to slow for you). We will make this a paramater you can pass from the init section.</p><p id="53df" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">You can also point this to a theme URL of your own design if you want to apply your own styles. If you decide to do this please make sure that you configure your <a href="https://techblog.constantcontact.com/software-development/using-cors-for-cross-domain-ajax-requests/" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">CORS</a> correctly</p><p id="5aaf" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">ClickElements</strong></p><p id="f068" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Getting back to the flow of the code once we have called the “<strong class="lj lz">fetchurl”</strong>function with the “<strong class="lj lz">cartdetails”</strong> method we call the click elements function. Basically, this adds the listeners to the cart. The reason we have to do this after the cart load is that the elements do not exist if we tried to bind at this point it would throw all kind of errors. Luckily the core of Javascript has been coded quite badly, a lot of the time and we can take advantage of this fact and add the listeners at any point.</p><p id="43f7" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Now, I know you, javascript gods, out there are saying just refresh the DOM. Which technically this would work but we do not know <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93viewmodel" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">MVVM</a> you are using (if an) and when/if you update variables on your site. So better to keep it simple.</p><pre class="ke kf kg kh ki dv ge df"><span id="3c5d" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">function clickElements() {<br>  /*<br>  *===============================<br>  *START OF ELEMENT CLICK FUNCTIONS<br>  *================================<br>  */</span><span id="0373" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//bitcoin back click<br>  document<br>    .getElementById("checkoutbitocoin")<br>    .addEventListener("click", function() {<br>      cartstate(5);<br>    });<br>  //payment click<br>  document.getElementById("sr-pay").addEventListener("click", function() {<br>    //get the email<br>    //note: We want to update this when we collect more than email, shipping address etc.<br>    var useremail = document.getElementById("sr-email").value;<br>    //only send the email if it has not been sent<br>    if (email != useremail) {<br>      email = useremail;<br>      var url =<br>        serverurl +<br>        "api/storeuserdetails?email=" +<br>        email +<br>        "&amp;address=" +<br>        address;<br>      //call the store produt endpoint<br>      fetchurl(url, "storeuserdetails");<br>    } else {<br>      cartstate(4);<br>    }<br>  });<br>  //customer back click<br>  document<br>    .getElementById("checkoutcustomerdetailsback")<br>    .addEventListener("click", function() {<br>      cartstate(3);<br>    });<br>  //add to cart click element<br>  document.querySelector(".checkout").addEventListener("click", function() {<br>    cartstate(2);<br>  });</span><span id="97c6" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add to cart click element<br>  document<br>    .querySelector(".cd-add-to-cart")<br>    .addEventListener("click", function() {<br>      //get details<br>      var elproduct = document.getElementById("cd-add-to-cart");<br>      price = elproduct.getAttribute("data-price");<br>      name = elproduct.getAttribute("data-name");<br>      //will update when we use multipile products<br>      var productid = 1;<br>      //todo<br>      var previewpic = "";<br>      //increment count (quantity)<br>      if (itemcount &lt;= quantity) {<br>        itemcount = itemcount + 1;<br>        carttotal(price);</span><span id="dac2" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//show it<br>        showClass(document.querySelector(".cd-cart-container"));</span><span id="c8e5" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add item to cart<br>        var productlist = document.getElementById("cartlistitems");<br>        var itemlist = document.createElement("li");<br>        itemlist.className = "product ";</span><span id="2806" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//build produt<br>        var prodcuthtml = "";<br>        //product image<br>        var prodcuthtml =<br>          prodcuthtml +<br>          '&lt;div class="product-image"&gt;&lt;a href="#0"&gt;&lt;img src="img/product-preview.png" alt="placeholder"&gt;&lt;/a&gt;&lt;/div&gt;';<br>        //product name<br>        prodcuthtml =<br>          prodcuthtml + '&lt;div class=""&gt;&lt;h3&gt;&lt;a href="#0"&gt;' + name + "&lt;/a&gt;&lt;/h3&gt;";<br>        //product price<br>        prodcuthtml =<br>          prodcuthtml + '&lt;span class="price"&gt;' + price + " BTC&lt;/span&gt;";<br>        //actions div<br>        prodcuthtml = prodcuthtml + '&lt;div class="actions"&gt;';</span><span id="4ad7" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//delete option<br>        prodcuthtml =<br>          prodcuthtml +<br>          '&lt;a href="javascript:SR.deleteitem()" class="delete-item"&gt;Delete&lt;/a&gt;';<br>        prodcuthtml = prodcuthtml + '&lt;div class="quantity"&gt;';<br>        //quantity label<br>        prodcuthtml =<br>          prodcuthtml + '&lt;label for="cd-product-' + productid + '"&gt;Qty&lt;/label&gt;';<br>        //quantity select<br>        prodcuthtml =<br>          prodcuthtml +<br>          '&lt;span class="select"&gt;&lt;select id="productquantity" name="productquantity" onchange="SR.changequantity()"&gt;';<br>        var i = 0;<br>        for (i = 1; i &lt; quantity; i++) {<br>          if (i == itemcount)<br>            prodcuthtml =<br>              prodcuthtml +<br>              '&lt;option value="' +<br>              i +<br>              '" selected&gt;' +<br>              i +<br>              "&lt;/option&gt;";<br>          else<br>            prodcuthtml =<br>              prodcuthtml + '&lt;option value="' + i + '"&gt;' + i + "&lt;/option&gt;";<br>        }<br>        prodcuthtml = prodcuthtml + "&lt;/select&gt;&lt;/span&gt;";<br>        //end of quantiy div<br>        var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>        //end of actions div<br>        var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>        //end of products details div<br>        var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>        //end of product div<br>        //add to the list<br>        itemlist.innerHTML = prodcuthtml;<br>        // append  to the end of theParent<br>        productlist.innerHTML = "";<br>        productlist.appendChild(itemlist);<br>      }<br>    });<br>  //cart clicked element<br>  document<br>    .querySelector(".cd-cart-trigger")<br>    .addEventListener("click", function() {<br>      //check if cart shoud be shown<br>      //debug<br>      //itemcount = 1;<br>      if (itemcount == 0) {<br>        //always remove as its 0<br>        removeClass(document.querySelector(".cd-cart-container"), "cart-open");<br>      } else {<br>        //see if the cart is open and toggle it<br>        var res = hasClass(<br>          document.querySelector(".cd-cart-container"),<br>          "cart-open"<br>        );<br>        if (res == 1) {<br>          //close it<br>          removeClass(<br>            document.querySelector(".cd-cart-container"),<br>            "cart-open"<br>          );<br>        } else {<br>          cartstate(1);<br>        }<br>      }<br>    });<br>  /*<br>  *===============================<br>  *END OF ELEMENT CLICK FUNCTIONS<br>  *================================<br>  */<br>}</span></pre><p id="6433" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">After “<strong class="lj lz">clickelements</strong>” has finished processing we call “<strong class="lj lz">fetchurl”</strong> again this time with the “<strong class="lj lz">getaddress</strong>” method. This contacts the server and gets a new Bitcoin address for this session of the cart.</p><pre class="ke kf kg kh ki dv ge df"><span id="b218" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">var url = serverurl+"api/address?uid="+uid;<br>fetchurl(url,'getaddress')</span></pre><p id="0d7a" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Once the Bitcoin address has been returned we use this to set up the rest of the cart as you can see from the code snippet below we set the payment address to the Bitcoin address returned and call google chart API to generate a QR code</p><pre class="ke kf kg kh ki dv ge df"><span id="b028" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">if (method == "getaddress") {<br>  // parse the data<br>  var data = JSON.parse(request.responseText);<br>  //debug<br>  //console.log(data)<br>  //set the address<br>  address = data.address;<br>  //set the address in the checkout<br>  var elbtcaddress = document.getElementById("bitcoinaddress");<br>  //set the href<br>  elbtcaddress.setAttribute("href", "bitcoin:" + address);<br>  //set the address<br>  elbtcaddress.innerText = address;<br>  //debug<br>  //console.log(elbtcaddress)</span><span id="440a" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//generate the qr code<br>  var elbtcqr = document.getElementById("bitcoinqrcode");<br>  elbtcqr.setAttribute(<br>    "src",<br>    "<a href="https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">https://chart.googleapis.com/chart?chs=250x250&amp;cht=qr&amp;chl=</a>" + address<br>  );<br>  //debug<br>  //console.log(elbtcqr)<br>}</span></pre><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_ukrYWhpsLPw5PoJmv43rBA.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-2xl.png 1600w" alt="" width="162" height="167" layout="responsive"></amp-img></figure><p id="b0c2" data-selectable-paragraph="">That is the cart now fully set up and it is simply rendered into WWW and hidden. From this point on the cart just waits for one of the listeners we configured in the “<strong class="lj lz">clickelements</strong>” function to be <a href="https://www.w3schools.com/js/js_function_invocation.asp" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">invoked</a>. If you go to the <a href="http://s3-eu-west-1.amazonaws.com/srcrypto/demo/index.html#0" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">demo</a> and click at to cart you will the image below. The number in the red circle will increase every time you click the add to cart button</p><p id="3409" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">everytime you click the add to cart button the following event listener is called.</p><pre class="ke kf kg kh ki dv ge df"><span id="4627" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">document.querySelector(".cd-add-to-cart").addEventListener("click", function() {</span><span id="53ff" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">});</span></pre><p id="d73d" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The first thing this does is fetch the price and name from the add to cart button (as described in the WWW section of this site).</p><p id="d6a6" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Note we have not used “<strong class="lj lz">productid”</strong> and “<strong class="lj lz">previewpic”</strong> yet this is for a future update so please ignore for now.</p><pre class="ke kf kg kh ki dv ge df"><span id="0250" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//get details<br>var elproduct = document.getElementById("cd-add-to-cart");<br>price = elproduct.getAttribute("data-price");<br>name = elproduct.getAttribute("data-name");<br>//will update when we use multipile products<br>var productid = 1;<br>//todo<br>var previewpic = "";</span></pre><p id="5b8b" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next, we increment the “<strong class="lj lz">itemcount”</strong> which is essentially the quantity and call the “<strong class="lj lz">carttotal”</strong> function. After that, we get an element called “<strong class="lj lz">cartlistitems</strong>” which is part of the “<strong class="lj lz">cartitems” </strong>HTML and add an item to it with the price and name of the product.</p><pre class="ke kf kg kh ki dv ge df"><span id="6be9" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">if (itemcount &lt;= quantity) {<br>  itemcount = itemcount + 1;<br>  carttotal(price);</span><span id="32c1" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//show it<br>  showClass(document.querySelector(".cd-cart-container"));</span><span id="c25c" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//add item to cart<br>  var productlist = document.getElementById("cartlistitems");<br>  var itemlist = document.createElement("li");<br>  itemlist.className = "product ";</span><span id="23bc" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//build produt<br>  var prodcuthtml = "";<br>  //product image<br>  var prodcuthtml =<br>    prodcuthtml +<br>    '&lt;div class="product-image"&gt;&lt;a href="#0"&gt;&lt;img src="img/product-preview.png" alt="placeholder"&gt;&lt;/a&gt;&lt;/div&gt;';<br>  //product name<br>  prodcuthtml =<br>    prodcuthtml + '&lt;div class=""&gt;&lt;h3&gt;&lt;a href="#0"&gt;' + name + "&lt;/a&gt;&lt;/h3&gt;";<br>  //product price<br>  prodcuthtml = prodcuthtml + '&lt;span class="price"&gt;' + price + " BTC&lt;/span&gt;";<br>  //actions div<br>  prodcuthtml = prodcuthtml + '&lt;div class="actions"&gt;';</span><span id="c4de" class="mf kv bf av mr b dz ng nh ni nj nk mt l mu" data-selectable-paragraph="">//delete option<br>  prodcuthtml =<br>    prodcuthtml +<br>    '&lt;a href="javascript:SR.deleteitem()" class="delete-item"&gt;Delete&lt;/a&gt;';<br>  prodcuthtml = prodcuthtml + '&lt;div class="quantity"&gt;';<br>  //quantity label<br>  prodcuthtml =<br>    prodcuthtml + '&lt;label for="cd-product-' + productid + '"&gt;Qty&lt;/label&gt;';<br>  //quantity select<br>  prodcuthtml =<br>    prodcuthtml +<br>    '&lt;span class="select"&gt;&lt;select id="productquantity" name="productquantity" onchange="SR.changequantity()"&gt;';<br>  var i = 0;<br>  for (i = 1; i &lt; quantity; i++) {<br>    if (i == itemcount)<br>      prodcuthtml =<br>        prodcuthtml + '&lt;option value="' + i + '" selected&gt;' + i + "&lt;/option&gt;";<br>    else<br>      prodcuthtml =<br>        prodcuthtml + '&lt;option value="' + i + '"&gt;' + i + "&lt;/option&gt;";<br>  }<br>  prodcuthtml = prodcuthtml + "&lt;/select&gt;&lt;/span&gt;";<br>  //end of quantiy div<br>  var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>  //end of actions div<br>  var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>  //end of products details div<br>  var prodcuthtml = prodcuthtml + "&lt;/div&gt;";<br>  //end of product div<br>  //add to the list<br>  itemlist.innerHTML = prodcuthtml;<br>  // append  to the end of theParent<br>  productlist.innerHTML = "";<br>  productlist.appendChild(itemlist);</span></pre><p id="198c" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">carttotal</strong></p><p id="fba7" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The cart total function gets the price of the product and times it by the itemcount (quantity), converts into a BTC friendly format and updates the checkout total.</p><p id="ca3f" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Finally, it call’s “<strong class="lj lz">storeproduct</strong>” endpoint on the server via the “<strong class="lj lz">fetchurl”</strong>function</p><pre class="ke kf kg kh ki dv ge df"><span id="6b5b" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//this functions updates the totals for the cart<br>function carttotal() {<br>  //multipily the price by the number of items in the cart<br>  var producttotal = price * itemcount;<br>  //set it to 8 decimal places as it's Bitcoin<br>  producttotal = parseFloat(producttotal).toFixed(8);<br>  changeClassText(document.getElementById("checkouttotal"), producttotal);<br>  //update counter<br>  changeClassText(document.querySelector(".cd-count"), itemcount);<br>  //store product<br>  var url =<br>    serverurl +<br>    "api/storeproduct?name=" +<br>    name +<br>    "&amp;quantity=" +<br>    itemcount +<br>    "&amp;address=" +<br>    address +<br>    "&amp;price=" +<br>    price;<br>  //call the store produt endpoint<br>  fetchurl(url, "storeproduct");<br>}</span></pre><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_ukrYWhpsLPw5PoJmv43rBA.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_ukrYWhpsLPw5PoJmv43rBA-2xl.png 1600w" alt="" width="162" height="167" layout="responsive"></amp-img></figure><p id="3b6b" data-selectable-paragraph="">Now, if we go ahead and click the cart icon (shown below) it will open the cart and display the correct details</p><p id="ab6e" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The above is controlled by the “<strong class="lj lz">cd-cart-trigger</strong>” listener which simply shows the cart container and calls the “<strong class="lj lz">cartstate</strong>” function</p><pre class="ke kf kg kh ki dv ge df"><span id="5c5b" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">document<br>  .querySelector(".cd-cart-trigger")<br>  .addEventListener("click", function() {<br>    //check if cart shoud be shown<br>    //debug<br>    //itemcount = 1;<br>    if (itemcount == 0) {<br>      //always remove as its 0<br>      removeClass(document.querySelector(".cd-cart-container"), "cart-open");<br>    } else {<br>      //see if the cart is open and toggle it<br>      var res = hasClass(<br>        document.querySelector(".cd-cart-container"),<br>        "cart-open"<br>      );<br>      if (res == 1) {<br>        //close it<br>        removeClass(document.querySelector(".cd-cart-container"), "cart-open");<br>      } else {<br>        cartstate(1);<br>      }<br>    }<br>  });</span></pre><p id="5880" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph=""><strong class="lj lz">cartstate</strong></p><p id="5fd3" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">The cartstate function simply loads the correct UX for the cart. It has 3 states it can be in (ignoring hidden)</p><h2 id="beb6" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">product view</h2><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_d3KOm09LFsUazdibty6ayQ.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_d3KOm09LFsUazdibty6ayQ-2xl.png 1600w" alt="" width="927" height="828" layout="responsive"></amp-img></figure><h2 id="a0fe" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">customer details view (click checkout)</h2><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_XoKCGcsb-Qy45AOqGSASdQ.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_XoKCGcsb-Qy45AOqGSASdQ-2xl.png 1600w" alt="" width="896" height="825" layout="responsive"></amp-img></figure><h2 id="b5a2" class="mf kv bf av au el mg mh mi mj mk ml mm mn mo mp mq" data-selectable-paragraph="">pay view</h2><figure class="post__image"><amp-img src="https://cryptoskillz.com/blog/media/posts/9/1_BKxP1DTR8Qti-sAFKNDL0g.png" sizes="(max-width: 48em) 100vw, 768px" srcset="https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-xs.png 300w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-sm.png 480w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-md.png 768w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-lg.png 1024w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-xl.png 1360w ,https://cryptoskillz.com/blog/media/posts/9/responsive/1_BKxP1DTR8Qti-sAFKNDL0g-2xl.png 1600w" alt="" width="917" height="845" layout="responsive"></amp-img></figure><pre class="ke kf kg kh ki dv ge df"><span id="015d" class="mf kv bf av mr b dz ms mt l mu" data-selectable-paragraph="">//this function works with how the cart should look and sets the correct viusal elements<br>function cartstate(state) {<br>  /*<br>   1 = show cart product details<br>   2 = show customer details screen<br>   3 = customer detals back<br>   4 = custmer details pay click<br>   5 = bitcoin details back click<br>  */<br>  switch (state) {<br>    case 1:<br>      //hide btc stuff<br>      hideClass(document.getElementById("checkoutbitocoin"));<br>      hideClass(document.getElementById("bitcoinaddresswrapper"));<br>      //hide the customer details<br>      hideClass(document.getElementById("customerdetailswrapper"));<br>      //hide customer detals back<br>      hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>      //open it<br>      addClass(document.querySelector(".cd-cart-container"), "cart-open");<br>      //show the product details<br>      showClass(document.getElementById("cartlistitems"));<br>      break;<br>    case 2:<br>      //hide the product details<br>      hideClass(document.getElementById("cartlistitems"));<br>      //show the customer details<br>      showClass(document.getElementById("customerdetailswrapper"));<br>      showClass(document.getElementById("checkoutcustomerdetailsback"));<br>      //hide btc stuff<br>      hideClass(document.getElementById("bitcoinaddresswrapper"));<br>      break;<br>    case 3:<br>      //show the product details<br>      showClass(document.getElementById("cartlistitems"));<br>      //hide btc stuff<br>      hideClass(document.getElementById("bitcoinaddresswrapper"));<br>      //hide the customer details<br>      hideClass(document.getElementById("customerdetailswrapper"));<br>      hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>      break;<br>    case 4:<br>      //hide the product details<br>      hideClass(document.getElementById("cartlistitems"));<br>      //show btc stuff<br>      showClass(document.getElementById("bitcoinaddresswrapper"));<br>      showClass(document.getElementById("checkoutbitocoin"));<br>      //hide the customer details<br>      hideClass(document.getElementById("checkoutcustomerdetailsback"));<br>      hideClass(document.getElementById("customerdetailswrapper"));<br>      break;<br>    case 5:<br>      //hide the product details<br>      hideClass(document.getElementById("cartlistitems"));<br>      //show the customer details<br>      showClass(document.getElementById("checkoutcustomerdetailsback"));<br>      showClass(document.getElementById("customerdetailswrapper"));<br>      //show btc stuff<br>      hideClass(document.getElementById("bitcoinaddresswrapper"));<br>      hideClass(document.getElementById("checkoutbitocoin"));<br>      break;<br>  }<br>}</span></pre><p id="d585" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">There are various things on each those views such as back, delete and change quantity that does exactly what you think they will and have their own listeners that are clearly documented (in the <a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/refactor1/cdn/js/sr.js" class="cb bx lv lw lx ly" target="_blank" rel="noopener noreferrer">code</a>)</p><p data-selectable-paragraph=""> </p><h1 id="48f7" class="ku kv bf av au el kw kx ky kz la lb lc ld le lf lg" data-selectable-paragraph="">Conclusion</h1><p id="efe5" class="lh li bf av lj b lk ll lm ln lo lp lq lr ls lt lu" data-selectable-paragraph="">So there we go we have a refactored CDN (sr.js) single line of coder injector that will play nicely with any environment you inject it into.</p><p id="57b8" class="lh li bf av lj b lk ma lm mb lo mc lq md ls me lu" data-selectable-paragraph="">Next time we will refactor the server and finally remove the block.io calls and replace them calls our own full now.</p><aside><ul class="post-tag"><li><a href="https://cryptoskillz.com/blog/amp/ecs/">ecs</a></li></ul><div class="post-share"><amp-social-share type="system" width="40" height="40" data-param-text="Part 7: Recode CDN to use plain js"></amp-social-share><amp-social-share type="twitter" width="40" height="40" data-param-text="Part 7: Recode CDN to use plain js" data-param-url="https://cryptoskillz.com/blog/amp/part-7-recode-cdn-to-use-plain-js.html"></amp-social-share></div></aside></div></article><nav class="post-pagination wrap-inner"><div class="post-pagination-prev"><span>Previous</span> <a href="https://cryptoskillz.com/blog/amp/part-6-create-an-admin-and-hosting.html">Part 6: Create an Admin and hosting</a></div><div class="post-pagination-next"><span>Next</span> <a href="https://cryptoskillz.com/blog/amp/part-8-working-with-fullnodes.html">Part 8: Working with Fullnodes</a></div></nav></main><amp-animation id="showAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "1",
                            "visibility": "visible",
                            "transform": "scale(1)"
                        }]
                    }]
                }</script></amp-animation><amp-animation id="hideAnim" layout="nodisplay"><script type="application/json">{
                    "duration": "200ms",
                    "fill": "both",
                    "iterations": "1",
                    "direction": "alternate",
                    "animations": [{
                        "selector": ".post-scroll",
                        "keyframes": [{
                            "opacity": "0",
                            "visibility": "hidden",
                            "transform": "scale(0.1)"
                        }]
                    }]
                }</script></amp-animation><div class="post-scroll-marker"><amp-position-observer on="enter:hideAnim.start; exit:showAnim.start" layout="nodisplay"></amp-position-observer></div><button class="post-scroll" on="tap:top.scrollTo(duration=200)">&#8593;</button><footer class="bottom">Powered by Publii</footer><amp-sidebar id="navbar-sidebar" layout="nodisplay"><ul><li><a href="https://cryptoskillz.com/index.html">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html">ABOUT</a></li><li><a href="https://cryptoskillz.com/blog/ecs/">BLOG</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://cryptoskillz.com/blog/amp/ecs/" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blog/amp/fullnode/" target="_self">FULLNODE</a></li><li><a href="https://cryptoskillz.com/blog/amp/cyphernode/" target="_self">CYPHERNODE</a></li></ul></li></ul></amp-sidebar><amp-analytics type="googleanalytics" id="analytics1"><script type="application/json">{
            "vars": {
                "account": "ca-pub-4710117865976591"
            },
            "triggers": {
                "trackPageview": {
                    "on": "visible",
                    "request": "pageview"
                }
            }
        }</script></amp-analytics><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>