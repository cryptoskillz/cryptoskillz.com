<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Refactor of cold storage - cryptoskillz</title><meta name="description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://cryptoskillz.com/blog/refactor-of-cold-storage.html"><link rel="amphtml" href="https://cryptoskillz.com/blog/amp/refactor-of-cold-storage.html"><link rel="alternate" type="application/atom+xml" href="https://cryptoskillz.com/blog/feed.xml"><link rel="alternate" type="application/json" href="https://cryptoskillz.com/blog/feed.json"><meta property="og:title" content="Refactor of cold storage"><meta property="og:image" content="https://cryptoskillz.com/blog/media/posts/13/1_WONtgVhW3k0iM4sR9DZ1VA.jpeg"><meta property="og:site_name" content="cryptoskillz"><meta property="og:description" content="ECS (e-commerce software) is an open source Bitcoin e-commerce server. It comes with a Javascript e-commerce injector a REST server and an admin control panel. "><meta property="og:url" content="https://cryptoskillz.com/blog/refactor-of-cold-storage.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;subset=latin-ext&amp;display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cryptoskillz.com/blog/assets/css/style.css?v=1083d802e3f46e75f95035fd641fe7af"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://cryptoskillz.com/blog/refactor-of-cold-storage.html"},"headline":"Refactor of cold storage","datePublished":"2018-11-02T12:16","dateModified":"2019-10-10T23:37","image":{"@type":"ImageObject","url":"https://cryptoskillz.com/blog/media/posts/13/1_WONtgVhW3k0iM4sR9DZ1VA.jpeg","height":2669,"width":4000},"description":" This guide aims to program a website to accept Bitcoin. In the last tutorial (\"part 10\"), we deep dived address generation and went to quite a bit of theory this leads us to realise that our cold storage solution was entirely inadequate and hence&hellip;","author":{"@type":"Person","name":"cryptoskillz"},"publisher":{"@type":"Organization","name":"cryptoskillz"}}</script><script async src="https://cryptoskillz.com/blog/assets/js/lazysizes.min.js?v=300b16f1c14e1537e6b064f464ab33b1"></script></head><body><header class="topbar js-top is-sticky"><div class="topbar__inner"><a class="logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav class="navbar js-navbar"><button class="navbar__toggle js-navbar__toggle">Menu</button><ul class="navbar__menu"><li><a href="https://cryptoskillz.com/index.html" target="_self">ECS</a></li><li><a href="https://cryptoskillz.com/blox.html" target="_self">BLOX</a></li><li><a href="https://cryptoskillz.com/about.html" target="_self">ABOUT</a></li></ul></nav></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2019-11-05T17:19">November 5, 2019</time></div><div class="infobar__search"><form action="https://cryptoskillz.com/blog/search.html"><input type="search" name="q" placeholder=" search..."></form></div></div><main class="main"><div class="banner banner--before-post"><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT START</h2><p>Only joking, but not. We want your Bitcoin, any amount will do.  We like Bitcoin and want more of it, so please give it to us.  Click the button below to donate.</p><p><a href="#0" id="sr-add-to-cart" cart-type="2" class="sr-add-to-cart add-to-cart btn btn-primary" data-price="0.01" data-name="Entity T" data-preview="" style="color: #000;">Donate</a> </p><h2 id="mcetoc_1dmt0knbc0">GIVE US YOUR BITCOIN ADVERTISEMENT END</h2></div><article class="post"><figure class="post__featured-image" style="padding-bottom: calc(2669/4000 * 100%)"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-xs.jpeg 300w ,https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-sm.jpeg 480w ,https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-md.jpeg 768w ,https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-lg.jpeg 1024w ,https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-xl.jpeg 1360w ,https://cryptoskillz.com/blog/media/posts/13/responsive/1_WONtgVhW3k0iM4sR9DZ1VA-2xl.jpeg 1600w" data-sizes="auto" alt=""><figcaption>Photo by Jeremy Goldberg on Unsplash</figcaption></figure><header class="u-header post__header"><h1>Refactor of cold storage</h1><div class="u-header__meta u-small"><div><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a> <time datetime="2018-11-02T12:16">November 2, 2018 </time><a href="https://cryptoskillz.com/blog/ecs/" class="u-tag u-tag--1">ecs</a></div></div></header><div class="post__entry u-inner"><p> </p><h1 id="0619" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Introduction</h1><p id="9c84" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This guide aims to program a website to accept Bitcoin. In the last tutorial ("<strong class="lu mg"><a href="https://cryptoskillz.com/blog/address-101.html">part 10</a>"</strong>), we deep dived address generation and went to quite a bit of theory this leads us to realise that our cold storage solution was entirely inadequate and hence why we are replacing it with (hopefully) a more robust solution.</p><p id="056b" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">We will be covering a lot of the concepts explained brilliantly (as always) by Andreas Antonopoulos (if you do not know his work check it out it really is quite brilliant) in the video below. Please watch this before continuing with the tutorial.</p><figure class="ke kf kg kh ki fr"><div class="kq l ds"><div class="mm l"><div class="post__iframe"><iframe class="lazyload" width="854" height="480" data-src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FwWCIQFNf_8g%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DwWCIQFNf_8g&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FwWCIQFNf_8g%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube" frameborder="0" title="Bitcoin Q&amp;A: How do mnemonic seeds work?" class="du n o kn ab" scrolling="auto" data-mce-fragment="1"></iframe></div></div></div></figure><h1 id="9638" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The SQL</h1><p id="de61" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">We removed the cold storage address in the in the usersettings table as the address is going to change each time we call the method sweep from "<strong class="lu mg"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">app.js</a>"</strong> now.</p><pre class="ke kf kg kh ki dv ge df"><span id="9f10" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">CREATE TABLE "usersettings" ( <br>`id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `userid` INTEGER <br>)</span></pre><p id="f9a5" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Lastly, we added a new table to store the addresses that we generate from "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/addressgeneration.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">addressgeneration.js</strong></a><strong class="lu mg">"</strong></p><pre class="ke kf kg kh ki dv ge df"><span id="d291" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">CREATE TABLE "coldstorageaddresses" ( <br>`id` INTEGER PRIMARY KEY AUTOINCREMENT,<br> `userid` INTEGER, `address` TEXT,<br> `used` INTEGER DEFAULT 0 <br>)</span></pre><h1 id="3af5" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">The Code</h1><p id="c035" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This time around we created a brand new file and made a small change to sweep method in "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">app.js</strong></a>" and a new file called "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/addressgeneration.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">addressgeneration.js</strong></a>". The branch for this tutorial can be found "<strong class="lu mg"><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/tree/part11-sweep-refactor" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong></p><h2 id="f11d" class="mn lg bf av au el ms mt mu mv mw mx my mz na nb nc" data-selectable-paragraph="">Design choices</h2><p id="2fca" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">This is a "<strong class="lu mg"><a href="https://en.wikipedia.org/wiki/Command-line_interface" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">command line</a>"</strong> program that generates an unlimited amount of Segwit address from a "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">mnemonic passphrase</a>"</strong>. It has been designed to run offline and then you manually copy the address to the database.</p><p id="4639" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This is very much intentional as your "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">mnemonic passphrase</a>"</strong> is basically root access to your wallet and as a result should never ever be online. For more information on this check out the concept of Air Gapping "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/How_to_set_up_a_secure_offline_savings_wallet" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong><strong class="lu mg">.</strong></p><h2 id="a864" class="mn lg bf av au el ms mt mu mv mw mx my mz na nb nc" data-selectable-paragraph="">Generate a mnemonic passphrase</h2><p id="0d5c" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">When it comes to generating "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">passphrases</a>"</strong> there are a number of ways it can be done. Ideally, you should use a hardware wallet such as "<strong class="lu mg"><a href="https://www.ledger.com/products/ledger-nano-s?r=d90edb4fab8c&amp;tracker=MY_TRACKER" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">ledger</a>"</strong><strong class="lu mg"> </strong>(schilled affiliate link). However, for the purposes of this demo, we have used an "<strong class="lu mg"><a href="https://iancoleman.io/bip39/#english" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">online</a>"</strong> generator.</p><p id="c226" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Note, in a production environment never ever use an online service to generate your passphrases as you do not know who is on the other side of the website or how they are generating the passphrases.</p><h2 id="5914" class="mn lg bf av au el ms mt mu mv mw mx my mz na nb nc" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/addressgeneration.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">addressgeneration.js</a></h2><pre class="ke kf kg kh ki dv ge df"><span id="9d2d" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">//load commander<br>const program = require("commander");<br>const bitcoin = require("bitcoinjs-lib");<br>const bip39 = require("bip39");<br>const bip32 = require("bip32");<br>//set up block.io<br>var BlockIo = require("block_io");<br>var version = 2; // API version<br>var block_io = new BlockIo(<br>  process.env.blockiokey,<br>  process.env.blockiosecret,<br>  version<br>);<br>const network = bitcoin.networks.testnet;<br>program.version("0.0.1").description("Generate Address");<br>//get the balance of the account.<br>program<br>  .command("generate &lt;mnemonic&gt; &lt;number&gt;")<br>  .alias("a")<br>  .description("generate addresses")<br>  .action((mnemonic, number) =&gt; {<br>    //validate the menmonic<br>    var res = bip39.validateMnemonic(mnemonic);</span><span id="29a2" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">if (res != false) {<br>      //generate a seed<br>      const seed = bip39.mnemonicToSeed(mnemonic);</span><span id="c740" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">//set root<br>      var root = bip32.fromSeed(seed);<br>      //debug</span><span id="a007" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">//recursive generate address function<br>      function generateAddress(root, addressIndex) {<br>        //console.log(root);<br>        //user derive path to get a child<br>        //research<br>        child = root.derivePath("m/0/" + addressIndex);<br>        //generate a segwit address<br>        var address = bitcoin.payments.p2sh({<br>          redeem: bitcoin.payments.p2wpkh({ pubkey: child.publicKey, network }),<br>          network<br>        }).address;<br>        block_io.get_transactions(<br>          { type: "received", address: address },<br>          function(error, data) {<br>            //move on the index<br>            addressIndex++;<br>            //check for transaxtions<br>            if (data.data.txs.length == 0) {<br>              //output the address as it has never been used<br>              console.log(address);<br>              //check if we are under the number of requested addresses and call the function again if this is the case.<br>              if (addressIndex &lt;= number) generateAddress(root, addressIndex);<br>            } else {<br>              //call the function to get  new address as this one had some transactions.<br>              generateAddress(root, addressIndex);<br>            }<br>          }<br>        );<br>      }<br>      console.log(<br>        "Generating " + number + " of addresses starting from index 0"<br>      );<br>      //call the generate address function<br>      generateAddress(root, 0);<br>    }<br>  });<br>program.parse(process.argv);</span></pre><p id="f33a" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Let’s go ahead and bread that down a little shall we?</p><p id="a7da" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The first thing you will see that we have included a new package called "<strong class="lu mg"><a href="https://www.npmjs.com/package/commander" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">commander</a>"</strong><strong class="lu mg"> </strong>this basically us to run the js code as a command line program</p><pre class="ke kf kg kh ki dv ge df"><span id="649c" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">const program = require("commander");</span></pre><p id="5e56" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we are bringing back "<strong class="lu mg"><a href="https://github.com/bitcoinjs/bitcoinjs-lib" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">bitcoinjs-lib</a>"</strong><strong class="lu mg"> </strong>and a couple of its extension packages "<strong class="lu mg"><a href="https://github.com/bitcoinjs/bip39" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">bip39</a>"</strong> and "<strong class="lu mg"><a href="https://github.com/bitcoinjs/bip32" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">bip32</a>"</strong><strong class="lu mg"> </strong>respectively<strong class="lu mg">.</strong></p><pre class="ke kf kg kh ki dv ge df"><span id="2595" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">const bitcoin = require("bitcoinjs-lib");<br>const bip39 = require("bip39");<br>const bip32 = require("bip32");<br></span></pre><p id="0ec5" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we are bringing back "<strong class="lu mg"><a href="https://block.io/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">block_io</a>"</strong> so we can query an address to see if it has been used before. There are a number of ways we can tell if an address has been used before (technically there is no "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/From_address" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">form addresses</a>"</strong> only "<strong class="lu mg"><a href="https://en.wikipedia.org/wiki/Unspent_transaction_output" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">unspent transactions</a>"</strong> but to make it easier to follow we will stick with this "<strong class="lu mg"><a href="https://en.wikipedia.org/wiki/Factoid" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">factoid</a>"</strong>) the one we have chosen is to see if it has a balance.</p><p id="ca3e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This is not a 100% necessary but the cleaner we keep things the better. It is worth noting that the way "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Main_Page" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Bitcoin</a>"</strong>, "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Block" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">blocks</a>"</strong> and "<strong class="lu mg"><a href="https://bitcoin.org/en/full-node" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">fullnodes</a>"</strong> work it is impossible to get a balance for any address using "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/API_reference_(JSON-RPC)" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">RPC</a>"</strong><strong class="lu mg"> </strong>that you do not own, this is why we are using "<strong class="lu mg"><a href="https://block.io/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">block.io</a>"</strong>.</p><p id="25a5" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">I am not 100% sure as I have not seen their code but I am assuming that "<strong class="lu mg"><a href="https://block.io/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> have created a database of all "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Transaction" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">Bitcoin transaction</a>"</strong><strong class="lu mg"> </strong>and indexed them to be able to provide a way to query them via their "<strong class="lu mg"><a href="https://block.io/docs/basic" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">API</a>"</strong>. There are some "<strong class="lu mg"><a href="https://bitcoin.org/en/full-node" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">fullnodes</a>"</strong> that offer this kind of functionality and we may look at them in the future.</p><p id="4d59" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Note, in a future version we will work on a way to remove this dependency by either using one the aforementioned notes with the indexes, indexing ourselves or just allowing a start paramater for where to start <strong class="lu mg">addressIndex</strong>so it can be run fully offline.</p><pre class="ke kf kg kh ki dv ge df"><span id="1021" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">var BlockIo = require("block_io");<br>var version = 2; // API version<br>var block_io = new BlockIo(<br>  process.env.blockiokey,<br>  process.env.blockiosecret,<br>  version<br>);</span></pre><p id="a119" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we set the network to testnet (as usual)</p><pre class="ke kf kg kh ki dv ge df"><span id="e7dd" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">const network = bitcoin.networks.testnet;</span></pre><p id="1de3" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we create the command that we can run from the CLI using "<strong class="lu mg"><a href="https://www.npmjs.com/package/commander" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">commander</a>"</strong>. As you can see we have created a command called "<strong class="lu mg">generate</strong>" which takes 2 parameters "<strong class="lu mg">mnemonic</strong>" and "<strong class="lu mg">number</strong>".</p><pre class="ke kf kg kh ki dv ge df"><span id="80ff" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">program<br>  .command("generate &lt;mnemonic&gt; &lt;number&gt;")<br>  .alias("a")<br>  .description("generate addresses")<br>  .action((mnemonic, number) =&gt; {</span><span id="7e05" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">});</span></pre><p id="82a0" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we check that the "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">mnemonic</a>"</strong> that we have passed in is valid. At this point we can trust that this function works, if however, you want to know how to validate it yourself you can read more about it "<strong><a href="https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">here</a>"</strong>.</p><pre class="ke kf kg kh ki dv ge df"><span id="28e4" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">var res = bip39.validateMnemonic(mnemonic);</span><span id="b6b2" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">if (res != false) {</span><span id="d853" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">}</span></pre><p id="72cf" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we get the seed from the "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">mnemonic</a>"</strong></p><pre class="ke kf kg kh ki dv ge df"><span id="bb74" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">const seed = bip39.mnemonicToSeed(mnemonic);</span></pre><p id="1e19" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we get the root from the seed. This root is very interesting it is basically the first private/public key pair that can generate infinitely child key pairs, amazing huh? This is really complex stuff beyond the scope of this tutorial but you can read more about it <a href="https://bitcoin.stackexchange.com/questions/62533/key-derivation-in-hd-wallets-using-the-extended-private-key-vs-hardened-derivati" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">here</strong></a><strong class="lu mg"> </strong>and if you prefer a video explanation I have handily added one below.</p><figure class="ke kf kg kh ki fr"><div class="kq l ds"><div class="mm l"><div class="post__iframe"><iframe class="lazyload" width="854" height="480" data-src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2F2HrMlVr1QX8%3Ffeature%3Doembed&amp;url=http%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D2HrMlVr1QX8&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2F2HrMlVr1QX8%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube" frameborder="0" title="Blockchain tutorial 29: Hierarchical Deterministic wallet - BIP32 and BIP44" class="du n o kn ab" scrolling="auto" data-mce-fragment="1"></iframe></div></div></div></figure><pre class="ke kf kg kh ki dv ge df"><span id="a221" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">var root = bip32.fromSeed(seed);</span></pre><p id="5500" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we call the <strong class="lu mg">generateAddress</strong> function pass in the <strong class="lu mg">root</strong> and set the <strong class="lu mg">addressIndex</strong> to 0. As you will see this is a "<strong class="lu mg"><a href="https://en.wikipedia.org/wiki/Recursive_function" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">recursive function</a>"</strong> we keep calling until we have generated the desired number of addresses.</p><pre class="ke kf kg kh ki dv ge df"><span id="c0df" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">generateAddress(root, 0);</span></pre><p id="a02c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Now, let us take a look at what is happening inside <strong class="lu mg">generateAddress</strong>function, The first thing we do is get an address using the <strong class="lu mg">AddressIndex</strong>(starting at 0 as we real coders)<strong class="lu mg"> </strong>we passed in and store in a variable we have called <strong class="lu mg">child</strong>. As you can see we use the function called <strong class="lu mg">DerivePath</strong> to return the object at a set point in the tree.</p><pre class="ke kf kg kh ki dv ge df"><span id="9321" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">child = root.derivePath("m/0/" + addressIndex);</span></pre><p id="1651" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next, we want to use the child public key to generate a <strong class="lu mg">Segwit</strong> address. This function is a little clunky (took me 5 minutes or so to work out the actual structure of it) with having to pass the network twice and I 00% sure this is because of the way <strong class="lu mg">Segwit</strong> was bolted onto the <strong class="lu mg">p2sh</strong> function and will be refactored in time, but for now this is what we have.</p><pre class="ke kf kg kh ki dv ge df"><span id="83e2" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">var address = bitcoin.payments.p2sh({<br>  redeem: bitcoin.payments.p2wpkh({ pubkey: child.publicKey, network }),<br>  network<br>}).address;</span></pre><p id="f50f" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Lastly, we call "<strong class="lu mg"><a href="https://block.io/" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">block.io</a>"</strong> and check the balance of this address if is 0 we assume it has never been used and then increment our <strong class="lu mg">addressIndex</strong>counter, check it is still under the number of addresses we want and if it is we call the function again with the new(incremented) <strong class="lu mg">addressIndex</strong> value.</p><pre class="ke kf kg kh ki dv ge df"><span id="3998" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">block_io.get_transactions({ type: "received", address: address }, function(<br>  error,<br>  data<br>) {<br>  //move on the index<br>  addressIndex++;<br>  //check for transaxtions<br>  if (data.data.txs.length == 0) {<br>    //output the address as it has never been used<br>    console.log(address);<br>    //check if we are under the number of requested addresses and call the function again if this is the case.<br>    if (addressIndex &lt;= number) generateAddress(root, addressIndex);<br>  } else {<br>    //call the function to get  new address as this one had some transactions.<br>    generateAddress(root, addressIndex);<br>  }<br>});</span></pre><h2 id="feca" class="mn lg bf av au el ms mt mu mv mw mx my mz na nb nc" data-selectable-paragraph=""><a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">app.js</a></h2><p id="a804" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">There has been a lot to take in in this tutorial and I do not want to deviate away from the core topic (too much) but there was a small change made to the "<a href="https://github.com/cryptoskillz/Bitcoin-Tutorial/blob/part11-sweep-refactor/server/app.js" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer"><strong class="lu mg">app.js</strong></a><strong class="lu mg">"</strong> sweep function to take account the new way we are using cold storage addresses which I will cover briefly.</p><p id="0d1e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The first thing we did was wrap the whole function in a SQL callback that basically gets the first available address from the <strong class="lu mg">coldstorageaddresses</strong>table</p><pre class="ke kf kg kh ki dv ge df"><span id="85c7" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">let sqldata = [0];<br>  let sql = `select * from coldstorageaddresses where used = ?`;</span><span id="fffd" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">//get a cold storage address<br>  db.get(sql, sqldata, (err, result) =&gt; {<br>    if (err) {<br>      return console.error(err.message);<br>    }<br>    //save the address<br>    var coldstorageaddress = result.address;</span><span id="5049" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">});</span></pre><p id="5d7c" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">The last things we do is change the send to address to the <strong class="lu mg">coldstorageaddress</strong> (a bug from last time) and update the <strong class="lu mg">coldstorageaddresses </strong>table<strong class="lu mg"> </strong>so that we do not use this address again but still have a record of it.</p><pre class="ke kf kg kh ki dv ge df"><span id="31ae" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">let sqldata = [0, coldstorageaddress];<br>let sql = `UPDATE coldstorageaddresses<br>                 SET used = ?<br>                 WHERE coldstorageaddress = ?`;</span><span id="8a35" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">//run sql<br>db.run(sql, sqldata, function(err) {<br>  if (err) {<br>  }<br>  //lock wallet<br>  client.walletLock();<br>  //return status<br>  res.send(JSON.stringify({ status: "swept" }));<br>  return;<br>});</span></pre><p id="b8f5" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">As an aside, we will have to update the admin section to take account of the way we are now dealing with cord storage addresses but we can do that next time.</p><h1 id="3421" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph=""><strong class="ch">Usage</strong></h1><p id="a82f" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Ok, let us run it, shall we?</p><p id="c615" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Open a terminal window and go to the directory where your server code is and type the following:</p><pre class="ke kf kg kh ki dv ge df"><span id="f1d5" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">node addressgeneration.js generate "cry onion author disease page relax hundred couple rule sugar jungle response pyramid change depart" 10</span></pre><p id="20d0" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">This runs the function <strong class="lu mg">generate</strong> and passes in the "<strong class="lu mg"><a href="https://en.bitcoin.it/wiki/Seed_phrase" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">mnemonic phrase</a>"</strong> and asks the program to return 10 addresses. Once it has finished running you will see output something like what is shown below</p><pre class="ke kf kg kh ki dv ge df"><span id="f8e7" class="mn lg bf av mo b dz mp mq l mr" data-selectable-paragraph="">Generating 10 of addresses starting from index 0</span><span id="656c" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2MtnQHFo21SzxVwF7prA5AHzFCAsZtdQTzL</span><span id="8840" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2MzryYWnYiQorfPTtEo597zNRSRZ4Us4sZx</span><span id="1da2" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2Mv2xWEfkBtkmiptuXSvxXtpp4fdT6edqgq</span><span id="ff41" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2MvddHEoAQt8Nt24Lb6KvbPiReMh319etPb</span><span id="9744" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2N7xFakZ8CbZ2pyLQ3sP8rfnCaKen2z4vrf</span><span id="f5d8" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2N6S4ynAZ3f3Tn7VRGcLogtRwQZM7k9qBpP</span><span id="f7f1" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2N3GgQLX7kQuHy61wfKSEsfeyXUU8nJ2sz3</span><span id="7847" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2MxTUSkEpD1HgwEbVe9wzRQja5nqWNDGZrm</span><span id="a8ec" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2N4LtcDPecupp3eEDwCdASpkQ77fpzAMuum</span><span id="8103" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2MxGWc3DdQnhc962pwnQ7EfXJDkADiFT6Xy</span><span id="5b5f" class="mn lg bf av mo b dz nd ne nf ng nh mq l mr" data-selectable-paragraph="">2N6eQvu2wi7k88RRc5G4J9U7EGdixdtnYfC</span></pre><p id="df21" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Simply take these address and put them in the into the <strong class="lu mg">coldstorageaddresses</strong> table.</p><h1 id="48c0" class="lf lg bf av au el lh li lj lk ll lm ln lo lp lq lr" data-selectable-paragraph="">Conclusion</h1><p id="98bb" class="ls lt bf av lu b lv lw lx ly lz ma mb mc md me mf" data-selectable-paragraph="">Phew, that was a lot of theory but I think we have a neat little script and an elegant way to generate reusable cold storage addresses in a safe (depending on your "<strong class="lu mg"><a href="https://en.wikipedia.org/wiki/Operations_security" class="cb bx lb lc ld le" target="_blank" rel="noopener noreferrer">opsec</a>"</strong> of course)</p><p id="e91e" class="ls lt bf av lu b lv mh lx mi lz mj mb mk md ml mf" data-selectable-paragraph="">Next time we are going to add a few back-office such as sending email confirmations of sales etc.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on October 10, 2019</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio u-author box"><div><h4 class="u-author__name"><a href="https://cryptoskillz.com/blog/authors/cryptoskillz/" title="cryptoskillz">cryptoskillz</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://cryptoskillz.com/blog/address-101.html" class="post__nav__link" rel="prev"><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/12/responsive/1_6p3MzX8zoEMi_Rjg53Wupg-xs.jpeg" data-expand="300" alt=""><div class="u-small">Previous Post<h5>Part 10: Address 101</h5></div></a></div><div class="post__nav__next"><a href="https://cryptoskillz.com/blog/backoffice-and-server-refactor.html" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Backoffice and server refactor</h5></div><img class="lazyload" src="https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xs.jpeg" data-srcset="https://cryptoskillz.com/blog/media/posts/14/responsive/1_sO7jBrNOVBwbvvfbdkvetg-xs.jpeg" data-expand="300" alt=""></a></div></nav></footer></article><div class="banner banner--after-post"><script type="text/javascript" src="https://cryptoskillz.com/srcrypto/prod/cdn/js/sr.js"></script><script type="text/javascript">SR.init(["https://ecslive.cryptoskillz.com/",15,"https://cryptoskillz.com/srcrypto/prod/cdn/theme/","39",1,"GB",0,""]);</script></div></main><div class="sidebar"><section class="box"><h3 class="box__title">Tags</h3><ul class="tags"><li><a href="https://cryptoskillz.com/blog/cyphernode/">cyphernode</a> <span class="u-small">(4)</span></li><li><a href="https://cryptoskillz.com/blog/ecs/">ecs</a> <span class="u-small">(25)</span></li><li><a href="https://cryptoskillz.com/blog/fullnode/">fullnode</a> <span class="u-small">(8)</span></li><li><a href="https://cryptoskillz.com/blog/trx/">trx</a> <span class="u-small">(2)</span></li><li><a href="https://cryptoskillz.com/blog/wink/">wink</a> <span class="u-small">(2)</span></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://cryptoskillz.com/blog/">cryptoskillz</a><nav><ul class="footer__nav"></ul></nav><div class="footer__copyright">Powered by Publii</div></footer></div><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/jquery-3.2.1.slim.min.js?v=5f48fc77cac90c4778fa24ec9c57f37d"></script><script defer="defer" src="https://cryptoskillz.com/blog/assets/js/scripts.min.js?v=07b53ae91f8045eab042a695e4a26034"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111636971-1"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-111636971-1');</script></body></html>